<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>onlyun</title>
    <!-- 引入 Dexie.js (用于 IndexedDB)、官方导入导出插件和图片压缩库 -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <script src="https://unpkg.com/dexie-export-import@1.0.3/dist/dexie-export-import.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
            --qq-blue: #0099FF;
            --ios-light-gray: #E5E5EA;
            --ios-system-gray: #F2F2F7;
            --ios-header-bg: #F7F7F8;
            --ios-border-color: #D1D1D6;
            --ios-red: #FF3B30;
            --wechat-green: #07C160;
            --user-bubble-green: #95EC6A;
            --red-packet-color: #fa9d3b;
            --red-packet-dark-color: #e0811b;
            --wechat-transfer-orange: #F9A825;
            --text-dark: #000000;
            --text-light: #FFFFFF;
            --text-placeholder: #8A8A8E;
            --header-height: 50px;
            --input-area-height: 55px;
            --status-bar-height: 44px;
            --home-bar-height: 34px;
            --tab-bar-height: 50px;
            --pinned-bg-color: #F3F3F3;
            --actions-panel-height: 220px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", "Source Han Sans SC", "Noto Sans CJK SC", "WenQuanYi Micro Hei", sans-serif;
            background-color: #EFEFEF;
            overflow: hidden;
            padding: 0;
        }

        .phone-frame {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #FFF;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 0;
            border: none;
            box-shadow: none;
        }
        #home-screen, .app-container {
            border-radius: 0;
        }

        body.frame-enabled {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        body.frame-enabled .phone-frame {
            max-width: 430px;
            max-height: 932px;
            border: 10px solid #111;
            border-radius: 50px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.2);
        }
        body.frame-enabled #home-screen,
        body.frame-enabled .app-container {
            border-radius: 40px;
            overflow: hidden;
        }
        
        #home-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FFFFFF;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: calc(var(--status-bar-height) + 20px) 20px calc(var(--home-bar-height) + 20px);
            transition: opacity 0.4s ease-in-out;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        
        .home-widget-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-dark);
            margin-bottom: 20px;
            flex-shrink: 0; 
        }
        .widget-time {
            font-size: 58px;
            font-weight: 500;
            letter-spacing: 1px;
        }
        .widget-date {
            font-size: 16px;
            font-weight: 500;
            margin-top: 4px;
        }

        .home-content-grid {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            width: 100%;
            margin: 40px auto 0;
            padding: 0 10px 20px;
            pointer-events: auto;
        }
        .home-content-grid > div {
            width: 100%;
            display: flex;
            justify-content: center;
        }


        .app-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .app-grid:last-child {
            margin-bottom: 0;
        }

        .widget-area {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        #custom-image-text-widget {
            width: 100%;
            max-width: 300px;
            height: 75px;
            margin: 0 auto;
            background-color: #FFFFFF;
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .app-icon {
            width: 60px;
            height: 60px;
            background-color: #fff;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: opacity 0.2s;
            background-size: cover;
            background-position: center;
        }
        
        .app-icon.custom-icon {
            font-size: 0; 
            color: transparent;
        }

        #reopen-app-icon { background-image: url('https://pic1.imgdb.cn/item/68de6652c5157e1a885033a0.jpg'); }
        #theme-icon { background-image: url('https://pic1.imgdb.cn/item/68de6733c5157e1a8850359f.jpg'); }
        #api-settings-icon { background-image: url('https://pic1.imgdb.cn/item/68de6748c5157e1a885035cd.jpg'); }
        #forum-app-icon { background-image: url('https://pic1.imgdb.cn/item/68de6756c5157e1a885035e3.jpg'); }
        #worldbook-app-icon { background-image: url('https://pic1.imgdb.cn/item/68de6762c5157e1a885035f7.jpg'); }
        #icity-app-icon { background-image: url('https://pic1.imgdb.cn/item/68de6770c5157e1a88503613.jpg'); }
        #dev2-app-icon { background-image: url('https://pic1.imgdb.cn/item/68de677fc5157e1a8850362c.jpg'); }

        .app-icon::after {
            content: attr(data-app-name);
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            color: var(--text-dark);
        }
        
        #reopen-app-icon::after { content: '微信'; }
        #api-settings-icon::after { content: '设置'; }
        #theme-icon::after { content: '主题'; }
        #forum-app-icon::after { content: '论坛'; }
        #worldbook-app-icon::after { content: '世界书'; }
        #icity-app-icon::after { content: 'icity'; }
        #dev2-app-icon::after { content: '待开发'; }

        .disabled-icon {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .app-grid-bottom .app-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            font-size: 26px;
        }
        .app-grid-bottom .app-icon::after {
            bottom: -17px;
        }

        .widget-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .placeholder-widget {
            background-color: rgba(230, 230, 230, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: none;
        }
        .placeholder-widget.has-image {
            background-color: #fff;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #photo-widget {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }

        .address-widget {
            display: flex;
            align-items: center;
            width: 120px;
            background: transparent;
            border: none;
            padding: 0;
        }
        
        .location-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 4px;
            pointer-events: none;
            flex-shrink: 0;
        }
        .location-icon svg {
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.4));
        }

        .address-widget input, .editable-textarea {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            padding: 0;
            font-size: 14px;
            color: var(--text-dark);
        }
        .address-widget input::placeholder, .editable-textarea::placeholder {
            color: rgba(0, 0, 0, 0.85);
        }
        .editable-textarea {
            resize: none;
            text-align: center;
            font-size: 12px;
            line-height: 1.3;
            height: 100%;
            padding: 5px;
        }

        .text-image-widget {
            width: 120px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }
        .text-image-widget.image-right {
            flex-direction: row-reverse;
        }

        .circular-image-upload {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            background-color: rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
        }

        .widget-left-column {
            flex-shrink: 0;
        }
        #widget-circular-upload {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            z-index: 2; 
        }
        .widget-right-column {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-left: 12px;
            height: 100%;
        }
        #widget-text-top, #widget-text-bottom {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-dark);
            padding: 2px 0;
            z-index: 2; 
            position: relative;
        }
        #widget-text-top {
            font-size: 16px;
            font-weight: 600;
        }
        #widget-text-bottom {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
        }

        .app-container { 
            width: 100%; height: 100%; display: flex; flex-direction: column; background-color: var(--ios-system-gray); 
            position: relative; overflow: hidden; z-index: 5;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }

        body:not(.app-is-closed) #home-screen {
            opacity: 0;
            pointer-events: none;
        }
        
        body.app-is-closed .app-container {
            transform: scale(0.8);
            opacity: 0;
            pointer-events: none;
        }

        #status-bar-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--status-bar-height);
            padding: 10px 25px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-dark);
            z-index: 250;
            pointer-events: none;
        }

        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .signal-icon {
            display: flex;
            align-items: flex-end;
            gap: 1.5px;
        }
        .signal-bar {
            width: 3px;
            background-color: currentColor;
            border-radius: 1px;
        }
        .signal-bar:nth-child(1) { height: 4px; }
        .signal-bar:nth-child(2) { height: 6px; }
        .signal-bar:nth-child(3) { height: 8px; }
        .signal-bar:nth-child(4) { height: 10px; }

        .battery-icon {
            width: 24px;
            height: 11.5px;
            border: 1.5px solid currentColor;
            border-radius: 3px;
            position: relative;
            margin-left: 2px;
        }
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 4px;
            background-color: currentColor;
            border-top-right-radius: 1px;
            border-bottom-right-radius: 1px;
        }
        #battery-level {
            position: absolute;
            top: 1.5px;
            left: 1.5px;
            bottom: 1.5px;
            background-color: currentColor;
            border-radius: 1.5px;
            width: 80%;
        }

        .dynamic-island { 
            position: absolute; top: 8px; left: 50%; transform: translateX(-50%); 
            width: 125px; height: 36px; background-color: #000; border-radius: 25px; 
            display: flex; align-items: center; justify-content: center; color: white; overflow: hidden; 
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            z-index: 300;
        }
        
        .dynamic-island.expanded { 
            width: 150px; 
            height: 36px; 
            border-radius: 25px;
        }

        .island-content { display: flex; align-items: center; opacity: 0; transform: scale(0.8); transition: opacity 0.3s 0.2s ease, transform 0.3s 0.2s ease; }
        
        body .dynamic-island.expanded .island-content { 
            opacity: 1; 
            transform: scale(1); 
        }

        .island-content span { font-size: 14px; margin-left: 8px; }
        .loading-spinner { width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .content-area { flex-grow: 1; position: relative; overflow: hidden; transition: opacity 0.3s ease, transform 0.3s ease-in-out; }
        .home-indicator-container { height: var(--home-bar-height); width: 100%; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 8px; flex-shrink: 0; }
        .home-indicator { width: 134px; height: 5px; background-color: #333; border-radius: 100px; }

        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; background-color: #FFF; }
        
        #wechat-main-page, #contacts-page, #me-page {
            display: none;
            padding-top: var(--status-bar-height);
        }
        body[data-main-tab="messages"] #wechat-main-page,
        body[data-main-tab="contacts"] #contacts-page,
        body[data-main-tab="me"] #me-page {
            display: flex;
        }

        #edit-contact-page, #chat-page, #chat-settings-page, 
        #my-masks-page, #edit-mask-page, #mask-selection-page,
        #api-config-page, #data-management-page, #favorites-page, 
        #worldbook-page, #worldbook-binding-page, #worldbook-edit-page,
        #wallet-page, #wallet-details-page {
            transform: translateX(100%);
            padding-top: var(--status-bar-height);
            background-color: var(--ios-system-gray);
        }

        body.edit-contact-active #contacts-page,
        body.edit-contact-active #chat-settings-page,
        body.edit-contact-active #wechat-main-page,
        body.chat-view-active[data-main-tab="messages"] #wechat-main-page,
        body.chat-view-active[data-main-tab="contacts"] #contacts-page,
        body.my-masks-active #me-page,
        body.edit-mask-active #my-masks-page,
        body.mask-selection-active #chat-settings-page,
        body.api-config-active #main-settings-modal,
        body.data-management-active #main-settings-modal,
        body.favorites-active #me-page,
        body.wallet-active #me-page,
        body.wallet-details-active #wallet-page,
        body.worldbook-binding-active #chat-settings-page,
        body.worldbook-edit-active #worldbook-page {
            transform: translateX(-30%);
            transition: transform 0.3s ease-in-out;
        }
        body.chat-settings-active #chat-page {
            transform: translateX(0); /* Stays put */
            filter: brightness(0.95);
        }
        
        body:not([data-main-tab]) .wechat-tab-bar {
            display: none;
        }

        body.edit-contact-active #edit-contact-page,
        body.chat-view-active #chat-page,
        body.chat-settings-active #chat-settings-page,
        body.my-masks-active #my-masks-page,
        body.edit-mask-active #edit-mask-page,
        body.mask-selection-active #mask-selection-page,
        body.api-config-active #api-config-page,
        body.data-management-active #data-management-page,
        body.favorites-active #favorites-page,
        body.wallet-active #wallet-page,
        body.wallet-details-active #wallet-details-page,
        body.worldbook-active #worldbook-page,
        body.worldbook-binding-active #worldbook-binding-page,
        body.worldbook-edit-active #worldbook-edit-page {
            transform: translateX(0);
        }

        #wechat-main-page, #contacts-page, #me-page { z-index: 15; }
        #my-masks-page, #favorites-page, #wallet-page { z-index: 16; }
        #chat-page, #worldbook-page, #wallet-details-page { z-index: 17; }
        #chat-settings-page, #edit-mask-page, #worldbook-edit-page { z-index: 18; }
        #mask-selection-page, #edit-contact-page, #worldbook-binding-page { z-index: 19; }
        #api-config-page, #data-management-page { z-index: 201; }
        
        .wechat-tab-bar, #chat-page-footer {
            flex-shrink: 0;
        }
        
        body:not(.chat-view-active) #chat-page-footer {
            display: none;
        }

        #main-settings-modal, #theme-settings-modal {
            background-color: var(--ios-system-gray);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: var(--status-bar-height);
        }
        body.main-settings-active #main-settings-modal,
        body.theme-settings-active #theme-settings-modal {
            transform: translateY(0);
        }

        .header { height: var(--header-height); background-color: var(--ios-header-bg); border-bottom: 1px solid var(--ios-border-color); display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .header-title { font-size: 17px; font-weight: 600; color: var(--text-dark); cursor: pointer; }
        .header-btn { position: absolute; height: 100%; padding: 0 15px; display: flex; align-items: center; font-size: 17px; cursor: pointer; background: none; border: none; color: var(--ios-blue); }
        .header-btn.left { left: 0; }
        .header-btn.right { right: 0; }
        .header-btn-group { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 15px; }
        .header-btn-group .header-btn { position: static; transform: none; padding: 0; }
        .header-btn svg { width: 24px; height: 24px; stroke: var(--text-dark); }
        #exit-wechat-btn svg, #back-to-chat-btn svg, #back-to-list-btn svg, #back-to-main-btn svg, #back-to-me-btn svg, #back-to-chat-settings-btn svg, #back-to-main-settings-btn svg, #back-to-main-settings-from-api-btn svg, #back-to-me-from-favorites-btn svg, #back-to-me-from-wallet-btn svg, #back-to-wallet-btn svg, #back-to-chat-settings-from-edit-svg, #back-from-worldbook-btn svg, #back-to-chat-settings-from-wb-binding-btn svg, #wb-edit-cancel-btn svg { stroke: #333; stroke-width: 2.5; }
        
        #exit-wechat-btn svg { width: 20px; height: 20px; }

        #wechat-main-page { flex-direction: column; background-color: #FFF; }
        .wechat-header {
            height: var(--header-height);
            background-color: #EDEDED;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 0 15px;
            flex-shrink: 0;
        }
        .wechat-header-title { font-size: 20px; font-weight: bold; }
        
        .wechat-header-icons { 
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex; 
            gap: 20px; 
        }
        .wechat-header-icons svg { width: 22px; height: 22px; color: #111; }
        
        .wechat-chat-list { flex-grow: 1; overflow-y: auto; background-color: #FFF; }
        
        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            cursor: pointer;
            position: relative;
        }
        .chat-list-item:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 69px;
            right: 0;
            height: 1px;
            background-color: var(--ios-system-gray);
        }
        .chat-list-item.pinned { background-color: var(--pinned-bg-color); }
        .chat-list-item:hover { background-color: #EFEFEF; }
        .avatar {
            width: 42px; height: 42px; border-radius: 8px; flex-shrink: 0;
            background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: white;
            text-align: center;
            line-height: 42px;
        }
        .chat-list-avatar {
            margin-right: 12px;
        }
        .chat-list-avatar svg { width: 80%; height: 80%; color: #FFF; }

        .chat-list-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        .chat-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }
        .chat-list-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-list-time {
            font-size: 12px;
            color: var(--text-placeholder);
            flex-shrink: 0;
            margin-left: 10px;
        }
        .chat-list-preview {
            font-size: 12px;
            color: var(--text-placeholder);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .wechat-tab-bar {
            height: var(--tab-bar-height);
            background-color: #F7F7F7;
            border-top: 1px solid var(--ios-border-color);
            display: flex;
            align-items: center;
        }
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-size: 10px;
            color: var(--text-dark);
            position: relative;
            cursor: pointer;
        }
        .tab-item.active { color: var(--wechat-green); }
        
        .tab-item svg {
            width: 26px;
            height: 26px;
            stroke-width: 1.5;
            stroke: currentColor;
            fill: none;
        }
        .tab-item.active svg {
            fill: currentColor;
        }
        
        .tab-item .unread-dot { top: -1px; right: calc(50% - 20px); }

        .chat-messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            background-color: #EDEDED; 
            transition: padding-bottom 0.3s ease-in-out;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        body.more-actions-visible #chat-messages {
            padding-bottom: calc(15px + var(--actions-panel-height));
        }
        .chat-messages .loading-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .chat-messages .loading-spinner-container .loading-spinner {
            border-color: rgba(0,0,0,0.1);
            border-top-color: #666;
        }
        
        .message-turn {
            display: flex;
            max-width: 80%;
            margin-bottom: 15px;
            align-items: flex-start;
            flex-direction: row;
        }
        .message-turn.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-turn.assistant {
            align-self: flex-start;
        }
        
        .message-turn-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            max-width: 100%;
        }
        .message-turn.user .message-turn-content-wrapper { align-items: flex-end; }
        .message-turn.assistant .message-turn-content-wrapper { align-items: flex-start; }


        .avatar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            margin-top: 0;
        }
        .chat-messages .avatar {
            width: 40px; height: 40px; border-radius: 5px;
        }
        .chat-messages .avatar.ai-avatar {
             cursor: pointer; transition: transform 0.2s ease, filter 0.2s ease;
        }
        .chat-messages .avatar.ai-avatar:hover {
            transform: scale(1.1);
            filter: brightness(0.9);
        }

        .avatar-time {
            font-size: 11px;
            color: #B2B2B2;
            margin-top: 4px;
            white-space: nowrap;
        }

        .message-bubble {
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 5px;
            user-select: none;
        }

        .message-turn.user .message-turn-content-wrapper { margin-right: 10px; }
        .message-turn.assistant .message-turn-content-wrapper { margin-left: 10px; }

        .message-content { 
            padding: 10px 14px; 
            border-radius: 8px; 
            font-size: 14px;
            line-height: 1.4; 
            word-wrap: break-word; 
            word-break: break-word; 
        }

        .message-turn.user .message-content { background-color: var(--user-bubble-green); color: var(--text-dark); }
        .message-turn.assistant .message-content { background-color: #FFF; color: var(--text-dark); }
        
        .html-message-content {
            width: auto;
            max-width: 280px; 
            height: auto;
            background-color: #FFF;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--ios-border-color);
        }
        .html-message-content iframe {
            width: 100%;
            height: auto;
            border: none;
            display: block;
        }

        .loading-indicator { font-style: italic; color: #888; align-self: flex-start; margin-left: 50px; font-size: 14px; }

        .recalled-message, .system-message, .system-notification {
            color: #B2B2B2;
            font-size: 12px;
            text-align: center;
            width: 100%;
            padding: 10px 0;
            margin-bottom: 15px;
        }
        .system-notification {
            background-color: #DADADA;
            color: #fff;
            font-size: 11px;
            border-radius: 4px;
            padding: 4px 8px;
            display: inline-block;
            align-self: center;
            width: auto;
        }
        .recalled-message span {
            cursor: pointer;
            color: var(--ios-blue);
        }

        .chat-start-prompt {
            text-align: center;
            color: #B2B2B2;
            font-size: 14px;
            padding: 40px 20px;
            width: 100%;
        }

        #chat-page-footer {
            position: relative;
            z-index: 20;
        }

        .chat-input-area { 
            height: var(--input-area-height); 
            background-color: var(--ios-header-bg); 
            border-top: 1px solid var(--ios-border-color); 
            display: flex; 
            align-items: center; 
            padding: 8px 10px; 
            gap: 8px; 
        }
        .chat-input-area textarea { 
            flex-grow: 1; 
            height: 38px; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 20px; 
            background-color: #FFFFFF; 
            font-size: 17px; 
            resize: none; 
        }
        .chat-input-area textarea:focus { 
            outline: none; 
        }
        .chat-input-area textarea:disabled { 
            background-color: #f0f0f0; 
        }

        .chat-input-area .action-btn { 
            height: 36px; 
            border: none; 
            cursor: pointer; 
            flex-shrink: 0; 
            transition: opacity 0.2s;
        }
        .send-btn { 
            display: none;
            padding: 0 16px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            background-color: var(--qq-blue);
            color: var(--text-light);
        }
        
        #generate-btn {
            display: block;
            width: 36px;
            border-radius: 50%;
            background-color: #f0f0f0;
            background-image: url('https://pic1.imgdb.cn/item/68e0c4f0c5157e1a88566531.png');
            background-size: 60%;
            background-position: center;
            background-repeat: no-repeat;
            padding: 0;
        }

        #more-actions-btn, #emoji-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: transparent;
        }
        #more-actions-btn svg, #emoji-btn svg {
            width: 28px;
            height: 28px;
            color: #333;
        }

        .action-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        .send-btn:disabled {
            background-color: #a0c8f0;
        }


        #more-actions-panel {
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            background-color: var(--ios-system-gray);
            border-top: 1px solid var(--ios-border-color);
            padding: 20px 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out, visibility 0.3s;
            z-index: 10;
            visibility: hidden;
        }
        body.more-actions-visible #more-actions-panel {
            transform: translateY(0);
            visibility: visible;
        }
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px 15px;
        }
        .action-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .action-grid-icon {
            width: 60px;
            height: 60px;
            background-color: #FFF;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-grid-icon svg {
            width: 32px;
            height: 32px;
            color: #3C3C43;
        }
        .action-grid-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }
        .action-grid-item[data-action="transfer"] .action-grid-icon img {
            width: 40px;
            height: 40px;
        }
        .action-grid-label {
            font-size: 12px;
            color: #8A8A8E;
        }
        
        .settings-content { padding: 20px 15px; flex-grow: 1; overflow-y: auto; }
        .settings-group { background-color: #FFF; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .form-group { padding-left: 15px; border-bottom: 1px solid var(--ios-border-color); display: flex; align-items: center; }
        .settings-group .form-group:last-child { border-bottom: none; }
        .form-group label { flex-basis: 80px; flex-shrink: 0; font-size: 15px; color: var(--text-dark); }
        .form-group input, .form-group select, .form-group textarea { flex-grow: 1; width: auto; padding: 12px 5px; font-size: 15px; border: none; background-color: transparent; color: var(--text-placeholder); -webkit-appearance: none; appearance: none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; }
        .form-group select { padding-right: 15px; color: var(--text-dark); }
        
        .form-group input.has-content, 
        .form-group textarea.has-content { 
            color: var(--text-dark); 
        }
        
        .form-group textarea { resize: none; height: 120px; padding-top: 10px; padding-bottom: 10px; }

        .save-btn { width: 100%; padding: 12px; font-size: 17px; font-weight: 600; color: var(--text-light); background-color: var(--ios-blue); border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .save-btn:disabled { background-color: #a0c8f0; cursor: not-allowed; }
        .reset-btn { background-color: var(--ios-light-gray); color: var(--ios-red); }

        .preset-management-wrapper { display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; }
        .preset-management-wrapper select { flex-grow: 1; }
        #delete-preset-btn {
            background-color: var(--ios-red);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .api-settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .api-settings-buttons .save-btn {
            margin-top: 0;
            flex-grow: 1;
        }
        #save-preset-btn {
            background-color: #34C759;
        }
        #save-preset-btn:disabled { background-color: #a8e0b6; }

        #fetch-models-btn {
            margin-top: 0;
            margin-bottom: 20px;
        }

        #contacts-list, #masks-list, #mask-selection-list { flex-grow: 1; overflow-y: auto; background-color: #FFF; }
        .contact-item, .mask-item, .mask-selection-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--ios-system-gray); }
        .contact-item:hover, .mask-item:hover, .mask-selection-item:hover { background-color: #F0F0F0; }
        .contact-avatar, .mask-avatar { width: 40px; height: 40px; border-radius: 5px; margin-right: 12px; background-size: cover; background-position: center; }
        .contact-name, .mask-name { font-size: 16px; color: var(--text-dark); }
        #add-mask-btn svg, #add-new-contact-btn svg { width: 22px; height: 22px; stroke: #111; stroke-width: 2; }
        #add-new-contact-btn { padding: 0 15px; }


        #edit-contact-page .settings-content, #edit-mask-page .settings-content, #worldbook-edit-page .settings-content { 
            padding-top: 30px; 
            background-color: transparent; 
        }
        .avatar-uploader { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; cursor: pointer; }
        .avatar-uploader .avatar-preview { 
            width: 80px; height: 80px; border-radius: 8px; background-size: cover; background-position: center; margin-bottom: 8px; 
            display: flex; align-items: center; justify-content: center; 
            color: #AAA; font-size: 12px; text-align: center;
        }
        .avatar-uploader span { font-size: 14px; color: var(--ios-blue); }

        .toast {
            position: absolute; top: 55px; left: 50%; transform: translate(-50%, -150%);
            background-color: rgba(40, 40, 40, 0.85); color: white; padding: 10px 20px;
            border-radius: 20px; z-index: 1000; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            opacity: 0; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            font-size: 14px; font-weight: 500; pointer-events: none;
            max-width: 90%; word-break: break-word; text-align: center;
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }

        .custom-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        .custom-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-modal-box {
            background-color: rgba(240, 240, 240, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 14px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            overflow: hidden;
            transform: scale(1.1);
            transition: transform 0.2s ease-in-out;
        }
        .custom-modal-overlay.visible .custom-modal-box {
            transform: scale(1);
        }
        .custom-modal-content {
            padding: 20px;
        }
        .custom-modal-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .custom-modal-message {
            font-size: 13px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .custom-modal-message h3 { font-size: 15px; text-align: center; }
        .custom-modal-message p { margin-top: 8px; }
        
        .modal-edit-textarea {
            width: 100%;
            height: 150px;
            padding: 8px;
            border: 1px solid var(--ios-border-color);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
        }
        
        .custom-modal-buttons {
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
        }
        .custom-modal-buttons.row-layout {
            flex-direction: row;
        }
        .custom-modal-buttons button {
            padding: 12px 0;
            border: none;
            background: transparent;
            font-size: 17px;
            cursor: pointer;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
        }
        .custom-modal-buttons button:first-child {
            border-top: none;
        }
        .custom-modal-buttons.row-layout button {
             flex: 1;
             border-top: none;
        }
        .custom-modal-buttons.row-layout button:not(:first-child) {
            border-left: 1px solid rgba(0, 0, 0, 0.2);
        }
        .custom-modal-buttons.row-layout button:disabled {
            color: #8e8e93;
            cursor: not-allowed;
        }
        .custom-modal-button.confirm {
            color: var(--ios-blue);
            font-weight: 600;
        }
        .custom-modal-button.destructive {
            color: var(--ios-red);
        }


        #chat-settings-page .settings-content { padding: 20px 0; background-color: transparent; }
        .chat-settings-header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background-color: #FFF;
            margin-bottom: 20px;
        }
        #chat-settings-avatar {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin-right: 15px;
        }
        #chat-settings-name {
            font-size: 20px;
            font-weight: 600;
        }
        .toggle-switch-group, .settings-action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #FFF;
            cursor: pointer;
        }
        .settings-action-item:hover { background-color: #F0F0F0; }
        .settings-action-label { font-size: 16px; }
        .settings-action-value { font-size: 16px; color: var(--text-placeholder); }
        .settings-action-arrow { font-size: 18px; color: var(--text-placeholder); margin-left: 5px; }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 27px; width: 27px;
            left: 2px; bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--wechat-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        #clear-history-btn {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--ios-red);
            font-size: 16px;
            padding: 12px 0;
            cursor: pointer;
            text-align: center;
        }
        .settings-group .form-group.action-button-group {
            padding: 0;
            justify-content: center;
        }

        #delete-contact-btn, #delete-mask-btn {
            width: calc(100% - 30px);
            margin: 20px 15px 0;
            background-color: var(--ios-red);
        }

        #me-page .settings-content, #main-settings-modal .settings-content {
            padding: 0;
            background-color: var(--ios-system-gray);
        }
        .me-profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 20px 20px;
            border-bottom: 8px solid var(--ios-system-gray);
            background-color: #FFF;
        }
        #me-avatar {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: #E0E0E0;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            cursor: pointer;
        }
        #me-name {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-dark);
            text-align: center;
            width: 100%;
        }
        #me-name:empty::before {
            content: '可点击编辑';
            color: var(--text-placeholder);
            font-weight: normal;
        }

        #me-page .settings-group, #main-settings-modal .settings-group {
            margin: 0;
            border-radius: 0;
        }
        .me-settings-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            background-color: #FFF;
            cursor: pointer;
            border-bottom: 1px solid var(--ios-system-gray);
            margin: 0 0;
        }
        .me-settings-item:last-child {
            border-bottom: none;
        }
        .me-settings-item:hover {
            background-color: #F0F0F0;
        }
        .me-settings-icon {
            margin-right: 20px;
        }
        .me-settings-label {
            flex-grow: 1;
            font-size: 16px;
        }
        .me-settings-arrow {
            font-size: 18px;
            color: var(--text-placeholder);
        }
        .settings-group-spacer {
            height: 8px;
            background-color: var(--ios-system-gray);
        }

        #api-config-page .settings-content, #data-management-page .settings-content {
            padding-top: 20px;
            background-color: transparent;
        }
        #export-data-btn {
            background-color: var(--wechat-green);
        }
        #import-data-btn {
            background-color: var(--ios-blue);
        }

        #main-settings-modal .toggle-switch-group {
            padding: 14px 20px;
            cursor: default;
        }
        #main-settings-modal .toggle-switch-label {
            font-size: 16px;
        }

        #theme-settings-modal .settings-group {
            padding: 0 15px;
        }
        .icon-setting-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--ios-system-gray);
        }
        .icon-setting-item:last-child {
            border-bottom: none;
        }
        .icon-preview {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background-color: #E0E0E0;
            margin-right: 15px;
            background-size: cover;
            background-position: center;
        }
        .icon-name-label {
            flex-grow: 1;
            font-size: 16px;
        }
        .change-icon-btn, .reset-icon-btn {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--ios-blue);
            background-color: transparent;
            color: var(--ios-blue);
            cursor: pointer;
            margin-left: 10px;
        }
        .reset-icon-btn {
            border-color: var(--ios-red);
            color: var(--ios-red);
        }

        .context-menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4000;
        }
        .context-menu {
            position: absolute;
            z-index: 4001;
            background-color: #2C2C2E;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.1s ease-out, transform 0.1s ease-out;
            max-width: 250px;
        }
        .context-menu.show {
            opacity: 1;
            transform: scale(1);
        }
        .context-menu-item {
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        .context-menu-item:hover {
            background-color: #555;
            border-radius: 5px;
        }
        .context-menu-item.disabled {
            color: #777;
            cursor: not-allowed;
        }
        .context-menu-item.disabled:hover {
            background-color: transparent;
        }
        .message-bubble.highlighted > * {
            filter: brightness(0.8);
        }

        #favorites-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .favorite-group {
            margin-bottom: 15px;
        }
        .favorite-group-header {
            padding: 4px 15px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-placeholder);
            background-color: var(--ios-system-gray);
        }
        .favorite-item {
            background-color: #FFF;
            padding: 12px 15px;
            border-bottom: 1px solid var(--ios-system-gray);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .favorite-item-main {
            flex-grow: 1;
        }
        .favorite-item-content {
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
        }
        .favorite-item-footer {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-placeholder);
        }
        .delete-fav-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--ios-red);
            cursor: pointer;
            padding: 5px;
            flex-shrink: 0;
        }

        body.multi-select-mode .chat-input-area,
        body.multi-select-mode #reply-preview-bar {
            display: none;
        }
        #multi-select-toolbar {
            height: var(--input-area-height);
            background-color: var(--ios-header-bg);
            border-top: 1px solid var(--ios-border-color);
            display: none;
            align-items: center;
            justify-content: space-around;
            padding: 0 20px;
        }
        body.multi-select-mode #multi-select-toolbar {
            display: flex;
        }
        .multi-select-btn {
            background: none; border: none; cursor: pointer;
        }
        .multi-select-btn svg {
            width: 28px; height: 28px; color: var(--text-dark);
        }
        .multi-select-btn:disabled svg {
            color: #ccc;
        }

        .message-turn.selected .avatar-wrapper::before {
            content: '✓';
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-color: var(--ios-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }
        .message-turn.user.selected .avatar-wrapper::before {
            left: auto;
            right: -35px;
        }

        #forward-contact-picker-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #forward-contact-picker-modal.visible {
            display: flex;
        }
        .forward-picker-box {
            background-color: var(--ios-system-gray);
            width: 80%;
            max-width: 300px;
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 70vh;
        }
        .forward-picker-header {
            padding: 15px;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            background-color: var(--ios-header-bg);
            border-bottom: 1px solid var(--ios-border-color);
        }
        .forward-picker-list {
            overflow-y: auto;
            flex-grow: 1;
        }
        .forward-picker-list .contact-item {
            background-color: #FFF;
        }

        .merged-forward-message {
            background-color: #FFF;
            border: 1px solid var(--ios-border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
        }
        .merged-forward-header {
            font-size: 15px;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--ios-system-gray);
            margin-bottom: 8px;
        }
        .merged-forward-content {
            font-size: 13px;
            color: var(--text-placeholder);
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #reply-preview-bar {
            background-color: var(--ios-system-gray);
            padding: 8px 15px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid var(--ios-border-color);
        }
        .reply-preview-content {
            flex-grow: 1;
            font-size: 13px;
            color: var(--text-placeholder);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        #close-reply-btn {
            background: none; border: none; font-size: 18px; color: #aaa; cursor: pointer;
        }

        .message-reply-preview {
            background-color: rgba(0,0,0,0.05);
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
            color: #666;
            border-left: 2px solid var(--ios-blue);
            cursor: pointer;
        }
        .message-reply-preview strong {
            color: #333;
        }
        .message-reply-preview div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #worldbook-page .settings-content {
            padding: 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #worldbook-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 15px;
            background-color: #FFF;
        }
        .worldbook-folder {
            margin-bottom: 5px;
        }
        .worldbook-folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            background-color: #f7f7f7;
            border-radius: 5px;
            cursor: pointer;
            border-bottom: 1px solid var(--ios-system-gray);
        }
         .worldbook-folder-header:hover {
            background-color: #efefef;
        }
        .worldbook-folder-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .worldbook-folder-name strong {
            font-weight: 600;
        }
        
        .worldbook-item-actions button {
            background: none; border: none; cursor: pointer; padding: 2px 5px;
            font-size: 14px;
            color: var(--ios-red);
        }
        .worldbook-file-list {
            padding-left: 20px;
            transition: max-height 0.3s ease-in-out;
            max-height: 1000px;
            overflow: hidden;
        }
        .worldbook-file-list.collapsed {
            max-height: 0;
        }
        .worldbook-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid var(--ios-system-gray);
            cursor: pointer;
        }
        .worldbook-file:hover {
            background-color: #f8f8f8;
        }
        .worldbook-file-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #worldbook-binding-list {
            padding: 20px 0;
        }
        .worldbook-binding-item {
            background-color: #FFF;
            padding: 12px 15px;
            border-bottom: 1px solid var(--ios-system-gray);
        }
        .worldbook-binding-item label {
            display: flex;
            align-items: center;
            font-size: 16px;
            width: 100%;
        }
        .worldbook-binding-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }
        .worldbook-binding-item.empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-placeholder);
            background: transparent;
            font-size: 15px;
        }
        
        #worldbook-edit-page .form-group textarea {
            height: 200px;
        }
        
        #main-add-menu-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 4500;
            display: none;
        }
        #main-add-menu {
            position: absolute;
            top: calc(var(--status-bar-height) + var(--header-height) - 5px);
            right: 10px;
            background-color: #4C4C4C;
            border-radius: 10px;
            list-style: none;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 4501;
            display: none;
        }
        #main-add-menu-overlay.visible, #main-add-menu.visible {
            display: block;
        }
        #main-add-menu li {
            padding: 10px 15px;
            color: white;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #main-add-menu li:not(:last-child) {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #main-add-menu li:hover {
            background-color: #636366;
            border-radius: 5px;
        }
        #main-add-menu svg {
            width: 20px;
            height: 20px;
            stroke: white;
            stroke-width: 1.5;
        }
        
        .red-packet-bubble, .transfer-bubble {
            border-radius: 8px;
            padding: 0;
            width: 230px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .red-packet-bubble { background-color: var(--red-packet-color); }
        .transfer-bubble { background-color: var(--wechat-transfer-orange); border: none; }

        .red-packet-bubble.opened, .red-packet-bubble.refunded, .red-packet-bubble.empty,
        .transfer-bubble.received,
        .transfer-bubble.refunded { 
            background-color: var(--ios-light-gray); 
            cursor: pointer; 
            border: none;
        }

        .financial-content {
            display: flex;
            align-items: center;
            padding: 15px 15px;
        }
        
        .red-packet-bubble .financial-content svg {
             display: none; 
        }
        .red-packet-bubble .financial-content {
            padding: 15px 15px;
        }

        .financial-text { flex-grow: 1; overflow: hidden; }
        .financial-text p { font-size: 15px; font-weight: 500; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white;}
        
        .transfer-bubble .financial-text {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-direction: column;
            gap: 4px;
        }
        .transfer-bubble .transfer-main-status {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 6px;
        }
        .transfer-bubble .transfer-main-status p { font-size: 15px; font-weight: 500; color: white; }
        .transfer-bubble .transfer-main-status .transfer-remark-inline { 
            font-size: 12px; 
            font-weight: 400; 
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .transfer-bubble .transfer-amount { font-size: 15px; font-weight: 500; display: block; color: white; margin-top: 4px; }

        .red-packet-bubble .financial-text p { color: white; }
        
        .red-packet-bubble.opened .financial-text p, .red-packet-bubble.opened .financial-text span,
        .red-packet-bubble.refunded .financial-text p, .red-packet-bubble.refunded .financial-text span,
        .red-packet-bubble.empty .financial-text p, .red-packet-bubble.empty .financial-text span,
        .transfer-bubble.received .financial-text p, .transfer-bubble.received .transfer-remark-inline, .transfer-bubble.received .transfer-amount,
        .transfer-bubble.refunded .financial-text p, .transfer-bubble.refunded .transfer-remark-inline, .transfer-bubble.refunded .transfer-amount {
             color: var(--text-placeholder);
        }
        
        .financial-footer {
            padding: 4px 10px;
            font-size: 12px;
            width: 100%;
            background-color: rgba(0,0,0,0.1);
        }
        
        #ai-status-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 7000;
            background-color: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
        }
        #ai-status-modal.visible { display: flex; }
        .ai-status-box {
            width: 85%;
            max-width: 320px;
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .ai-status-box h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        .ai-status-box h4 {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 5px;
        }
        .ai-status-box p {
            font-size: 15px;
            line-height: 1.5;
            color: #333;
            margin-bottom: 15px;
            min-height: 22px;
            background: #f7f7f7;
            padding: 8px;
            border-radius: 6px;
        }
        .ai-status-box p:last-of-type { margin-bottom: 0; }

        .financial-modal-body {
            background-color: var(--ios-system-gray);
            padding: 0;
            margin: 0;
            width: 100%;
        }
        .financial-modal-body .modal-recipient-info {
            padding: 25px 20px;
            text-align: center;
        }
        .financial-modal-body .modal-recipient-info h3 {
            font-size: 16px;
            font-weight: normal;
            margin: 0;
        }
        .financial-modal-body .modal-amount-section,
        .financial-modal-body .modal-text-section,
        .financial-modal-body .modal-rp-type-section,
        .financial-modal-body .modal-rp-exclusive-section {
            background-color: #fff;
            padding: 15px;
            border-top: 1px solid var(--ios-border-color);
            border-bottom: 1px solid var(--ios-border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .financial-modal-body .modal-text-section { margin-top: -1px; }

        .financial-modal-body .modal-amount-row,
        .financial-modal-body .modal-text-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .financial-modal-body .modal-amount-section .currency-symbol {
            font-size: 30px;
            font-weight: 300;
            margin-right: 15px;
        }
        .financial-modal-body .modal-amount-section input,
        .financial-modal-body .modal-text-section input,
        .financial-modal-body .modal-text-section textarea,
        .financial-modal-body .modal-rp-type-section select,
        .financial-modal-body .modal-rp-exclusive-section select {
            flex-grow: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            padding: 5px 0;
            font-family: inherit;
            -webkit-user-select: text; 
            user-select: text;
        }
        #modal-red-packet-text { height: 60px; resize: none; }
        .financial-modal-body .modal-amount-section .amount-input { font-size: 30px; font-weight: 500; }
        .financial-modal-body .modal-final-amount {
            font-size: 40px;
            font-weight: 500;
            text-align: center;
            padding: 30px 20px;
        }
        .financial-modal-body .modal-submit-btn {
            display: block;
            width: calc(100% - 40px);
            margin: 0 auto 30px auto;
            padding: 12px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .financial-modal-body .transfer-submit { background-color: var(--wechat-green); }
        .financial-modal-body .red-packet-submit { background-color: var(--red-packet-color); }
        
        .rp-details-modal-body {
            background-color: #f7f7f7;
            padding: 0;
            width: 100%;
        }
        .rp-details-header {
            text-align: center;
            padding: 30px 20px 20px;
        }
        .rp-details-header .avatar {
            width: 50px; height: 50px; border-radius: 5px;
            margin: 0 auto 10px;
        }
        .rp-details-header p { font-size: 14px; color: #555; }
        .rp-details-amount {
            text-align: center;
            padding: 20px;
        }
        .rp-details-amount span { font-size: 40px; font-weight: 500; }
        .rp-details-amount p { font-size: 14px; color: #888; margin-top: 10px; }
        .rp-details-status {
            padding: 10px 15px;
            font-size: 14px;
            color: #888;
            background-color: #fff;
            border-top: 1px solid #e5e5e5;
            border-bottom: 1px solid #e5e5e5;
        }
        .rp-details-list {
            background-color: #fff;
            max-height: 250px;
            overflow-y: auto;
        }
        .rp-details-list-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .rp-details-list-item .avatar {
            width: 36px; height: 36px; border-radius: 4px; margin-right: 10px;
        }
        .rp-details-list-item-info { flex-grow: 1; }
        .rp-details-list-item-info strong { font-size: 15px; }
        .rp-details-list-item-info span { font-size: 12px; color: #aaa; display: block; margin-top: 2px; }
        .rp-details-list-item-amount { text-align: right; }
        .rp-details-list-item-amount strong { font-size: 15px; }
        .rp-details-list-item-amount .luckiest-tag {
            font-size: 11px;
            color: #E6A23C;
            margin-left: 5px;
        }


        .voice-message-bubble {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 80px;
            max-width: 250px;
            min-height: 40px;
            height: auto;
        }
        .message-turn.user .voice-message-bubble {
            background-color: var(--user-bubble-green);
            justify-content: flex-end;
        }
        .message-turn.assistant .voice-message-bubble {
            background-color: #FFF;
            justify-content: flex-start;
        }
        
        .voice-waveform {
            display: flex;
            align-items: center;
            height: 20px;
            gap: 2px;
            flex-shrink: 0;
        }
        .voice-waveform-bar {
            width: 2px;
            border-radius: 1px;
        }
        .message-turn.user .voice-waveform-bar { background-color: #333; }
        .message-turn.assistant .voice-waveform-bar { background-color: #333; }


        .voice-duration {
            font-size: 14px;
            color: #666;
            margin: 0 8px;
        }
        
        .voice-transcription {
            font-size: 13px;
            color: #000;
            line-height: 1.4;
            word-break: break-word;
            text-align: left;
            margin-top: 5px;
            padding: 8px 12px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
            max-width: 250px;
        }
        .message-turn.user .voice-transcription {
            background-color: #FFF;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .group-creation-body .settings-group {
            margin-bottom: 10px;
        }
        .group-creation-body .modal-contact-picker-list {
            max-height: 250px;
            overflow-y: auto;
            background-color: #fff;
            border-radius: 10px;
            padding: 0 15px;
        }
        .group-creation-body .picker-contact-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--ios-system-gray);
        }
        .group-creation-body .picker-contact-item:last-child {
            border-bottom: none;
        }
        .group-creation-body .picker-contact-item label {
            display: flex;
            align-items: center;
            width: 100%;
            font-size: 16px;
        }
        .group-creation-body .picker-contact-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
        }
        
        #wallet-page main {
            display: flex;
            flex-direction: column;
            background-color: #fff;
            flex-grow: 1;
            padding: 0 20px;
        }
        #wallet-page .header { background-color: var(--ios-system-gray); }
        .wallet-balance-container {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .wallet-balance-label {
            font-size: 15px;
            color: var(--text-placeholder);
        }
        .wallet-balance-amount {
            font-size: 48px;
            font-weight: bold;
            margin-top: 8px;
            color: var(--text-dark);
        }
        .wallet-bottom-container {
            padding-bottom: 20px;
        }
        .wallet-actions {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .wallet-action-btn {
            padding: 14px;
            font-size: 17px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        #wallet-topup-btn {
            background-color: var(--wechat-green);
            color: white;
        }
        #wallet-withdraw-btn {
            background-color: #F2F2F2;
            color: var(--text-dark);
        }
        .wallet-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--text-placeholder);
        }
        .wallet-footer a {
            color: var(--ios-blue);
            text-decoration: none;
        }
        
        #wallet-details-list {
            padding: 0;
            background-color: var(--ios-system-gray);
        }
        .transaction-group {
            margin-bottom: 0;
        }
        .transaction-group-header {
            padding: 4px 15px;
            font-size: 13px;
            color: var(--text-placeholder);
            background-color: var(--ios-system-gray);
            border-top: 1px solid var(--ios-border-color);
            border-bottom: 1px solid var(--ios-border-color);
        }
        .transaction-group:first-child .transaction-group-header {
            border-top: none;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background-color: #fff;
            border-bottom: 1px solid var(--ios-system-gray);
        }
        .transaction-details p {
            font-size: 15px;
            margin: 0;
        }
        .transaction-details span {
            display: block;
            font-size: 13px;
            color: var(--text-placeholder);
            margin-top: 6px;
        }
        .transaction-amount {
            text-align: right;
            flex-shrink: 0;
            padding-left: 15px;
        }
        .transaction-amount strong {
            font-size: 16px;
            font-weight: 500;
        }
        .transaction-amount span {
            display: block;
            font-size: 13px;
            color: var(--text-placeholder);
            margin-top: 6px;
        }
        .transaction-amount .income {
            color: var(--text-dark);
        }
        .transaction-amount .expense {
            color: var(--text-dark);
        }

        .described-image-bubble {
            width: 150px;
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background-image: url('https://pic1.imgdb.cn/item/68f2cc72c5157e1a887ee394.jpg');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .described-image-text {
            padding: 10px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 13px;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            max-height: 90%;
            overflow-y: auto;
            border-radius: 5px;
        }
        .described-image-bubble.show-text .described-image-text {
            opacity: 1;
        }
        
        .image-message-content {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--ios-border-color);
            background-color: #e0e0e0;
        }
        .image-message-content img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

    </style>
</head>
<body class="app-is-closed">
    <div class="phone-frame">
        <div id="status-bar-content">
            <div class="status-bar-left">
                <span id="status-bar-time">9:41</span>
            </div>
            <div class="status-bar-right">
                <div class="signal-icon">
                    <div class="signal-bar"></div>
                    <div class="signal-bar"></div>
                    <div class="signal-bar"></div>
                    <div class="signal-bar"></div>
                </div>
                <div class="battery-icon">
                    <div id="battery-level"></div>
                </div>
            </div>
        </div>

        <div id="dynamic-island" class="dynamic-island"><div class="island-content"><div class="loading-spinner"></div><span>正在生成...</span></div></div>

        <div id="home-screen">
            <div class="home-widget-container">
                <div id="widget-time" class="widget-time">18:45</div>
                <div id="widget-date" class="widget-date">9月30日 周二</div>
            </div>
            
            <div class="home-content-grid">
                <div>
                    <div class="app-grid app-grid-top">
                        <div id="reopen-app-icon" class="app-icon custom-icon"></div>
                        <div id="api-settings-icon" class="app-icon custom-icon"></div>
                        <div id="theme-icon" class="app-icon custom-icon"></div>
                    </div>
                </div>

                <div>
                    <div class="widget-area">
                        <div class="widget-column">
                            <div id="photo-widget" class="placeholder-widget"></div>
                            <div class="address-widget">
                                <span class="location-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#000000">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/>
                                    </svg>
                                </span>
                                <input type="text" id="address-input" placeholder="可点击编辑">
                            </div>
                        </div>
                        <div class="widget-column">
                            <div class="text-image-widget placeholder-widget">
                                <div id="circular-upload-1" class="circular-image-upload"></div>
                                <textarea class="editable-textarea" rows="2" placeholder="可点击编辑"></textarea>
                            </div>
                            <div class="text-image-widget image-right placeholder-widget">
                                <div id="circular-upload-2" class="circular-image-upload"></div>
                                <textarea class="editable-textarea" rows="2" placeholder="可点击编辑"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="app-grid app-grid-bottom">
                        <div id="forum-app-icon" class="app-icon custom-icon disabled-icon"></div>
                        <div id="worldbook-app-icon" class="app-icon custom-icon"></div>
                        <div id="icity-app-icon" class="app-icon custom-icon disabled-icon"></div>
                        <div id="dev2-app-icon" class="app-icon disabled-icon custom-icon"></div>
                    </div>
                </div>

                <div>
                    <div id="custom-image-text-widget">
                        <div class="widget-left-column">
                            <div id="widget-circular-upload"></div>
                        </div>
                        <div class="widget-right-column">
                            <input type="text" id="widget-text-top" placeholder="点击编辑标题">
                            <input type="text" id="widget-text-bottom" placeholder="点击编辑内容">
                        </div>
                    </div>
                </div>
            </div>
            
            <input type="file" id="photo-widget-input" accept="image/*" style="display: none;">
            <input type="file" id="circular-upload-input-1" accept="image/*" style="display: none;">
            <input type="file" id="circular-upload-input-2" accept="image/*" style="display: none;">
            <input type="file" id="widget-circular-upload-input" accept="image/*" style="display: none;">
            <input type="file" id="widget-background-input" accept="image/*" style="display: none;">
        </div>

        <div class="app-container" id="app-container">
            <div id="theme-settings-modal" class="page">
                <header class="header">
                    <button id="close-theme-settings-btn" class="header-btn left"><span>关闭</span></button>
                    <h1 class="header-title">主题设置</h1>
                </header>
                <main class="settings-content">
                    <div class="settings-group">
                        <label for="wallpaper-input" class="save-btn" style="text-align: center; display: block;">从相册选择壁纸</label>
                        <input type="file" id="wallpaper-input" accept="image/*" style="display: none;">
                    </div>
                    <button id="reset-wallpaper-btn" class="save-btn reset-btn">恢复默认壁纸</button>
                    
                    <div class="settings-group-spacer" style="height: 20px;"></div>
                    <h3 style="font-size: 14px; color: var(--text-placeholder); padding: 0 15px 10px;">应用图标自定义</h3>
                    <div class="settings-group">
                        <div id="icon-settings-list">
                        </div>
                    </div>
                    <input type="file" id="icon-upload-input" accept="image/*" style="display: none;">
                </main>
            </div>

            <div id="main-settings-modal" class="page">
                <header class="header">
                    <button id="close-main-settings-btn" class="header-btn left"><span>关闭</span></button>
                    <h1 class="header-title">设置</h1>
                </header>
                <main class="settings-content">
                    <div class="settings-group-spacer"></div>
                    <div class="settings-group">
                        <div id="go-to-api-config-btn" class="me-settings-item">
                            <span class="me-settings-label">API 配置</span>
                            <span class="me-settings-arrow">&gt;</span>
                        </div>
                    </div>
                    <div class="settings-group-spacer"></div>
                    <div class="settings-group">
                        <div id="go-to-data-management-btn" class="me-settings-item">
                            <span class="me-settings-label">数据管理</span>
                            <span class="me-settings-arrow">&gt;</span>
                        </div>
                    </div>
                    <div class="settings-group-spacer"></div>
                    <div class="settings-group">
                        <div class="toggle-switch-group">
                            <span class="toggle-switch-label">模拟手机外观</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="toggle-phone-frame">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </main>
            </div>

            <div id="data-management-page" class="page">
                <header class="header">
                    <button id="back-to-main-settings-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>设置</span></button>
                    <h1 class="header-title">数据管理</h1>
                </header>
                <main class="settings-content">
                    <p style="font-size: 13px; color: var(--text-placeholder); margin-bottom: 20px; padding: 0 5px; line-height: 1.5;">
                        您可以将应用内的所有数据（包括联系人、面具、聊天记录、API设置和主题等）导出为单个文件进行备份，或从备份文件导入以恢复数据。
                    </p>
                    <button id="export-data-btn" class="save-btn">导出数据</button>
                    <button id="import-data-btn" class="save-btn">导入数据</button>
                    <input type="file" id="import-file-input" accept=".json, .gz" style="display: none;">
                </main>
            </div>

            <div id="api-config-page" class="page">
                <header class="header">
                    <button id="back-to-main-settings-from-api-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>设置</span></button>
                    <h1 class="header-title">API 配置</h1>
                </header>
                <main class="settings-content">
                    <div class="settings-group">
                        <div class="form-group"><label for="base-url">Base URL</label><input type="text" id="base-url" placeholder="https://api.example.com"></div>
                        <div class="form-group"><label for="api-key">API Key</label><input type="password" id="api-key" placeholder="必需"></div>
                        <div class="form-group">
                            <label for="model-select">Model</label>
                            <select id="model-select"></select>
                        </div>
                    </div>
                    <button id="fetch-models-btn" class="save-btn">获取模型列表</button>
                    <div class="settings-group">
                        <div class="form-group">
                            <label for="preset-select">加载预设</label>
                            <div class="preset-management-wrapper">
                                <select id="preset-select">
                                    <option value="">选择一个预设...</option>
                                </select>
                                <button id="delete-preset-btn">删除</button>
                            </div>
                        </div>
                    </div>
                    <div class="api-settings-buttons">
                        <button id="save-preset-btn" class="save-btn">另存为预设</button>
                        <button id="save-api-settings-btn" class="save-btn">保存并使用</button>
                    </div>
                </main>
            </div>
            
            <div id="worldbook-page" class="page">
                <header class="header">
                    <button id="back-from-worldbook-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>退出</span></button>
                    <h1 class="header-title">世界书</h1>
                    <div class="header-btn-group">
                        <button id="wb-create-folder-btn" class="header-btn" title="创建文件夹">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v6m3-3H9m4.06-7.19-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>
                        </button>
                        <button id="wb-create-file-btn" class="header-btn" title="创建文件">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                        </button>
                    </div>
                </header>
                <main class="settings-content">
                    <div id="worldbook-list-container"></div>
                </main>
            </div>
            
            <div id="worldbook-edit-page" class="page">
                <header class="header">
                    <button id="wb-edit-cancel-btn" class="header-btn left"><span>取消</span></button>
                    <h1 id="wb-edit-title" class="header-title">新建文件</h1>
                    <button id="wb-edit-save-btn" class="header-btn right" style="font-weight: 600;">保存</button>
                </header>
                <main class="settings-content">
                    <div class="settings-group">
                        <div class="form-group"><label for="wb-edit-name">文件名称</label><input type="text" id="wb-edit-name" placeholder="为设定起一个名字"></div>
                    </div>
                    <div class="settings-group">
                        <div class="form-group">
                            <label for="wb-edit-folder">文件归类</label>
                            <select id="wb-edit-folder"></select>
                        </div>
                    </div>
                    <div class="settings-group">
                         <div class="form-group">
                            <label for="wb-edit-content" style="align-self: flex-start; padding-top: 10px;">文件内容</label>
                            <textarea id="wb-edit-content" placeholder="详细描述这个设定..."></textarea>
                        </div>
                    </div>
                </main>
            </div>

            <div id="toast-notification" class="toast"></div>
            <div class="content-area">
                <div id="wallet-details-page" class="page">
                    <header class="header">
                        <button id="back-to-wallet-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>零钱</span></button>
                        <h1 class="header-title">零钱明细</h1>
                    </header>
                    <main id="wallet-details-list" class="settings-content"></main>
                </div>
                
                <div id="wallet-page" class="page">
                    <header class="header">
                        <button id="back-to-me-from-wallet-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>我</span></button>
                        <h1 class="header-title">零钱</h1>
                        <button id="wallet-details-btn" class="header-btn right">零钱明细</button>
                    </header>
                    <main>
                        <div class="wallet-balance-container">
                            <p class="wallet-balance-label">我的零钱</p>
                            <p id="wallet-balance-amount" class="wallet-balance-amount">¥0.00</p>
                        </div>
                        <div class="wallet-bottom-container">
                            <div class="wallet-actions">
                                <button id="wallet-topup-btn" class="wallet-action-btn">充值</button>
                                <button id="wallet-withdraw-btn" class="wallet-action-btn">提现</button>
                            </div>
                            <div class="wallet-footer">
                                <a href="#">常见问题</a>
                                <p>本服务由财付通提供</p>
                            </div>
                        </div>
                    </main>
                </div>

                <div id="worldbook-binding-page" class="page">
                    <header class="header">
                        <button id="back-to-chat-settings-from-wb-binding-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>聊天详情</span></button>
                        <h1 class="header-title">绑定世界书</h1>
                    </header>
                    <main id="worldbook-binding-list" class="settings-content"></main>
                </div>
                
                <div id="wechat-main-page" class="page">
                    <header class="wechat-header">
                        <button id="exit-wechat-btn" class="header-btn left" title="返回主屏幕"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button>
                        <h1 class="wechat-header-title">消息</h1>
                        <div class="wechat-header-icons">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                            <button id="main-add-btn" class="header-btn" style="position: static; padding: 0;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>
                        </div>
                    </header>
                    <main class="wechat-chat-list"></main>
                </div>

                <div id="contacts-page" class="page">
                    <header class="header">
                        <button id="back-to-main-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>消息</span></button>
                        <h1 class="header-title">通讯录</h1>
                        <button id="add-new-contact-btn" class="header-btn right" title="添加新联系人"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3.375 19.5h17.25m-17.25 0a2.25 2.25 0 0 1-2.25-2.25v-1.5a2.25 2.25 0 0 1 2.25-2.25h17.25a2.25 2.25 0 0 1 2.25 2.25v1.5a2.25 2.25 0 0 1-2.25 2.25h-17.25Z" /></svg></button>
                    </header>
                    <main id="contacts-list"></main>
                </div>

                <div id="favorites-page" class="page">
                    <header class="header">
                        <button id="back-to-me-from-favorites-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>我</span></button>
                        <h1 class="header-title">收藏</h1>
                    </header>
                    <main id="favorites-list"></main>
                </div>

                <div id="me-page" class="page">
                    <header class="header" style="background-color: var(--ios-system-gray); border-bottom: none;">
                        <h1 class="header-title" style="opacity: 0;">我</h1>
                    </header>
                    <main class="settings-content">
                        <div class="me-profile-header">
                            <div id="me-avatar"></div>
                            <h2 id="me-name" contenteditable="true"></h2>
                        </div>
                        <input type="file" id="me-avatar-input" accept="image/*" style="display: none;">
                        
                        <div class="settings-group-spacer"></div>
                        <div class="settings-group">
                            <div id="me-wallet-btn" class="me-settings-item">
                                <span class="me-settings-label">钱包</span>
                                <span class="me-settings-arrow">&gt;</span>
                            </div>
                        </div>

                        <div class="settings-group-spacer"></div>
                        <div class="settings-group">
                            <div id="me-masks-btn" class="me-settings-item">
                                <span class="me-settings-label">我的面具</span>
                                <span class="me-settings-arrow">&gt;</span>
                            </div>
                        </div>
                        <div class="settings-group-spacer"></div>
                        <div class="settings-group">
                            <div id="me-favorites-btn" class="me-settings-item">
                                <span class="me-settings-label">收藏</span>
                                <span class="me-settings-arrow">&gt;</span>
                            </div>
                            <div id="me-moments-btn" class="me-settings-item">
                                <span class="me-settings-label">朋友圈</span>
                                <span class="me-settings-arrow">&gt;</span>
                            </div>
                            <div id="me-stickers-btn" class="me-settings-item">
                                <span class="me-settings-label">表情</span>
                                <span class="me-settings-arrow">&gt;</span>
                            </div>
                        </div>
                    </main>
                </div>

                <div id="my-masks-page" class="page">
                    <header class="header">
                        <button id="back-to-me-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>我</span></button>
                        <h1 class="header-title">我的面具</h1>
                        <button id="add-mask-btn" class="header-btn right"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>
                    </header>
                    <main id="masks-list"></main>
                </div>

                <div id="edit-mask-page" class="page">
                    <header class="header">
                        <button id="cancel-edit-mask-btn" class="header-btn left"><span>取消</span></button>
                        <h1 id="edit-mask-title" class="header-title">创建面具</h1>
                        <button id="save-mask-btn" class="header-btn right" style="font-weight: 600;">保存</button>
                    </header>
                    <main class="settings-content">
                        <div class="avatar-uploader">
                            <div id="mask-avatar-preview" class="avatar-preview">点击上传</div>
                            <span>设置头像</span>
                            <input type="file" id="mask-avatar-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="settings-group">
                            <div class="form-group"><label for="mask-name-input">姓名</label><input type="text" id="mask-name-input" placeholder="为这个面具起个名字"></div>
                            <div class="form-group">
                                <label for="mask-gender-select">性别</label>
                                <select id="mask-gender-select">
                                    <option value="保密">保密</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="form-group">
                                <label for="mask-story-textarea" style="align-self: flex-start; padding-top: 10px;">背景故事</label>
                                <textarea id="mask-story-textarea" placeholder="设定一个独特的背景故事、性格和说话方式..."></textarea>
                            </div>
                        </div>
                        <button id="delete-mask-btn" class="save-btn" style="display: none;">删除面具</button>
                    </main>
                </div>

                <div id="mask-selection-page" class="page">
                    <header class="header">
                        <button id="back-to-chat-settings-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg><span>聊天详情</span></button>
                        <h1 class="header-title">选择一个面具</h1>
                    </header>
                    <main id="mask-selection-list"></main>
                </div>

                <div id="edit-contact-page" class="page">
                    <header class="header">
                        <button id="cancel-edit-contact-btn" class="header-btn left"><span>取消</span></button>
                        <h1 id="edit-contact-title" class="header-title">添加朋友</h1>
                        <button id="save-contact-btn" class="header-btn right" style="font-weight: 600;">完成</button>
                    </header>
                    <main class="settings-content">
                        <div class="avatar-uploader">
                            <div id="contact-avatar-preview" class="avatar-preview">点击上传</div>
                            <span>设置头像</span>
                            <input type="file" id="contact-avatar-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="settings-group">
                            <div class="form-group"><label for="contact-name-input">姓名</label><input type="text" id="contact-name-input" placeholder="为AI朋友起个名字"></div>
                            <div class="form-group">
                                <label for="contact-gender-select">性别</label>
                                <select id="contact-gender-select">
                                    <option value="保密">保密</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="form-group">
                                <label for="contact-story-textarea" style="align-self: flex-start; padding-top: 10px;">背景故事</label>
                                <textarea id="contact-story-textarea" placeholder="为TA设定一个独特的背景故事、性格和说话方式..."></textarea>
                            </div>
                        </div>
                    </main>
                </div>

                <div id="chat-page" class="page">
                    <header id="chat-page-header" class="header">
                        <button id="back-to-list-btn" class="header-btn left" title="返回"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button>
                        <h1 id="chat-header-title" class="header-title">AI 助手</h1>
                        <button id="cancel-multi-select-btn" class="header-btn right" style="display: none;">取消</button>
                        <button id="to-settings-btn" class="header-btn right"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.7"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg></button>
                    </header>
                    <main id="chat-messages" class="chat-messages"></main>
                </div>

                <div id="chat-settings-page" class="page">
                    <header class="header">
                        <button id="back-to-chat-btn" class="header-btn left"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button>
                        <h1 class="header-title">聊天详情</h1>
                    </header>
                    <main class="settings-content">
                        <div class="chat-settings-header">
                            <div id="chat-settings-avatar" class="avatar"></div>
                            <div id="chat-settings-name"></div>
                        </div>
                        <div class="settings-group">
                            <div class="toggle-switch-group">
                                <span class="toggle-switch-label">置顶聊天</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pin-chat-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="toggle-switch-group">
                                <span class="toggle-switch-label">时间感应</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="time-sensing-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div id="set-chat-background-btn" class="settings-action-item">
                                <span class="settings-action-label">设置当前聊天背景</span>
                                <span class="settings-action-arrow">&gt;</span>
                            </div>
                            <div id="change-chat-avatars-btn" class="settings-action-item">
                                <span class="settings-action-label">更换聊天头像</span>
                                <span class="settings-action-arrow">&gt;</span>
                            </div>
                        </div>
                        <div class="settings-group">
                             <div id="bind-mask-btn" class="settings-action-item">
                                <span class="settings-action-label">绑定我的面具</span>
                                <div style="display: flex; align-items: center;">
                                    <span id="bound-mask-name" class="settings-action-value">未绑定</span>
                                    <span class="settings-action-arrow">&gt;</span>
                                </div>
                            </div>
                        </div>
                         <div class="settings-group">
                            <div id="bind-worldbook-btn" class="settings-action-item">
                                <span class="settings-action-label">绑定世界书</span>
                                <div style="display: flex; align-items: center;">
                                    <span id="bound-worldbook-value" class="settings-action-value">未绑定</span>
                                    <span class="settings-action-arrow">&gt;</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div id="set-remark-btn" class="settings-action-item">
                                <span class="settings-action-label">设置备注和标签</span>
                                <span class="settings-action-arrow">&gt;</span>
                            </div>
                            <div id="edit-contact-info-btn" class="settings-action-item">
                                <span class="settings-action-label">编辑设定</span>
                                <span class="settings-action-arrow">&gt;</span>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="form-group action-button-group">
                                <button id="clear-history-btn">清空聊天记录</button>
                            </div>
                        </div>
                        <button id="delete-contact-btn" class="save-btn">删除联系人</button>
                        <input type="file" id="chat-bg-input" accept="image/*" style="display: none;" />
                    </main>
                </div>

            </div>
            <footer id="chat-page-footer">
                <div id="more-actions-panel">
                    <div class="action-grid">
                        <div class="action-grid-item" data-action="album">
                            <div class="action-grid-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            </div>
                            <span class="action-grid-label">相册</span>
                        </div>
                        <div class="action-grid-item" data-action="described-image"><div class="action-grid-icon"><svg viewBox="0 0 1024 1024" fill="currentColor"><path d="M832 288H704l-48-64H368l-48 64H192c-53 0-96 43-96 96v448c0 53 43 96 96 96h640c53 0 96-43 96-96V384c0-53-43-96-96-96zM512 768c-114.9 0-208-93.1-208-208s93.1-208 208-208 208 93.1 208 208-93.1 208-208 208zm0-352c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144z"></path></svg></div><span class="action-grid-label">拍摄</span></div>
                        <div class="action-grid-item" data-action="video-call">
                            <div class="action-grid-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                            </div>
                            <span class="action-grid-label">视频通话</span>
                        </div>
                        <div class="action-grid-item" data-action="location"><div class="action-grid-icon"><svg viewBox="0 0 1024 1024" fill="currentColor"><path d="M512 128c-198.7 0-352 153.3-352 352 0 128 64 256 192 320l160 128 160-128c128-64 192-192 192-320C864 281.3 710.7 128 512 128zm0 448c-70.7 0-128-57.3-128-128s57.3-128 128-128 128 57.3 128 128-57.3 128-128 128z"></path></svg></div><span class="action-grid-label">位置</span></div>
                        <div class="action-grid-item" data-action="red-packet">
                            <div class="action-grid-icon">
                               <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 3h16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path><path d="M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M2 8h20"></path></svg>
                            </div>
                            <span class="action-grid-label">红包</span>
                        </div>
                        <div class="action-grid-item" data-action="transfer">
                             <div class="action-grid-icon">
                                <img src="https://pic1.imgdb.cn/item/68e35e23c5157e1a8859a2ea.jpg" alt="转账">
                            </div>
                            <span class="action-grid-label">转账</span>
                        </div>
                        <div class="action-grid-item" data-action="voice-input">
                            <div class="action-grid-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                </svg>
                            </div>
                            <span class="action-grid-label">语音</span>
                        </div>
                        <div class="action-grid-item" data-action="voice-call"><div class="action-grid-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"></path></svg></div><span class="action-grid-label">语音通话</span></div>
                    </div>
                    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                </div>
                <div id="reply-preview-bar">
                    <div class="reply-preview-content"></div>
                    <button id="close-reply-btn">&times;</button>
                </div>
                <div class="chat-input-area">
                    <button id="more-actions-btn" class="action-btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 8V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button id="emoji-btn" class="action-btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14"/>
                            <path d="M9 9H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15 9H15.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <textarea id="message-input" rows="1" placeholder="发送消息"></textarea>
                    <button id="send-btn" class="action-btn send-btn">发送</button>
                    <button id="generate-btn" class="action-btn"></button>
                </div>
                <div id="multi-select-toolbar">
                    <button id="multi-select-forward-btn" class="multi-select-btn" title="转发"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg></button>
                    <button id="multi-select-delete-btn" class="multi-select-btn" title="删除"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                </div>
            </footer>
            <nav class="wechat-tab-bar">
                <div id="tab-messages" class="tab-item active">
                    <svg viewBox="0 0 24 24"><path d="M20,2H4C2.9,2,2,2.9,2,4v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z"></path></svg>
                    <span>消息</span>
                </div>
                <div id="tab-contacts" class="tab-item">
                    <svg viewBox="0 0 24 24"><path d="M12,12c2.2,0,4-1.8,4-4s-1.8-4-4-4S8,5.8,8,8S9.8,12,12,12z M12,14c-2.7,0-8,1.3-8,4v2h16v-2C20,15.3,14.7,14,12,14z"></path></svg>
                    <span>通讯录</span>
                </div>
                <div id="tab-discover" class="tab-item disabled-icon">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88"></polygon></svg>
                    <span>发现</span>
                </div>
                <div id="tab-me" class="tab-item">
                    <svg viewBox="0 0 24 24"><path d="M12,12c2.2,0,4-1.8,4-4s-1.8-4-4-4S8,5.8,8,8S9.8,12,12,12z M12,14c-2.7,0-8,1.3-8,4v2h16v-2C20,15.3,14.7,14,12,14z"></path></svg>
                    <span>我</span>
                </div>
            </nav>
        </div>

        <div id="main-add-menu-overlay"></div>
        <ul id="main-add-menu">
            <li id="menu-start-new-chat">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg>
                发起新聊天
            </li>
            <li id="menu-create-group">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.226A3 3 0 0 1 15 15l-1.076 1.076a3 3 0 0 1-4.242 0l-2.122-2.122a3 3 0 0 1 0-4.242l1.076-1.076A3 3 0 0 1 10.5 7.5m-5 5a4.5 4.5 0 0 1 0-6.364A4.5 4.5 0 0 1 12 6.136m-1.071 4.545A4.5 4.5 0 0 0 12 17.864a4.5 4.5 0 0 0 6.364-6.364m-1.071 4.545L12 17.864" /></svg>
                创建群聊
            </li>
        </ul>

        <div id="ai-status-modal">
            <div class="ai-status-box">
                <h3>AI 状态</h3>
                <h4>内心想法</h4>
                <p id="ai-status-thoughts">(暂无)</p>
                <h4>细微动作</h4>
                <p id="ai-status-action">(暂无)</p>
                <h4>当前衣着</h4>
                <p id="ai-status-clothing">(暂无)</p>
                <h4>当前地点</h4>
                <p id="ai-status-location">(暂无)</p>
            </div>
        </div>
        
        <div id="custom-modal-overlay" class="custom-modal-overlay">
            <div class="custom-modal-box">
                <div class="custom-modal-content">
                    <h3 id="modal-title" class="custom-modal-title"></h3>
                    <div id="modal-message" class="custom-modal-message"></div>
                </div>
                <div id="modal-buttons" class="custom-modal-buttons"></div>
            </div>
        </div>

        <div id="forward-contact-picker-modal">
            <div class="forward-picker-box">
                <div class="forward-picker-header">转发给</div>
                <div id="forward-picker-list" class="forward-picker-list"></div>
            </div>
        </div>

        <div class="home-indicator-container">
            <div class="home-indicator"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = new Dexie("onlyunApp");
            db.version(24).stores({
                contacts: '++id, &contactId, type, isPinned, lastMessageTimestamp',
                masks: '++id, &maskId',
                chatHistories: '&contactId',
                settings: '&key',
                widgetData: '&key',
                favorites: '&favId, contactId, timestamp',
                worldBook: '++id, type, folderId, name',
                userProfile: '&key',
                transactions: '++id, timestamp, owner'
            });

            // DOM Elements
            const body = document.body;
            const homeScreen = document.getElementById('home-screen');
            const reopenAppIcon = document.getElementById('reopen-app-icon');
            const apiSettingsIcon = document.getElementById('api-settings-icon');
            const themeIcon = document.getElementById('theme-icon');
            const worldbookAppIcon = document.getElementById('worldbook-app-icon');
            const exitWechatBtn = document.getElementById('exit-wechat-btn');
            
            const statusBarTime = document.getElementById('status-bar-time');
            const batteryLevel = document.getElementById('battery-level');
            const widgetTime = document.getElementById('widget-time');
            const widgetDate = document.getElementById('widget-date');
            const dynamicIsland = document.getElementById('dynamic-island');
            
            const photoWidget = document.getElementById('photo-widget');
            const photoWidgetInput = document.getElementById('photo-widget-input');
            const circularUpload1 = document.getElementById('circular-upload-1');
            const circularUploadInput1 = document.getElementById('circular-upload-input-1');
            const circularUpload2 = document.getElementById('circular-upload-2');
            const circularUploadInput2 = document.getElementById('circular-upload-input-2');
            const customImageTextWidget = document.getElementById('custom-image-text-widget');
            const widgetCircularUpload = document.getElementById('widget-circular-upload');
            const widgetCircularUploadInput = document.getElementById('widget-circular-upload-input');
            const widgetTextTop = document.getElementById('widget-text-top');
            const widgetTextBottom = document.getElementById('widget-text-bottom');
            const widgetBackgroundInput = document.getElementById('widget-background-input');

            const wechatChatList = document.querySelector('.wechat-chat-list');
            const tabMessages = document.getElementById('tab-messages');
            const tabContacts = document.getElementById('tab-contacts');
            const tabMe = document.getElementById('tab-me');
            
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const contactsList = document.getElementById('contacts-list');
            const addNewContactBtn = document.getElementById('add-new-contact-btn');
            
            const backToListBtn = document.getElementById('back-to-list-btn');
            const chatHeaderTitle = document.getElementById('chat-header-title');
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const generateBtn = document.getElementById('generate-btn');
            const moreActionsBtn = document.getElementById('more-actions-btn');
            const emojiBtn = document.getElementById('emoji-btn');
            const moreActionsPanel = document.getElementById('more-actions-panel');
            
            const toSettingsBtn = document.getElementById('to-settings-btn');
            const backToChatBtn = document.getElementById('back-to-chat-btn');
            const chatSettingsAvatar = document.getElementById('chat-settings-avatar');
            const chatSettingsName = document.getElementById('chat-settings-name');
            const pinChatToggle = document.getElementById('pin-chat-toggle');
            const timeSensingToggle = document.getElementById('time-sensing-toggle');
            const setChatBackgroundBtn = document.getElementById('set-chat-background-btn');
            const chatBgInput = document.getElementById('chat-bg-input');
            const setRemarkBtn = document.getElementById('set-remark-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const deleteContactBtn = document.getElementById('delete-contact-btn');
            const editContactInfoBtn = document.getElementById('edit-contact-info-btn');
            const bindMaskBtn = document.getElementById('bind-mask-btn');
            const boundMaskName = document.getElementById('bound-mask-name');
            const bindWorldbookBtn = document.getElementById('bind-worldbook-btn');
            const boundWorldbookValue = document.getElementById('bound-worldbook-value');

            const cancelEditContactBtn = document.getElementById('cancel-edit-contact-btn');
            const saveContactBtn = document.getElementById('save-contact-btn');
            const editContactTitle = document.getElementById('edit-contact-title');
            const contactNameInput = document.getElementById('contact-name-input');
            const contactGenderSelect = document.getElementById('contact-gender-select');
            const contactStoryTextarea = document.getElementById('contact-story-textarea');
            const contactAvatarInput = document.getElementById('contact-avatar-input');
            
            const toast = document.getElementById('toast-notification');
            
            const modalOverlay = document.getElementById('custom-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            const mainSettingsModal = document.getElementById('main-settings-modal');
            const closeMainSettingsBtn = document.getElementById('close-main-settings-btn');
            const goToApiConfigBtn = document.getElementById('go-to-api-config-btn');
            const goToDataManagementBtn = document.getElementById('go-to-data-management-btn');
            const backToMainSettingsBtn = document.getElementById('back-to-main-settings-btn');
            const togglePhoneFrame = document.getElementById('toggle-phone-frame');
            
            const themeSettingsModal = document.getElementById('theme-settings-modal');
            const closeThemeSettingsBtn = document.getElementById('close-theme-settings-btn');
            const wallpaperInput = document.getElementById('wallpaper-input');
            const resetWallpaperBtn = document.getElementById('reset-wallpaper-btn');
            const iconSettingsList = document.getElementById('icon-settings-list');
            const iconUploadInput = document.getElementById('icon-upload-input');
            
            const backToMainSettingsFromApiBtn = document.getElementById('back-to-main-settings-from-api-btn');
            const baseUrlInput = document.getElementById('base-url');
            const apiKeyInput = document.getElementById('api-key');
            const modelSelect = document.getElementById('model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const saveApiSettingsBtn = document.getElementById('save-api-settings-btn');
            const presetSelect = document.getElementById('preset-select');
            const savePresetBtn = document.getElementById('save-preset-btn');
            const deletePresetBtn = document.getElementById('delete-preset-btn');
            
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            const mePage = document.getElementById('me-page');
            const meAvatar = document.getElementById('me-avatar');
            const meAvatarInput = document.getElementById('me-avatar-input');
            const meName = document.getElementById('me-name');
            const meMomentsBtn = document.getElementById('me-moments-btn');
            const meStickersBtn = document.getElementById('me-stickers-btn');
            const meMasksBtn = document.getElementById('me-masks-btn');
            const meFavoritesBtn = document.getElementById('me-favorites-btn');

            const backToMeBtn = document.getElementById('back-to-me-btn');
            const backToChatSettingsBtn = document.getElementById('back-to-chat-settings-btn');
            const masksList = document.getElementById('masks-list');
            const addMaskBtn = document.getElementById('add-mask-btn');
            
            const editMaskTitle = document.getElementById('edit-mask-title');
            const cancelEditMaskBtn = document.getElementById('cancel-edit-mask-btn');
            const saveMaskBtn = document.getElementById('save-mask-btn');
            const deleteMaskBtn = document.getElementById('delete-mask-btn');
            const maskAvatarUploader = document.querySelector('#edit-mask-page .avatar-uploader');
            const maskAvatarInput = document.getElementById('mask-avatar-input');
            const maskAvatarPreview = document.getElementById('mask-avatar-preview');
            const maskNameInput = document.getElementById('mask-name-input');
            const maskGenderSelect = document.getElementById('mask-gender-select');
            const maskStoryTextarea = document.getElementById('mask-story-textarea');

            const maskSelectionList = document.getElementById('mask-selection-list');
            
            const backToMeFromFavoritesBtn = document.getElementById('back-to-me-from-favorites-btn');
            const favoritesList = document.getElementById('favorites-list');
            
            const multiSelectToolbar = document.getElementById('multi-select-toolbar');
            const multiSelectDeleteBtn = document.getElementById('multi-select-delete-btn');
            const multiSelectForwardBtn = document.getElementById('multi-select-forward-btn');
            const cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn');
            
            const forwardContactPickerModal = document.getElementById('forward-contact-picker-modal');
            const forwardPickerList = document.getElementById('forward-picker-list');
            
            const mainAddMenuOverlay = document.getElementById('main-add-menu-overlay');
            const mainAddMenu = document.getElementById('main-add-menu');
            const mainAddBtn = document.getElementById('main-add-btn');
            const menuStartNewChat = document.getElementById('menu-start-new-chat');
            const menuCreateGroup = document.getElementById('menu-create-group');
            
            const replyPreviewBar = document.getElementById('reply-preview-bar');
            const replyPreviewContent = document.querySelector('.reply-preview-content');
            const closeReplyBtn = document.getElementById('close-reply-btn');
            
            const backFromWorldbookBtn = document.getElementById('back-from-worldbook-btn');
            const worldbookListContainer = document.getElementById('worldbook-list-container');
            const wbCreateFolderBtn = document.getElementById('wb-create-folder-btn');
            const wbCreateFileBtn = document.getElementById('wb-create-file-btn');
            const wbEditTitle = document.getElementById('wb-edit-title');
            const wbEditNameInput = document.getElementById('wb-edit-name');
            const wbEditFolderSelect = document.getElementById('wb-edit-folder');
            const wbEditContentTextarea = document.getElementById('wb-edit-content');
            const wbEditCancelBtn = document.getElementById('wb-edit-cancel-btn');
            const wbEditSaveBtn = document.getElementById('wb-edit-save-btn');
            const worldbookBindingList = document.getElementById('worldbook-binding-list');
            const backToChatSettingsFromWBBindingBtn = document.getElementById('back-to-chat-settings-from-wb-binding-btn');

            const aiStatusModal = document.getElementById('ai-status-modal');
            const aiStatusThoughts = document.getElementById('ai-status-thoughts');
            const aiStatusAction = document.getElementById('ai-status-action');
            const aiStatusClothing = document.getElementById('ai-status-clothing');
            const aiStatusLocation = document.getElementById('ai-status-location');
            
            const meWalletBtn = document.getElementById('me-wallet-btn');
            const backToMeFromWalletBtn = document.getElementById('back-to-me-from-wallet-btn');
            const walletBalanceAmount = document.getElementById('wallet-balance-amount');
            const walletTopupBtn = document.getElementById('wallet-topup-btn');
            const walletWithdrawBtn = document.getElementById('wallet-withdraw-btn');
            const walletDetailsBtn = document.getElementById('wallet-details-btn');
            const backToWalletBtn = document.getElementById('back-to-wallet-btn');
            const walletDetailsList = document.getElementById('wallet-details-list');

            const changeChatAvatarsBtn = document.getElementById('change-chat-avatars-btn');
            const imageUploadInput = document.getElementById('image-upload-input');

            // State variables
            let currentChatContactId = null;
            let currentEditingContact = null;
            let currentEditingMask = null;
            let currentEditingWorldBookItem = null;
            let contactEditorReturnPath = 'contacts';
            let tempAvatarDataUrl = null;
            let settings = { baseURL: '', apiKey: '', modelName: '' };
            let allContacts = [];
            let toastTimer;
            let longPressTimer;
            let currentIconToChange = null;
            let isMultiSelectMode = false;
            let selectedMessages = new Map();
            let replyToMessage = null;
            const voiceTextVisible = new WeakSet();
            const avatarColors = ['#F56565', '#ED8936', '#ECC94B', '#48BB78', '#38B2AC', '#4299E1', '#667EEA', '#9F7AEA', '#ED64A6'];
            const defaultGroupAvatar = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5v-1c0-2.67 5.33-4 8-4s8 1.33 8 4v1c0 2.33-7 3.5-7 3.5z"/></svg>`;
            const defaultMaskAvatar = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>`;
            
            // Functions
            const showToast = (message, level = 'info') => {
                clearTimeout(toastTimer);
                toast.textContent = message;
                toast.className = `toast show ${level}`;
                toastTimer = setTimeout(() => {
                    toast.classList.remove('show');
                }, 2500);
            };

            const returnToHomeScreen = () => {
                body.classList.add('app-is-closed');
                navigateTo(null);
            };

            const updateTime = () => {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const timeString = `${hours}:${minutes}`;
                statusBarTime.textContent = timeString;
                widgetTime.textContent = timeString;
            };
            
            const updateBattery = async () => {
                try {
                    if ('getBattery' in navigator) {
                        const battery = await navigator.getBattery();
                        const level = battery.level * 100;
                        batteryLevel.style.width = `${level}%`;
                        if (battery.charging) {
                             batteryLevel.style.backgroundColor = 'var(--wechat-green)';
                        } else {
                             batteryLevel.style.backgroundColor = 'currentColor';
                        }
                    }
                } catch(e) {
                    console.warn("Could not access Battery API.", e);
                    const now = new Date();
                    batteryLevel.style.width = `${(60 - now.getSeconds()) / 60 * 100}%`;
                }
            };

            const updateDate = () => {
                const now = new Date();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const dayOfWeek = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][now.getDay()];
                widgetDate.textContent = `${month}月${day}日 ${dayOfWeek}`;
            };

            const formatTimestamp = (timestamp, type = 'list') => {
                if (!timestamp) return '';
                const msgDate = new Date(timestamp);
                
                if (type === 'message-datetime') {
                    return `${msgDate.getMonth() + 1}月${msgDate.getDate()}日 ${String(msgDate.getHours()).padStart(2, '0')}:${String(msgDate.getMinutes()).padStart(2, '0')}`;
                }

                if (type === 'message') {
                    return `${String(msgDate.getHours()).padStart(2, '0')}:${String(msgDate.getMinutes()).padStart(2, '0')}`;
                }

                const now = new Date();
                const nowYear = now.getFullYear();
                const nowMonth = now.getMonth();
                const nowDay = now.getDate();
                const msgYear = msgDate.getFullYear();
                const msgMonth = msgDate.getMonth();
                const msgDay = msgDate.getDate();

                if (nowYear === msgYear && nowMonth === msgMonth && nowDay === msgDay) {
                    return `${String(msgDate.getHours()).padStart(2, '0')}:${String(msgDate.getMinutes()).padStart(2, '0')}`;
                }

                const yesterday = new Date(now);
                yesterday.setDate(nowDay - 1);
                if (msgYear === yesterday.getFullYear() && msgMonth === yesterday.getMonth() && msgDay === yesterday.getDate()) {
                    return `昨天`;
                }

                if (nowYear === msgYear) {
                    return `${msgMonth + 1}月${msgDay}日`;
                }

                return `${msgYear}/${msgMonth + 1}/${msgDay}`;
            };
            
            const navigateTo = async (page) => {
                const pageClasses = ['edit-contact-active', 'chat-view-active', 'chat-settings-active', 'main-settings-active', 'theme-settings-active', 'my-masks-active', 'edit-mask-active', 'mask-selection-active', 'api-config-active', 'data-management-active', 'favorites-active', 'wallet-active', 'wallet-details-active', 'worldbook-active', 'worldbook-binding-active', 'worldbook-edit-active'];
                pageClasses.forEach(cls => body.classList.remove(cls));
                
                if (page === 'chat-settings-active') {
                    await renderChatSettingsPage();
                }
                
                const mainTabs = ['messages', 'contacts', 'me'];
                if (mainTabs.includes(page)) {
                    body.setAttribute('data-main-tab', page);
                    document.querySelectorAll('.page').forEach(p => p.style.transform = '');
                } else if (page) {
                    body.removeAttribute('data-main-tab');
                    body.classList.add(page);
                } else {
                    body.setAttribute('data-main-tab', 'messages');
                    document.querySelectorAll('.page').forEach(p => p.style.transform = '');
                }

                document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
                const currentMainTab = body.getAttribute('data-main-tab');
                if (currentMainTab === 'contacts') tabContacts.classList.add('active');
                else if (currentMainTab === 'me') tabMe.classList.add('active');
                else if (currentMainTab === 'messages') tabMessages.classList.add('active');
            };
            
            const getDisplayName = (contact) => contact.remark || contact.name;

            const getUserData = async (userId) => {
                 if (userId === 'user') {
                    const profile = await db.userProfile.get('main');
                    return {
                        id: 'user',
                        name: profile?.name || '我',
                        avatar: profile?.avatar
                    }
                }
                const contact = await db.contacts.get({contactId: userId});
                if(contact) return { id: contact.id, contactId: contact.contactId, name: getDisplayName(contact), avatar: contact.avatar };

                const mask = await db.masks.get({maskId: userId});
                if(mask) return { id: mask.id, maskId: mask.maskId, name: mask.name, avatar: mask.avatar };

                return {name: '未知用户', avatar: null};
            };
            
            const generateTextAvatar = (name, contactId) => {
                const firstChar = name ? name.charAt(0).toUpperCase() : '?';
                const charCode = contactId ? contactId.charCodeAt(contactId.length - 1) : 0;
                const color = avatarColors[charCode % avatarColors.length];
                return `<div class="avatar" style="background-color: ${color};">${firstChar}</div>`;
            };

            const renderAvatar = (element, avatarData, defaultAvatarContent = '?') => {
                if (!element) return;
                
                if (avatarData && avatarData.url) {
                    element.style.backgroundImage = `url(${avatarData.url})`;
                    element.style.backgroundColor = 'transparent';
                    element.innerHTML = '';
                } else if (avatarData && avatarData.name) {
                    element.style.backgroundImage = '';
                    const firstChar = avatarData.name.charAt(0).toUpperCase();
                    const charCode = avatarData.id ? String(avatarData.id).charCodeAt(String(avatarData.id).length - 1) : 0;
                    const color = avatarColors[charCode % avatarColors.length];
                    element.style.backgroundColor = color;
                    element.textContent = firstChar;
                } else {
                     element.style.backgroundImage = '';
                     element.style.backgroundColor = '#ccc';
                     element.textContent = defaultAvatarContent;
                }
            };

            const setupImageUpload = (triggerEl, inputEl, storageKey) => {
                triggerEl.addEventListener('click', () => inputEl.click());
                inputEl.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const imageDataUrl = event.target.result;
                            triggerEl.style.backgroundImage = `url(${imageDataUrl})`;
                            const parentWidget = triggerEl.closest('.placeholder-widget, #custom-image-text-widget');
                            if (parentWidget) { parentWidget.classList.add('has-image'); }
                            await db.widgetData.put({ key: storageKey, value: imageDataUrl });
                            showToast('小组件图片已更新！');
                        };
                        reader.readAsDataURL(file);
                    } else if (file) {
                        showToast('请选择一个图片文件！', 'warning');
                    }
                });
            };

            const loadImageFromStorage = async (triggerEl, storageKey) => {
                const savedImage = await db.widgetData.get(storageKey);
                if (savedImage) {
                    triggerEl.style.backgroundImage = `url(${savedImage.value})`;
                    const parentWidget = triggerEl.closest('.placeholder-widget, #custom-image-text-widget');
                    if (parentWidget) { parentWidget.classList.add('has-image'); }
                }
            };

            const loadAllContacts = async () => {
                allContacts = await db.contacts.toArray();
            };
            
            const openContactEditor = (contact = null, returnPath = 'contacts') => {
                currentEditingContact = contact;
                contactEditorReturnPath = returnPath;
                tempAvatarDataUrl = contact ? contact.avatar : null;
                
                editContactTitle.textContent = contact ? '编辑设定' : '添加朋友';
                saveContactBtn.textContent = contact ? '完成' : '保存';
                
                contactNameInput.value = contact ? contact.name : '';
                contactGenderSelect.value = contact ? (contact.gender || '男') : '男';
                contactStoryTextarea.value = contact ? contact.story : '';
                
                const previewEl = document.getElementById('contact-avatar-preview');
                previewEl.style.backgroundImage = `url(${tempAvatarDataUrl || ''})`;
                previewEl.textContent = tempAvatarDataUrl ? '' : '点击上传';
                if (!tempAvatarDataUrl) {
                    previewEl.style.backgroundColor = '#E0E0E0';
                }
                
                [contactNameInput, contactStoryTextarea].forEach(input => input.classList.toggle('has-content', input.value.length > 0));
                
                saveContactBtn.disabled = false;
                navigateTo('edit-contact-active');
            };

            const saveContact = async () => {
                saveContactBtn.disabled = true;

                const name = contactNameInput.value.trim();
                if (!name) {
                    showToast('姓名不能为空', 'warning');
                    saveContactBtn.disabled = false;
                    return;
                }

                const contactData = {
                    name: name,
                    gender: contactGenderSelect.value,
                    story: contactStoryTextarea.value.trim(),
                    avatar: tempAvatarDataUrl,
                };
                
                try {
                    if (currentEditingContact) {
                        await db.contacts.update(currentEditingContact.id, contactData);
                        showToast('信息已更新');
                        await loadAllContacts(); 
                        if (chatHeaderTitle.textContent) {
                            const freshContact = allContacts.find(c => c.id === currentEditingContact.id);
                            chatHeaderTitle.textContent = getDisplayName(freshContact);
                        }
                    } else {
                        Object.assign(contactData, {
                            type: 'single',
                            members: [],
                            remark: '',
                            contactId: `ai_${Date.now()}`,
                            isPinned: false,
                            isTimeSensingEnabled: false,
                            lastMessageTimestamp: null,
                            lastMessageContent: '',
                            boundMaskId: null,
                            boundWorldBookFolders: [],
                            chatBackground: null,
                            lastAiThoughts: '',
                            lastAiAction: '',
                            lastAiClothing: '',
                            lastAiLocation: '',
                            walletBalance: 0,
                            chatSpecificAvatars: {},
                        });
                        await db.contacts.add(contactData);
                        showToast('好友已添加');
                        await loadAllContacts(); 
                    }

                    await renderContactsList();
                    await renderMainChatList();
                    navigateTo(contactEditorReturnPath);
                } catch (dbError) {
                    console.error("Database error on save:", dbError);
                    showToast('保存失败，请检查控制台信息', 'warning');
                    saveContactBtn.disabled = false;
                }
            };

            const loadChatHistory = async (contactId) => {
                const history = await db.chatHistories.get(contactId);
                if (history && Array.isArray(history.messages)) {
                    return history.messages;
                }
                return [];
            };
            const saveChatHistory = async (contactId, messages) => {
                await db.chatHistories.put({ contactId: contactId, messages: messages });
            };
            const loadApiSettings = async () => {
                const savedSettings = await db.settings.get('apiSettings');
                if (savedSettings) { settings = savedSettings.data; }
                baseUrlInput.value = settings.baseURL || '';
                apiKeyInput.value = settings.apiKey || '';
                baseUrlInput.classList.toggle('has-content', baseUrlInput.value.length > 0);
                apiKeyInput.classList.toggle('has-content', apiKeyInput.value.length > 0);
                modelSelect.innerHTML = '';
                if (settings.modelName) {
                    const option = document.createElement('option');
                    option.value = settings.modelName;
                    option.textContent = settings.modelName;
                    option.selected = true;
                    modelSelect.appendChild(option);
                }
                await loadApiPresets();
            };
            const saveApiSettings = async () => {
                settings.baseURL = baseUrlInput.value.trim();
                settings.apiKey = apiKeyInput.value.trim();
                settings.modelName = modelSelect.value;
                await db.settings.put({ key: 'apiSettings', data: settings });
                showToast('API 设置已保存并生效！');
                navigateTo('main-settings-active');
            };
            const loadApiPresets = async () => {
                const presetsData = await db.settings.get('apiPresets');
                const presets = presetsData ? presetsData.data : [];
                presetSelect.innerHTML = '<option value="">选择一个预设...</option>';
                presets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.name;
                    option.textContent = preset.name;
                    presetSelect.appendChild(option);
                });
            };
            const getPresets = async () => {
                const presetsData = await db.settings.get('apiPresets');
                return presetsData ? presetsData.data : [];
            };

            const renderMainChatList = async () => {
                const allContactsWithHistory = allContacts.filter(c => c.lastMessageTimestamp);
                
                const pinnedChats = allContactsWithHistory.filter(c => c.isPinned).sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);
                const unpinnedChats = allContactsWithHistory.filter(c => !c.isPinned).sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);
                
                const sortedChats = [...pinnedChats, ...unpinnedChats];

                wechatChatList.innerHTML = '';
                if (sortedChats.length === 0) {
                    wechatChatList.innerHTML = '<div style="text-align: center; color: #888; padding-top: 50px;">暂无消息，点击右上角+号发起聊天</div>';
                    return;
                }

                sortedChats.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'chat-list-item';
                    item.dataset.contactId = contact.contactId;
                    if (contact.isPinned) {
                        item.classList.add('pinned');
                    }
                    
                    const chatSpecificAvatars = contact.chatSpecificAvatars || {};
                    const aiAvatar = chatSpecificAvatars.assistant || contact.avatar;
                    const aiName = getDisplayName(contact);

                    let avatarHTML = '';
                    if (contact.type === 'group') {
                        avatarHTML = `<div class="chat-list-avatar" style="background-color: #ddd;">${defaultGroupAvatar}</div>`;
                    } else {
                        if (aiAvatar) {
                           avatarHTML = `<div class="chat-list-avatar avatar" style="background-image: url(${aiAvatar})"></div>`;
                        } else {
                           avatarHTML = generateTextAvatar(aiName, contact.contactId).replace('class="avatar"', 'class="chat-list-avatar avatar"');
                        }
                    }

                    let previewHTML = contact.lastMessageContent || '';
                    previewHTML = previewHTML.replace(/$$(红包|转账|语音|图片|聊天记录|代码片段|相册)$$/g, '[\$1] ');

                    item.innerHTML = `
                        ${avatarHTML}
                        <div class="chat-list-content">
                            <div class="chat-list-header">
                                <span class="chat-list-name">${aiName}</span>
                                <span class="chat-list-time">${formatTimestamp(contact.lastMessageTimestamp, 'list')}</span>
                            </div>
                            <div class="chat-list-preview">${previewHTML}</div>
                        </div>
                    `;
                    wechatChatList.appendChild(item);
                });
            };
            
            wechatChatList.addEventListener('click', async (e) => {
                const item = e.target.closest('.chat-list-item');
                if (item) {
                    const contactId = item.dataset.contactId;
                    openChatWith(contactId);
                }
            });

            const renderContactsList = async () => {
                const singleContacts = allContacts.filter(c => c.type === 'single').sort((a, b) => (getDisplayName(a)).localeCompare(getDisplayName(b), 'zh-CN'));
                contactsList.innerHTML = '';
                if (singleContacts.length === 0) {
                    contactsList.innerHTML = '<div style="text-align: center; color: #888; padding-top: 50px;">通讯录为空，快去添加好友吧</div>';
                } else {
                    let groupContactsHTML = '';
                    const groupContacts = allContacts.filter(c => c.type === 'group');
                    if (groupContacts.length > 0) {
                        groupContactsHTML += `
                            <div class="contact-item" data-group-header="true">
                                <div class="contact-avatar" style="background-color: #F7C343;">${defaultGroupAvatar}</div>
                                <div class="contact-name">群聊</div>
                            </div>
                        `;
                    }
                    
                    contactsList.innerHTML = groupContactsHTML;
                    
                    singleContacts.forEach(contact => {
                        const item = document.createElement('div');
                        item.className = 'contact-item';
                        item.dataset.contactId = contact.contactId;
                        
                        const displayName = getDisplayName(contact);
                        let avatarHTML = '';
                        if (contact.avatar) {
                            avatarHTML = `<div class="contact-avatar" style="background-image: url(${contact.avatar})"></div>`;
                        } else {
                            avatarHTML = generateTextAvatar(displayName, contact.contactId).replace('class="avatar"', 'class="contact-avatar avatar"');
                        }

                        item.innerHTML =`
                            ${avatarHTML}
                            <div class="contact-name">${displayName}</div>
                        `;
                        contactsList.appendChild(item);
                    });
                }
            };
            
            contactsList.addEventListener('click', async (e) => {
                const item = e.target.closest('.contact-item');
                if (!item) return;

                if (item.dataset.groupHeader) {
                    showToast('群聊列表功能正在开发中...');
                    return;
                }

                const contactId = item.dataset.contactId;
                const contact = allContacts.find(c => c.contactId === contactId);
                if(contact) {
                    const { action } = await showCustomModal({
                        title: getDisplayName(contact),
                        message: '选择操作',
                        buttons: [
                            { id: 'send-message', text: '发送消息', class: 'confirm' },
                            { id: 'edit-info', text: '编辑设定' },
                            { id: 'cancel', text: '取消' }
                        ],
                        buttonLayout: 'column'
                    });

                    if (action === 'send-message') {
                        openChatWith(contactId);
                    } else if (action === 'edit-info') {
                        openContactEditor(contact, 'contacts');
                    }
                }
            });

            addNewContactBtn.addEventListener('click', () => {
                openContactEditor(null, 'contacts');
            });

            const updateUserAvatarsInChat = async () => {
                if (!currentChatContactId) return;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                if (!contact) return;
                
                const chatSpecificAvatars = contact.chatSpecificAvatars || {};
                
                let userAvatarUrl = chatSpecificAvatars.user;
                let userName;
                if (!userAvatarUrl) {
                    if (contact.boundMaskId) {
                        const mask = await db.masks.get({maskId: contact.boundMaskId});
                        if (mask) {
                            userAvatarUrl = mask.avatar;
                            userName = mask.name;
                        }
                    }
                }
                if (!userAvatarUrl) {
                    const userProfile = await db.userProfile.get('main');
                    userAvatarUrl = userProfile?.avatar;
                    userName = userProfile?.name || '我';
                }

                const userAvatarEls = document.querySelectorAll('.user-avatar-in-chat');
                userAvatarEls.forEach(avatarEl => {
                    renderAvatar(avatarEl, { url: userAvatarUrl, name: userName, id: 'user' });
                });
                
                const aiAvatarUrl = chatSpecificAvatars.assistant || contact.avatar;
                const aiAvatarEls = document.querySelectorAll('.ai-avatar');
                aiAvatarEls.forEach(avatarEl => {
                     renderAvatar(avatarEl, { url: aiAvatarUrl, name: getDisplayName(contact), id: contact.contactId });
                });
            };

            const renderChatMessages = async (contactId) => {
                const contact = await db.contacts.get({contactId: contactId});
                if (!contact) return;

                const history = await loadChatHistory(contactId);
                chatMessages.innerHTML = '';
                const fragment = document.createDocumentFragment();

                if (history.length === 0) {
                    const startPrompt = document.createElement('div');
                    startPrompt.className = 'chat-start-prompt';
                    startPrompt.textContent = `开始和 ${getDisplayName(contact)} 聊天吧~`;
                    fragment.appendChild(startPrompt);
                } else {
                    for (const msg of history) {
                        let msgEl;
                        if (msg.isRecalled) {
                            msgEl = await createRecalledMessageElement(msg);
                        } else if (msg.type === 'system') {
                             msgEl = createSystemNotificationElement(msg.content);
                        } else {
                            msgEl = await createMessageTurn(msg);
                        }
                        fragment.appendChild(msgEl);
                    }
                }
                
                chatMessages.appendChild(fragment);
                await updateUserAvatarsInChat();
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            const createSystemNotificationElement = (text) => {
                const el = document.createElement('div');
                el.className = 'system-notification';
                el.innerHTML = text;
                return el;
            };

            const createMessageTurn = async (msg) => {
                const turnEl = document.createElement('div');
                turnEl.className = `message-turn ${msg.role}`;
                turnEl.dataset.sender = msg.role;

                let avatarHTML;
                if (msg.role === 'assistant') {
                    avatarHTML = `<div class="avatar ai-avatar"></div>`;
                } else {
                    avatarHTML = `<div class="avatar user-avatar-in-chat"></div>`;
                }
                
                const turnContentEl = document.createElement('div');
                turnContentEl.className = 'message-turn-content-wrapper';
                
                const bubbleEl = await createMessageBubble(msg);
                turnContentEl.appendChild(bubbleEl);

                if (msg.type === 'voice' && voiceTextVisible.has(bubbleEl)) {
                    const textEl = document.createElement('div');
                    textEl.className = 'voice-transcription';
                    textEl.innerHTML = msg.content.replace(/\n/g, '<br>');
                    turnContentEl.appendChild(textEl);
                }

                turnEl.innerHTML = `
                    <div class="avatar-wrapper">
                        ${avatarHTML}
                        <div class="avatar-time">${formatTimestamp(msg.timestamp, 'message')}</div>
                    </div>
                `;
                turnEl.appendChild(turnContentEl);
                return turnEl;
            };

            const createMessageBubble = async (msg) => {
                const bubbleEl = document.createElement('div');
                bubbleEl.className = 'message-bubble';
                bubbleEl.dataset.messageId = msg.messageId;

                const addLongPressListener = (element) => {
                    element.addEventListener('mousedown', (e) => {
                        if (isMultiSelectMode) return;
                        if (e.button !== 0) return;
                        clearTimeout(longPressTimer);
                        longPressTimer = setTimeout(() => showContextMenu(e, bubbleEl), 500);
                    });
                    element.addEventListener('mouseup', () => clearTimeout(longPressTimer));
                    element.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
                    element.addEventListener('touchstart', (e) => {
                        if (isMultiSelectMode) return;
                        clearTimeout(longPressTimer);
                        longPressTimer = setTimeout(() => { e.preventDefault(); showContextMenu(e, bubbleEl); }, 500);
                    }, { passive: false });
                    element.addEventListener('touchend', () => clearTimeout(longPressTimer));
                    element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                };

                let messageElement;
                if (msg.type === 'merged') {
                    messageElement = createMergedForwardElement(msg);
                } else if (msg.type === 'red-packet') {
                    messageElement = await createRedPacketElement(msg);
                } else if (msg.type === 'transfer') {
                    messageElement = await createTransferElement(msg);
                } else if (msg.type === 'voice') {
                    messageElement = createVoiceMessageElement(msg);
                } else if (msg.type === 'described-image') {
                    messageElement = createDescribedImageElement(msg);
                } else if (msg.type === 'html') {
                    messageElement = createHtmlMessageElement(msg);
                } else if (msg.type === 'image') {
                    messageElement = createImageMessageElement(msg);
                } else {
                    messageElement = createTextMessageElement(msg);
                }
                
                if (msg.type === 'red-packet' || msg.type === 'transfer') {
                    messageElement.addEventListener('click', () => handleFinancialMessageClick(messageElement, msg));
                } else if (msg.type === 'voice') {
                    messageElement.addEventListener('click', () => toggleVoiceText(bubbleEl));
                }
                
                addLongPressListener(messageElement);
                bubbleEl.appendChild(messageElement);
                
                return bubbleEl;
            };

            const addMessageToUI = async (messageObject, isSystem = false) => {
                if (!currentChatContactId) return;
                
                if (isSystem) {
                    messageObject.type = 'system';
                }

                const history = await loadChatHistory(currentChatContactId);
                history.push(messageObject);
                await saveChatHistory(currentChatContactId, history);
                
                await updateLastMessage(currentChatContactId, messageObject);
                
                const startPrompt = chatMessages.querySelector('.chat-start-prompt');
                if (startPrompt) startPrompt.remove();
                
                let msgEl;
                if (isSystem) {
                    msgEl = createSystemNotificationElement(messageObject.content);
                } else {
                    msgEl = await createMessageTurn(messageObject);
                }
                chatMessages.appendChild(msgEl);

                await updateUserAvatarsInChat();
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const renderChatSettingsPage = async () => {
                if (!currentChatContactId) return;
                
                const contact = await db.contacts.get({contactId: currentChatContactId});
                if (!contact) {
                    showToast("联系人数据异常", "warning");
                    navigateTo('messages');
                    return;
                }
                
                const chatSpecificAvatars = contact.chatSpecificAvatars || {};
                const aiAvatarUrl = chatSpecificAvatars.assistant || contact.avatar;
                renderAvatar(chatSettingsAvatar, { url: aiAvatarUrl, name: getDisplayName(contact), id: contact.contactId });

                chatSettingsName.textContent = getDisplayName(contact);
                pinChatToggle.checked = contact.isPinned;
                timeSensingToggle.checked = !!contact.isTimeSensingEnabled;
                
                if (contact.boundMaskId) {
                    const mask = await db.masks.get({maskId: contact.boundMaskId});
                    boundMaskName.textContent = mask ? mask.name : '已失效';
                } else {
                    boundMaskName.textContent = '未绑定';
                }

                const boundFoldersCount = contact.boundWorldBookFolders?.length || 0;
                if (boundFoldersCount > 0) {
                    boundWorldbookValue.textContent = `已绑定 ${boundFoldersCount} 项`;
                } else {
                    boundWorldbookValue.textContent = '未绑定';
                }
            };

            const updateLastMessage = async (contactId, msg) => {
                const timestamp = Date.now();
                let previewContent = '';
                const contact = await db.contacts.get({contactId: contactId});
                if (!contact) return;

                if (msg.isRecalled) {
                    const recalledByName = msg.recalledBy === 'user' ? '你' : getDisplayName(contact);
                    previewContent = `[${recalledByName}撤回了一条消息]`;
                } else if (msg.type === 'red-packet') previewContent = '[红包]';
                else if (msg.type === 'transfer') previewContent = '[转账]';
                else if (msg.type === 'voice') previewContent = '[语音]';
                else if (msg.type === 'image') previewContent = '[相册]';
                else if (msg.type === 'described-image') previewContent = '[图片]';
                else if (msg.type === 'merged') previewContent = '[聊天记录]';
                else if (msg.type === 'html') previewContent = '[代码片段]';
                else if (typeof msg.content === 'string') previewContent = msg.content.substring(0, 50);
                
                await db.contacts.where('contactId').equals(contactId).modify({
                    lastMessageTimestamp: timestamp,
                    lastMessageContent: previewContent
                });
                await loadAllContacts();
                await renderMainChatList();
            };

            const openChatWith = async (contactId) => {
                const contact = await db.contacts.get({contactId: contactId});
                if (!contact) {
                    showToast("错误：无效的联系人数据！", "warning");
                    return;
                }
                body.classList.remove('app-is-closed');
                currentChatContactId = contact.contactId;
                exitMultiSelectMode();
                clearReply();
                
                aiStatusThoughts.textContent = contact.lastAiThoughts || '(暂无)';
                aiStatusAction.textContent = contact.lastAiAction || '(暂无)';
                aiStatusClothing.textContent = contact.lastAiClothing || '(暂无)';
                aiStatusLocation.textContent = contact.lastAiLocation || '(暂无)';
                aiStatusModal.querySelector('h3').textContent = `${getDisplayName(contact)}的状态`;

                chatHeaderTitle.textContent = getDisplayName(contact);
                
                if (contact.chatBackground) {
                    chatMessages.style.backgroundImage = `url(${contact.chatBackground})`;
                } else {
                    chatMessages.style.backgroundImage = ``;
                    chatMessages.style.backgroundColor = '#EDEDED';
                }
                
                navigateTo('chat-view-active');
                
                messageInput.disabled = false;
                generateBtn.disabled = false;
                sendBtn.disabled = false;
                moreActionsBtn.disabled = false;

                chatMessages.innerHTML = `<div class="loading-spinner-container"><div class="loading-spinner"></div></div>`;
                await renderChatMessages(contact.contactId);
            };

            const createTextMessageElement = (msg) => {
                const contentEl = document.createElement('div');
                contentEl.className = 'message-content';

                let replyPreviewHTML = '';
                const quoteData = msg.aiQuote || msg.replyTo;
                if (quoteData) {
                    replyPreviewHTML = `
                        <div class="message-reply-preview">
                            <strong>${quoteData.sender}</strong>
                            <div>${quoteData.content}</div>
                        </div>
                    `;
                }
                
                contentEl.innerHTML = `${replyPreviewHTML}${msg.content.replace(/\n/g, '<br>')}`;
                return contentEl;
            };

            const createHtmlMessageElement = (msg) => {
                const contentEl = document.createElement('div');
                contentEl.className = 'html-message-content';
            
                const iframe = document.createElement('iframe');
                iframe.sandbox = 'allow-scripts';
                contentEl.appendChild(iframe);
                
                setTimeout(() => {
                    if(!iframe.contentWindow) return; // a small guard
                    const doc = iframe.contentWindow.document;
                    doc.open();
                    doc.write(`
                        <style>
                            body { 
                                margin: 0; 
                                font-family: -apple-system, "Helvetica Neue", "PingFang SC", sans-serif; 
                                font-size: 13px;
                                line-height: 1.4; 
                            }
                            * { box-sizing: border-box; }
                        </style>
                        ${msg.content}
                    `);
                    doc.close();
                    
                    const setIframeHeight = () => {
                        try {
                            const contentHeight = doc.body.scrollHeight;
                            iframe.style.height = contentHeight + 'px';
                        } catch(e) {
                            console.warn("Could not access iframe content for height calculation, possibly due to cross-origin policies.", e);
                        }
                    };

                    setIframeHeight();
                    const resizeObserver = new ResizeObserver(setIframeHeight);
                    resizeObserver.observe(doc.body);
                    
                }, 100);

                return contentEl;
            };
            
            const createDescribedImageElement = (msg) => {
                const imgBubble = document.createElement('div');
                imgBubble.className = 'described-image-bubble';
                imgBubble.innerHTML = `<div class="described-image-text">${msg.content.replace(/\n/g, '<br>')}</div>`;

                imgBubble.addEventListener('click', (e) => {
                    e.stopPropagation();
                    imgBubble.classList.toggle('show-text');
                });
                return imgBubble;
            };

            const createImageMessageElement = (msg) => {
                const contentEl = document.createElement('div');
                contentEl.className = 'image-message-content';
                const img = document.createElement('img');
                img.src = msg.imageUrl;
                contentEl.appendChild(img);
                return contentEl;
            };

            const createMergedForwardElement = (msg) => {
                const headerText = `与 ${msg.content.from} 的聊天记录`;
                const contentPreview = msg.content.messages.map(m => `${m.sender}: ${m.content}`).join('\n');

                const mergedEl = document.createElement('div');
                mergedEl.className = 'merged-forward-message';
                mergedEl.innerHTML = `
                    <div class="merged-forward-header">${headerText}</div>
                    <div class="merged-forward-content">${contentPreview.replace(/\n/g, '<br>')}</div>
                `;
                
                mergedEl.addEventListener('click', async () => {
                    let modalContent = `<h3>${headerText}</h3><hr style="margin: 10px 0;">`;
                    msg.content.messages.forEach(m => {
                        modalContent += `<p><strong>${m.sender}:</strong> ${m.content.replace(/\n/g, '<br>')}</p>`;
                    });
                    await showCustomModal({
                        title: '聊天记录',
                        rawHTML: modalContent,
                        buttons: [{id: 'close', text: '关闭', class: 'confirm'}]
                    });
                });

                return mergedEl;
            };

            const createRecalledMessageElement = async (msg) => {
                const el = document.createElement('div');
                el.className = 'recalled-message';
                
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const recalledByName = msg.recalledBy === 'user' ? '你' : getDisplayName(contact);
                
                el.innerHTML = `${recalledByName}撤回了一条消息 <span data-recalled-content="${encodeURIComponent(JSON.stringify(msg.content))}">查看</span>`;
                el.querySelector('span').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const recalledContentRaw = decodeURIComponent(e.target.dataset.recalledContent);
                    try {
                        let contentToShow = '';
                        const recalledContent = JSON.parse(recalledContentRaw);

                        if(recalledContent.type === 'red-packet') contentToShow = `[红包] ${recalledContent.redPacket.text}`;
                        else if (recalledContent.type === 'transfer') contentToShow = `[转账] ¥${recalledContent.transfer.amount.toFixed(2)}`;
                        else if (recalledContent.type === 'voice') contentToShow = `[语音] ${recalledContent.content}`;
                        else if (recalledContent.type === 'image') contentToShow = `[相册] 图片消息无法预览`;
                        else if (recalledContent.type === 'described-image') contentToShow = `[图片] ${recalledContent.content}`;
                        else if (recalledContent.type === 'html') contentToShow = `[代码片段]\n\n(代码内容较长，无法预览)`;
                        else contentToShow = recalledContent.content || recalledContentRaw;

                        await showCustomModal({ title: '被撤回的消息', message: contentToShow, buttons: [{id: 'ok', text: '好', class: 'confirm'}] });
                    } catch(err) {
                        await showCustomModal({ title: '被撤回的消息', message: recalledContentRaw, buttons: [{id: 'ok', text: '好', class: 'confirm'}] });
                    }
                });
                
                return el;
            };


            const showLoading = (isGenerating) => {
                if (isGenerating) {
                    dynamicIsland.classList.add('expanded');
                } else {
                    dynamicIsland.classList.remove('expanded');
                }
                let indicator = document.getElementById('loading-indicator');
                if (isGenerating && !indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'loading-indicator';
                    indicator.classList.add('loading-indicator');
                    indicator.textContent = '对方正在输入...';
                    chatMessages.appendChild(indicator);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else if (!isGenerating && indicator) {
                    indicator.remove();
                }
            };
            
            const splitMessageIntoChunks = (messageText) => {
                if (!messageText) return [];
                const lines = messageText.split('\n');
                const finalChunks = lines.flatMap(line => {
                    if (line.trim() === '') return [];
                    const parts = line.match(/(\(.*?\))|([^.?!。？！…~()]+[.?!。？！…~()]*)/g) || [];
                    return parts.map(p => p.trim()).filter(p => p);
                });
                return finalChunks;
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const generateResponse = async () => {
                if (!currentChatContactId) { showToast('没有聊天对象'); return; }
                const contact = await db.contacts.get({contactId: currentChatContactId});
                if (!contact) { showToast('无法加载聊天对象数据'); return; }

                const { baseURL, apiKey, modelName } = settings;
                if (!baseURL || !apiKey || !modelName) { 
                    showToast('请先在主屏幕的 ⚙️ 设置中完成 API 配置！', 'warning'); 
                    returnToHomeScreen();
                    return; 
                }
                generateBtn.disabled = true;
                sendBtn.disabled = true;
                showLoading(true);

                try {
                    const characterName = contact.name;
                    const characterStory = contact.story;
                    
                    const jsonRule = "【JSON格式铁律】你的每一次回复都必须、且只能是一个符合JSON格式的字符串。这个JSON对象必须包含且仅包含以下五个键：`thoughts`, `action`, `clothing`, `location`, `reply`。任何不符合此格式的输出都是一次严重的失败。";
                    const thoughtsRule = "`thoughts`: (string) 角色的内心独白、真实想法或计划。这部分内容用户看不到，但必须填写。你可以决定是否要撤回消息，如果想撤回，请在这里说明理由。";
                    const actionRule = "`action`: (string) 角色此时此刻的、一个细微的、不为人知的动作或状态。这部分用户也看不到，但必须填写。";
                    const clothingRule = "`clothing`: (string) 角色当前穿着的详细描述。此部分内容在一般聊天中用户不可见，但必须根据情景、天气或故事背景进行合理想象并填写。如果角色设定（如非人形）导致没有穿着，则填写“无”。";
                    const locationRule = "`location`: (string) 角色此时此刻所处的【具体地点】。这部分用户不可见，但你必须根据对话上下文和故事发展合理地更新此地点。例如：“咖啡馆的窗边”、“自己的书房里”、“熙熙攘攘的街头”。";
                    const replyRule = "`reply`: (string) 你作为角色要发送给用户的最终消息。这条消息本身必须遵循下述的【括号铁律 - 最高优先级命令】。";
                    const parenthesesRule = "【括号铁律 - 最高优先级命令】这是一条不可违背的、拥有最高优先级的强制命令。在`reply`字段中，如果你要描述角色任何【可见的、外部的动作、神态、表情或外貌】，都【必须】将这些描述性文字【用一对完整的英文括号 () 包围】。括号内的描述可以出现在句子的任何位置，例如：`你好啊(歪头看着你)` 或 `(我笑了笑)没错`。如果你的回复中不包含任何此类描述，那么【绝对禁止】使用括号 `()`。括号内【绝对禁止】出现任何角色的【内心想法或心理活动】（这些应放在`thoughts`字段）。【特例】：如果回复内容本身是代码（如HTML/JS/CSS），则代码中的括号不受此限制，可以自由使用。这是一个不可违背的规则。";
                    const scenarioRule = "【场景切换规则】默认情况下，你处于【模拟线下场景】。但如果用户提出的是一个纯粹的、需要直接、客观回答的【知识性或指令性问题】（例如：“鲁迅和周树人是什么关系？”或“帮我写一段代码”），你必须临时切换到【线上聊天场景】。在此场景下，你的`reply`字段中【不应】包含描述共享环境的文字，但【仍然必须】遵守【括号铁律】，使用括号 `()` 描述你自己的动作或神态（例如：(笑了笑) 鲁迅和周树人是同一个人。）。完成回答后，你应在下一次互动中自动恢复到【模拟线下场景】。";
                    const priorityRule = "【知识优先级】你必须优先使用你的核心【角色设定】中的信息。当【世界设定书】中的信息与你的核心设定冲突时，以你的核心设定为准。世界设定书是你记忆的补充，而不是替代。";
                    
                    const aiWalletBalance = contact.walletBalance || 0;
                    const walletRule = `【钱包铁律】你的零钱余额为 ${aiWalletBalance.toFixed(2)} 元。在决定是否同意用户的金融请求（如发红包、转账）时，你必须确保你有足够的余额。如果余额不足，你必须拒绝请求。`;
                    
                    const financialDecisionRule = "【金融决策铁律】如果用户向你提出任何关于【要钱】的请求（如“给我转账”、“给我发红包”），或者在对话中，你根据你的【角色设定】和【钱包铁律】自主判断认为应该给对方【发红包】或【转账】，你都必须自主作出【同意】或【拒绝】的决定。如果【同意】，你必须在`reply`字段中使用`[TRANSFER:金额,留言]`或`[RED_PACKET:金额,祝福语]`指令来完成操作。如果【拒绝】，则正常回复即可。";
                    const commandRule = "【特殊指令】如果想实现特殊操作，必须在`reply`字段中插入如下指令：引用=`[QUOTE:你想引用的内容]`；发语音=`[VOICE:语音的文字内容]`；发图片=`[IMAGE:图片的文字描述]`；发红包=`[RED_PACKET:总金额,祝福语]`；转账=`[TRANSFER:金额,留言]`；退还转账=`[REFUND_TRANSFER]`；【撤回上一条消息】=`[RECALL]`（你可以自主决定是否使用此指令，比如当你觉得上一句话不妥时）；发网页/代码=`[HTML:你的完整HTML代码]`。指令必须精确，不能有任何多余字符。";
                    const userBehaviorRule = "【用户行为铁律】你绝对禁止杜撰、扮演或描述任何属于对方的行为、语言或心理活动。你必须用'你'或对方的名字来称呼对方，绝对禁止使用'用户'这个词。";
                    const emojiBanRule = "【表情包禁止】你绝对禁止在回复中使用任何形式的 emoji 表情符号。";

                    let timeInstruction = '';
                    if (contact.isTimeSensingEnabled) {
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                        const dateString = now.toLocaleDateString('zh-CN');
                        const dayOfWeek = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()];
                        timeInstruction = `【时间感应铁律】当前真实时间是 ${dateString} ${dayOfWeek} ${timeString}。你必须在对话中自然地体现出对当前时间的感知。例如：如果是早上，可以问候“早上好”；如果是深夜，可以提醒对方“夜深了，早点休息”。你必须将此信息作为绝对真实的环境变量，并自然地融入到你的角色扮演中。`;
                    }
                    
                    const example = `【JSON格式示例】:
\`\`\`json
{
  "thoughts": "他好像对我的过去很感兴趣，我应该透露一点，但不能太多，保持神秘感。",
  "action": "指尖无意识地划过手机屏幕的边缘。",
  "clothing": "穿着一件简约的白色T恤和浅蓝色牛仔裤，看起来很清爽。",
  "location": "市图书馆三楼靠窗的座位",
  "reply": "(我看到你发的消息，稍微歪了歪头) 以前的事啊...说来话长了。你为什么对这个好奇呢？"
}
\`\`\``;

                    const aiInstruction = `【你的身份】你的名字是：${characterName}。你的性格和记忆是：『${characterStory || '一个友好健谈的朋友'}』。你必须完全沉浸在这个角色里，绝不能暴露你是AI模型。`;

                    let worldBookInstruction = '';
                    const boundFolderIds = contact.boundWorldBookFolders || [];
                    if (boundFolderIds.length > 0) {
                        const allFiles = await db.worldBook.where('type').equals('file').toArray();
                        const relevantFiles = allFiles.filter(file => file.folderId !== null && boundFolderIds.includes(file.folderId));

                        if (relevantFiles.length > 0) {
                            const allFolders = await db.worldBook.where('type').equals('folder').toArray();
                            const folderMap = allFolders.reduce((acc, folder) => { acc[folder.id] = folder.name; return acc; }, {});

                            let worldBookContent = "";
                            const filesByFolder = relevantFiles.reduce((acc, file) => {
                                const folderIdKey = file.folderId;
                                if (!acc[folderIdKey]) acc[folderIdKey] = [];
                                acc[folderIdKey].push(file);
                                return acc;
                            }, {});

                            for(const folderId in filesByFolder) {
                                if (folderMap[folderId]) {
                                    worldBookContent += `文件夹：${folderMap[folderId]}\n`;
                                    filesByFolder[folderId].forEach(file => {
                                        worldBookContent += `    文件：${file.name}\n    内容：『${file.content}』\n`;
                                    });
                                    worldBookContent += '\n';
                                }
                            }
                            worldBookInstruction = `【世界设定书 - 你的记忆】以下是你所处世界的背景知识和设定。你必须将这些信息视为你自己的记忆和常识，并从你【${characterName}】的角色视角出发，自然地在对话中运用它们。你不是一个查询机器人，而是以【${characterName}】的身份，结合这些知识与对方聊天。你必须严格遵守以下设定：\n\n${worldBookContent}`;
                        }
                    }
                    
                    let userInstruction = '';
                    if (contact.boundMaskId) {
                        const userMask = await db.masks.get({maskId: contact.boundMaskId});
                        if (userMask && userMask.name && userMask.story) {
                            userInstruction = `【对话者角色设定】你正在与一个叫【${userMask.name}】的人对话，TA的角色设定是：『${userMask.story}』。你要将TA视为这个角色进行互动，并用【你】或【${userMask.name}】来称呼对方。`;
                        }
                    }

                    const history = await loadChatHistory(contact.contactId);
                    const filteredHistory = history.filter(msg => !msg.isRecalled && msg.type !== 'system');
                    
                    const finalInstruction = [jsonRule, parenthesesRule, timeInstruction, walletRule, thoughtsRule, actionRule, clothingRule, locationRule, replyRule, scenarioRule, financialDecisionRule, priorityRule, commandRule, emojiBanRule, userBehaviorRule, example, aiInstruction, worldBookInstruction, userInstruction].filter(Boolean).join('\n\n');
                    
                    const isVisionModel = modelName.includes('vision') || modelName.includes('v');
                    
                    const primingMessages = [
                        { role: 'user', content: finalInstruction },
                        { role: 'assistant', content: "```json\n{\n  \"thoughts\": \"指令已收到并完全理解。我将作为角色开始对话，并严格遵守所有规则，尤其是钱包、括号和用户角色设定铁律。\",\n  \"action\": \"准备就绪\",\n  \"clothing\": \"无\",\n  \"location\": \"未知\",\n  \"reply\": \"(我准备好了，随时可以开始聊天。)\"\n}\n```" }
                    ];
                    
                    const messagesForAPI = [
                        ...primingMessages, 
                        ...filteredHistory.map(m => {
                            const sender = m.role === 'user' ? 'user' : 'assistant';
                            let apiContent;
                            let fullContent;

                            if (m.replyTo) {
                                fullContent = `(回复 ${m.replyTo.sender}: "${m.replyTo.content}") ${m.content}`;
                            } else if (m.aiQuote) {
                                fullContent = `(引用 ${m.aiQuote.sender}: "${m.aiQuote.content}") ${m.content}`;
                            } else {
                                fullContent = m.content;
                            }
                            
                            if (isVisionModel && m.type === 'image') {
                                apiContent = [{ type: "text", text: `[${sender}发送了一张图片]` }, { type: "image_url", image_url: { url: m.imageUrl } }];
                                if (m.replyTo) {
                                    apiContent[0].text += ` (回复 ${m.replyTo.sender}: "${m.replyTo.content}")`;
                                }
                            } else if (m.type === 'image') {
                                apiContent = `[${sender}发送了一张图片，但我无法查看。]`;
                            } else if(m.type === 'red-packet') {
                                let stateText = '';
                                const openedCount = (m.redPacket.openers || []).length;
                                if (openedCount === m.redPacket.count) stateText = ' (已领完)';
                                else if (openedCount > 0) stateText = ` (已领取 ${openedCount}/${m.redPacket.count})`;
                                else if (m.redPacket.status === 'refunded') stateText = ' (已退还)';
                                apiContent = `[${sender}发送了一个红包: ${m.redPacket.text}, 金额: ${m.redPacket.totalAmount.toFixed(2)}]${stateText}`;
                            } else if (m.type === 'transfer') {
                                let stateText = '';
                                if (m.transfer.received === true) stateText = ' (已收款)';
                                else if (m.transfer.received === 'refunded') stateText = ' (已退还)';
                                apiContent = `[${sender}进行了一笔转账: ${m.transfer.text}, 金额: ${m.transfer.amount.toFixed(2)}]${stateText}`;
                            } else if (m.type === 'voice') apiContent = `[${sender}发送了一段语音: ${fullContent}]`;
                            else if (m.type === 'described-image') apiContent = `[${sender}发送了一张图片: ${fullContent}]`;
                            else if (m.type === 'html') apiContent = `[${sender}发送了一段代码片段]`;
                            else apiContent = fullContent;
                            
                            return { role: m.role, content: apiContent };
                        })
                    ];
                    
                    const requestBody = { model: modelName, messages: messagesForAPI, stream: false };
                    if (isVisionModel) {
                        requestBody.max_tokens = 4096;
                    }

                    const response = await fetch(`${baseURL}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) { 
                        const errorData = await response.json().catch(() => ({ error: { message: '无法解析错误响应' } }));
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message}`); 
                    }
                    const data = await response.json();
                    let assistantResponseText = data.choices[0].message.content;

                    let replyText, thoughts, action, clothing, location;
                    try {
                        const jsonMatch = assistantResponseText.match(/```json\s*([\s\S]*?)\s*```/);
                        const jsonString = jsonMatch ? jsonMatch[1] : assistantResponseText;
                        const parsed = JSON.parse(jsonString);
                        replyText = parsed.reply || '';
                        thoughts = parsed.thoughts || '(AI未提供想法)';
                        action = parsed.action || '(AI未提供动作)';
                        clothing = parsed.clothing || '(AI未提供穿着信息)';
                        location = parsed.location || '(AI未提供位置)';
                    } catch(e) {
                        replyText = assistantResponseText;
                        thoughts = '(AI未能提供内心活动，可能为临时性错误)';
                        action = '(无)';
                        clothing = '(无)';
                        location = '(无)';
                        console.error("Failed to parse AI JSON response:", e, "Raw response:", assistantResponseText);
                    }
                    
                    await db.contacts.update(contact.id, {
                        lastAiThoughts: thoughts,
                        lastAiAction: action,
                        lastAiClothing: clothing,
                        lastAiLocation: location,
                    });
                    
                    aiStatusThoughts.textContent = thoughts;
                    aiStatusAction.textContent = action;
                    aiStatusClothing.textContent = clothing;
                    aiStatusLocation.textContent = location;

                    if (/\[RECALL\]/.test(replyText)) {
                        replyText = replyText.replace(/\[RECALL\]\s*/g, '');
                        await recallLastAiMessage();
                    }

                    if (/\[REFUND_TRANSFER\]/.test(replyText)) {
                        replyText = replyText.replace(/\[REFUND_TRANSFER\]\s*/g, '');
                        const fullHistory = await loadChatHistory(contact.contactId);
                        let refunded = false;
                        for (let i = fullHistory.length - 1; i >= 0; i--) {
                            const msg = fullHistory[i];
                            if (msg.role === 'user' && msg.type === 'transfer' && msg.transfer.received === false) {
                                msg.transfer.received = 'refunded';
                                await updateFinancialMessage(msg);
                                refunded = true;
                                break;
                            }
                        }
                        if (refunded) {
                            showToast(`${getDisplayName(contact)} 退回了你的转账`);
                            await sleep(300);
                        }
                    }

                    const quoteRegex = /\[QUOTE:(.*?)\]/s;
                    let aiQuoteContent = null;
                    const quoteMatch = replyText.match(quoteRegex);
                    if (quoteMatch) {
                        aiQuoteContent = quoteMatch[1].trim();
                        replyText = replyText.replace(quoteRegex, '').trim();
                    }
                    
                    const combinedRegex = /(\[VOICE:(.*?)\])|(\[RED_PACKET:([^,\]]+),([^,\]]*)\])|(\[TRANSFER:([^,\]]+),([^,\]]*)\])|(\[IMAGE:(.*?)\])|(\[HTML:([\s\S]*?)\])/g;

                    let lastIndex = 0;
                    const processQueue = [];
                    const cleanReplyText = replyText;

                    cleanReplyText.replace(combinedRegex, (match, voiceFull, voiceContent, rpFull, rpAmount, rpText, trFull, trAmount, trText, imgFull, imgDesc, htmlFull, htmlContent, offset) => {
                        if (offset > lastIndex) {
                            processQueue.push({ type: 'text', content: cleanReplyText.substring(lastIndex, offset).trim() });
                        }
                        if (voiceFull) {
                            processQueue.push({ type: 'voice', content: (voiceContent || '').trim() });
                        } else if (rpFull) {
                            processQueue.push({ type: 'red-packet', amount: parseFloat(rpAmount) || 0, text: (rpText || '').trim() });
                        } else if (trFull) {
                             processQueue.push({ type: 'transfer', amount: parseFloat(trAmount) || 0, text: (trText || '').trim() });
                        } else if (imgFull) {
                             processQueue.push({ type: 'described-image', content: (imgDesc || '').trim() });
                        } else if (htmlFull) {
                            processQueue.push({ type: 'html', content: (htmlContent || '').trim() });
                        }
                        lastIndex = offset + match.length;
                        return match;
                    });

                    if (lastIndex < cleanReplyText.length) {
                        processQueue.push({ type: 'text', content: cleanReplyText.substring(lastIndex).trim() });
                    }
                    
                    if (processQueue.length === 0 && cleanReplyText) {
                       processQueue.push({ type: 'text', content: cleanReplyText });
                    }

                    for (let i = 0; i < processQueue.length; i++) {
                        const item = processQueue[i];
                        if (item.type === 'text' && !item.content) continue;

                        const timestamp = Date.now() + i;
                        let messageObject = {
                            role: 'assistant',
                            senderId: contact.contactId,
                            messageId: `msg_${timestamp}_${Math.random()}`,
                            timestamp: timestamp,
                        };

                        if (item.type === 'text') {
                            const chunks = splitMessageIntoChunks(item.content);
                            if (chunks.length > 0) {
                                for(let j = 0; j < chunks.length; j++) {
                                    const userProfile = await db.userProfile.get('main');
                                    const chunkMsg = {
                                        ...messageObject,
                                        type: 'text',
                                        content: chunks[j],
                                        messageId: `${messageObject.messageId}_${j}`,
                                    };
                                    if (i === 0 && j === 0 && aiQuoteContent) {
                                         chunkMsg.aiQuote = {
                                            sender: (userProfile?.name || '你'),
                                            content: aiQuoteContent
                                        };
                                    }
                                    await addMessageToUI(chunkMsg);
                                    await sleep(Math.random() * 500 + 200);
                                }
                            }
                        } else if (item.type === 'voice') {
                            messageObject.type = 'voice';
                            messageObject.content = item.content;
                            messageObject.duration = Math.max(1, Math.round(item.content.length / 4));
                            await addMessageToUI(messageObject);
                            await sleep(300);
                        } else if (item.type === 'described-image') {
                            messageObject.type = 'described-image';
                            messageObject.content = item.content;
                            await addMessageToUI(messageObject);
                            await sleep(300);
                        } else if (item.type === 'html') {
                            messageObject.type = 'html';
                            messageObject.content = item.content;
                            await addMessageToUI(messageObject);
                            await sleep(300);
                        } else if (item.type === 'red-packet') {
                             await addAITransaction('red-packet-sent', -item.amount, contact.contactId);
                             messageObject.type = 'red-packet';
                             messageObject.redPacket = { 
                                text: item.text || '恭喜发财，大吉大利！', 
                                totalAmount: item.amount,
                                type: 'normal',
                                count: 1,
                                openers: [],
                                status: 'pending' 
                             };
                             await addMessageToUI(messageObject);
                             await sleep(300);
                        } else if (item.type === 'transfer') {
                             await addAITransaction('transfer-sent', -item.amount, contact.contactId);
                             messageObject.type = 'transfer';
                             messageObject.transfer = { text: item.text || '', amount: item.amount, received: false };
                             await addMessageToUI(messageObject);
                             await sleep(300);
                        }
                    }

                } catch (error) {
                    console.error('Error calling API:', error);
                    const errorMsg = { role: 'assistant', type: 'text', content: `(系统提示：${error.message})`, messageId: `err_${Date.now()}`, timestamp: Date.now() };
                    await addMessageToUI(errorMsg);
                } finally {
                    showLoading(false);
                    generateBtn.disabled = false;
                    sendBtn.disabled = false;
                }
            };

            async function recallLastAiMessage() {
                if (!currentChatContactId) return;
                const history = await loadChatHistory(currentChatContactId);
                const lastAiMessageIndex = history.map(m => m.role).lastIndexOf('assistant');
                
                if (lastAiMessageIndex !== -1) {
                    const msgToRecall = history[lastAiMessageIndex];
                    if (msgToRecall.isRecalled) return;

                    const originalContent = JSON.parse(JSON.stringify(msgToRecall));
                    delete originalContent.isRecalled;
                    delete originalContent.recalledBy;
                    
                    msgToRecall.isRecalled = true;
                    msgToRecall.recalledBy = 'assistant';
                    msgToRecall.content = originalContent;
                    
                    await saveChatHistory(currentChatContactId, history);
                    await updateLastMessage(currentChatContactId, msgToRecall);
                    await renderChatMessages(currentChatContactId);
                }
            }


            async function confirmAndRegenerate() {
                if (!currentChatContactId) return;
                const { action } = await showCustomModal({
                    title: '重新生成',
                    message: '确定要让对方重新组织语言吗？',
                    buttons: [
                        {id: 'cancel', text: '取消'},
                        {id: 'confirm', text: '确定', class: 'confirm'}
                    ],
                    buttonLayout: 'row'
                });

                if (action === 'confirm') {
                    await regenerateLastResponse();
                }
            }
            
            async function regenerateLastResponse() {
                if (!currentChatContactId) return;
                
                showToast('正在准备重新生成...');

                const history = await loadChatHistory(currentChatContactId);
                
                let lastUserMessageIndex = -1;
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].role === 'user') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }
                
                if (lastUserMessageIndex === -1 || lastUserMessageIndex === history.length - 1) {
                    await generateResponse();
                    return;
                }
                
                const aiMessageIndicesToRemove = [];
                for (let i = lastUserMessageIndex + 1; i < history.length; i++) {
                    if (history[i].role === 'assistant') {
                        aiMessageIndicesToRemove.push(i);
                    }
                }

                for (let i = aiMessageIndicesToRemove.length - 1; i >= 0; i--) {
                    history.splice(aiMessageIndicesToRemove[i], 1);
                }
                
                await saveChatHistory(currentChatContactId, history);
                await renderChatMessages(currentChatContactId);
                
                await generateResponse();
            }
            
            const showCustomModal = (options) => {
                return new Promise((resolve) => {
                    const modalContent = modalMessage;
                    modalTitle.textContent = options.title || '';
                    modalContent.className = 'custom-modal-message';
                    
                    if (options.isFinancial) {
                        modalContent.classList.add('financial-modal-body');
                        if (options.modalClass) {
                             modalContent.classList.add(options.modalClass);
                        }
                    }
                    if (options.isGroupCreation) modalContent.classList.add('group-creation-body');
                    if (options.isRPDetails) modalContent.classList.add('rp-details-modal-body');
                    
                    if (options.rawHTML) {
                        modalMessage.innerHTML = options.rawHTML;
                    } else {
                        modalMessage.innerHTML = options.message ? `<p>${options.message}</p>` : '';
                    }

                    modalButtons.innerHTML = '';
                    modalButtons.className = 'custom-modal-buttons';
                    if (options.buttonLayout === 'row') modalButtons.classList.add('row-layout');
                    
                    if (options.buttons) {
                         const buttonOrder = [...options.buttons];
                         if (options.preferredConfirmRight) {
                             const confirmIndex = buttonOrder.findIndex(b => b.class && b.class.includes('confirm'));
                             if (confirmIndex > 0) {
                                 const [confirmButton] = buttonOrder.splice(confirmIndex, 1);
                                 buttonOrder.push(confirmButton);
                             }
                         }

                         buttonOrder.forEach(btnConfig => {
                            const button = document.createElement('button');
                            button.id = `modal-btn-${btnConfig.id}`;
                            button.textContent = btnConfig.text;
                            button.className = `custom-modal-button ${btnConfig.class || ''}`;
                            button.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const values = {};
                                const formElements = Array.from(modalContent.querySelectorAll('input, textarea, select'));
                                formElements.forEach(input => {
                                    if (input.type === 'checkbox') {
                                        if (!values[input.name]) values[input.name] = [];
                                        if (input.checked) values[input.name].push(input.value);
                                    } else {
                                        values[input.name] = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                                    }
                                });
                                cleanup();
                                resolve({ action: btnConfig.id, values });
                            });
                            modalButtons.appendChild(button);
                        });
                    }

                    if (options.isGroupCreation) {
                        const confirmBtn = modalButtons.querySelector('#modal-btn-confirm');
                        confirmBtn.disabled = true;
                        modalContent.addEventListener('change', (e) => {
                            if (e.target.matches('input[type="checkbox"]')) {
                                const checkedCount = modalContent.querySelectorAll('input[type="checkbox"]:checked').length;
                                confirmBtn.disabled = checkedCount < 1;
                            }
                        });
                    }
                    
                    modalOverlay.classList.add('visible');

                    const handleOverlayClick = (e) => { 
                        if (e.target === modalOverlay) { 
                            const cancelAction = options.buttons ? (options.buttons.find(b => b.id === 'cancel' || b.id === 'close') ? (options.buttons.find(b => b.id === 'cancel') ? 'cancel' : 'close') : null) : null;
                            cleanup(); 
                            resolve({ action: cancelAction, values: {} });
                        } 
                    };

                    const cleanup = () => {
                        modalOverlay.removeEventListener('click', handleOverlayClick);
                        modalOverlay.classList.remove('visible');
                    };

                    modalOverlay.addEventListener('click', handleOverlayClick);
                });
            };

            const copyToClipboard = (text) => {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('已复制');
                    }).catch(err => {
                        console.warn('Clipboard API failed, falling back.', err);
                        fallbackCopy(text);
                    });
                } else {
                    fallbackCopy(text);
                }
            };
            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('已复制');
                    } else {
                        showToast('复制失败', 'warning');
                    }
                } catch (err) {
                    showToast('复制失败', 'warning');
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            const showContextMenu = (event, bubbleElement) => {
                const existingMenu = document.querySelector('.context-menu-overlay');
                if (existingMenu) existingMenu.remove();

                bubbleElement.classList.add('highlighted');

                const turnElement = bubbleElement.closest('.message-turn');
                const isUserMessage = turnElement.classList.contains('user');
                const originalMessageId = bubbleElement.dataset.messageId;
                
                const overlay = document.createElement('div');
                overlay.className = 'context-menu-overlay';
                
                const menu = document.createElement('div');
                menu.className = 'context-menu';
                
                const firstChildBubble = bubbleElement.children[0];
                const isVoiceMessage = firstChildBubble && firstChildBubble.classList.contains('voice-message-bubble');


                let menuItems = `
                    <div class="context-menu-item" data-action="copy">复制</div>
                    <div class="context-menu-item" data-action="favorite">收藏</div>
                    <div class="context-menu-item" data-action="delete">删除</div>
                    <div class="context-menu-item" data-action="edit">编辑</div>
                `;
                if (isUserMessage) {
                    menuItems += `<div class="context-menu-item" data-action="recall">撤回</div>`;
                }
                if (isVoiceMessage) {
                    menuItems += `<div class="context-menu-item" data-action="voice-to-text">转文字</div>`;
                }
                menuItems += `
                    <div class="context-menu-item" data-action="multi-select">多选</div>
                    <div class="context-menu-item" data-action="quote">引用</div>
                `;
                menu.innerHTML = menuItems;
                
                overlay.appendChild(menu);
                document.body.appendChild(overlay);

                const rect = bubbleElement.getBoundingClientRect();
                menu.style.left = `${rect.left}px`;
                menu.style.top = `${rect.top - menu.offsetHeight - 10}px`;
                
                if (rect.top - menu.offsetHeight - 10 < 0) {
                    menu.style.top = `${rect.bottom + 10}px`;
                }
                if (rect.left + menu.offsetWidth > window.innerWidth) {
                    menu.style.left = `${window.innerWidth - menu.offsetWidth - 10}px`;
                }

                setTimeout(() => menu.classList.add('show'), 10);

                const closeMenu = () => {
                    bubbleElement.classList.remove('highlighted');
                    overlay.remove();
                };

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeMenu();
                });

                menu.addEventListener('click', async (e) => {
                    const action = e.target.dataset.action;
                    if (!action || e.target.classList.contains('disabled')) return;

                    closeMenu();

                    const history = await loadChatHistory(currentChatContactId);
                    const msgIndex = history.findIndex(m => m.messageId === originalMessageId);
                    const msg = msgIndex > -1 ? history[msgIndex] : null;

                    if (!msg) { showToast('找不到该消息', 'warning'); return; }
                    const contact = await db.contacts.get({contactId: currentChatContactId});

                    let contentToCopy = '';
                    if (msg.type === 'red-packet') contentToCopy = `[红包] ${msg.redPacket.text}`;
                    else if (msg.type === 'transfer') contentToCopy = `[转账] ¥${msg.transfer.amount.toFixed(2)}`;
                    else if (msg.type === 'voice') contentToCopy = `[语音] ${msg.content}`;
                    else if (msg.type === 'image') contentToCopy = `[相册]`;
                    else if (msg.type === 'described-image') contentToCopy = `[图片] ${msg.content}`;
                    else if (msg.type === 'html') contentToCopy = msg.content;
                    else contentToCopy = msg.content;
                    
                    switch (action) {
                        case 'copy':
                            copyToClipboard(contentToCopy);
                            break;
                        case 'delete':
                            history.splice(msgIndex, 1);
                            await saveChatHistory(currentChatContactId, history);
                            await renderChatMessages(currentChatContactId);
                            showToast('消息已删除');
                            break;
                        case 'edit':
                             if (msg.type !== 'text') {
                                showToast('此类消息不支持编辑', 'warning');
                                return;
                            }
                            const {action: editAction, values: editValues} = await showCustomModal({
                                title: '编辑消息',
                                rawHTML: `<textarea name="text" class="modal-edit-textarea">${msg.content}</textarea>`,
                                buttons: [
                                    {id: 'cancel', text: '取消'},
                                    {id: 'confirm', text: '完成', class: 'confirm'}
                                ],
                                buttonLayout: 'row'
                            });

                            if (editAction === 'confirm' && editValues.text.trim() !== msg.content) {
                                msg.content = editValues.text;
                                await saveChatHistory(currentChatContactId, history);
                                await renderChatMessages(currentChatContactId);
                                showToast('已编辑');
                            }
                            break;
                        case 'recall':
                            const originalContent = JSON.parse(JSON.stringify(msg));
                            delete originalContent.isRecalled;
                            delete originalContent.recalledBy;
                            
                            msg.isRecalled = true;
                            msg.recalledBy = 'user';
                            msg.content = originalContent;
                            
                            await saveChatHistory(currentChatContactId, history);
                            await updateLastMessage(currentChatContactId, msg);
                            await renderChatMessages(currentChatContactId);
                            break;
                        case 'favorite':
                            const favId = `fav_${Date.now()}_${Math.random()}`;
                            await db.favorites.add({
                                favId: favId, messageId: originalMessageId, contactId: currentChatContactId,
                                contactName: getDisplayName(contact), role: msg.role, content: contentToCopy, timestamp: Date.now()
                            });
                            showToast('已收藏');
                            break;
                        case 'multi-select':
                            enterMultiSelectMode(bubbleElement);
                            break;
                        case 'quote':
                            setupReply(bubbleElement);
                            break;
                        case 'voice-to-text':
                            if (msg.type === 'voice') {
                                toggleVoiceText(bubbleElement);
                            }
                            break;
                    }
                });
            };

            const loadUserData = async () => {
                const userProfile = await db.userProfile.get('main');
                const userName = userProfile?.name || '';
                const userAvatar = userProfile?.avatar;

                meName.textContent = userName;
                renderAvatar(meAvatar, {url: userAvatar, name: userName, id: 'user'});
            };

            const saveUserData = async () => {
                const newName = meName.textContent.trim();
                const userProfile = (await db.userProfile.get('main')) || { key: 'main' };
                userProfile.name = newName;
                await db.userProfile.put(userProfile);
                await loadUserData();
                showToast('昵称已更新');
            };

            const renderMasksList = async () => {
                const allMasks = await db.masks.toArray();
                masksList.innerHTML = '';
                if (allMasks.length === 0) {
                    masksList.innerHTML = '<div style="text-align: center; color: #888; padding-top: 50px;">你还没有创建任何面具，点击右上角+创建你的第一个身份吧</div>';
                } else {
                    allMasks.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN')).forEach(mask => {
                        const item = document.createElement('div');
                        item.className = 'mask-item';
                        item.dataset.maskId = mask.maskId;
                        item.innerHTML = `
                            <div class="mask-avatar" style="background-image: url(${mask.avatar || ''})">${!mask.avatar ? defaultMaskAvatar : ''}</div>
                            <div class="mask-name">${mask.name}</div>
                        `;
                        masksList.appendChild(item);
                    });
                }
            };

            masksList.addEventListener('click', async (e) => {
                const item = e.target.closest('.mask-item');
                if (item) {
                    const maskId = item.dataset.maskId;
                    const mask = await db.masks.get({maskId: maskId});
                    if (mask) {
                        openMaskEditor(mask);
                    }
                }
            });

            const openMaskEditor = (mask = null) => {
                currentEditingMask = mask;
                tempAvatarDataUrl = mask ? mask.avatar : null;
                editMaskTitle.textContent = mask ? '编辑面具' : '创建面具';
                maskNameInput.value = mask ? mask.name : '';
                maskGenderSelect.value = mask ? (mask.gender || '女') : '女';
                maskStoryTextarea.value = mask ? mask.story : '';
                maskAvatarPreview.style.backgroundImage = `url(${tempAvatarDataUrl || ''})`;
                maskAvatarPreview.textContent = tempAvatarDataUrl ? '' : '点击上传';
                if (!tempAvatarDataUrl) {
                    maskAvatarPreview.style.backgroundColor = '#E0E0E0';
                }
                deleteMaskBtn.style.display = mask ? 'block' : 'none';
                [maskNameInput, maskStoryTextarea].forEach(input => input.classList.toggle('has-content', input.value.length > 0));
                navigateTo('edit-mask-active');
            };

            const saveMask = async () => {
                const name = maskNameInput.value.trim();
                if (!name) {
                    showToast('面具名称不能为空', 'warning');
                    throw new Error("Validation failed: Mask name is empty.");
                }
                const maskData = {
                    name: name,
                    gender: maskGenderSelect.value,
                    story: maskStoryTextarea.value.trim(),
                    avatar: tempAvatarDataUrl
                };
                if (currentEditingMask) {
                    await db.masks.update(currentEditingMask.id, maskData);
                    showToast('面具已更新');
                } else {
                    maskData.maskId = `mask_${Date.now()}`;
                    await db.masks.add(maskData);
                    showToast('面具已创建');
                }
                await renderMasksList();
                navigateTo('my-masks-active');
            };

            const deleteMask = async () => {
                if (!currentEditingMask) return;
                const { action } = await showCustomModal({
                    title: '删除面具',
                    message: `确定要删除面具 "${currentEditingMask.name}" 吗？所有与此面具的绑定都将解除。`,
                    buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}],
                    buttonLayout: 'row'
                });
                if (action === 'confirm') {
                    await db.transaction('rw', db.masks, db.contacts, async () => {
                        await db.contacts.where('boundMaskId').equals(currentEditingMask.maskId).modify({ boundMaskId: null });
                        await db.masks.delete(currentEditingMask.id);
                    });
                    showToast('面具已删除');
                    await renderMasksList();
                    navigateTo('my-masks-active');
                }
            };

            const openMaskSelection = async () => {
                const allMasks = await db.masks.toArray();
                maskSelectionList.innerHTML = '';
                
                const unbindItem = document.createElement('div');
                unbindItem.className = 'mask-selection-item';
                unbindItem.innerHTML = `<div class="mask-name">解除绑定</div>`;
                unbindItem.addEventListener('click', async () => {
                    await db.contacts.where({contactId: currentChatContactId}).modify({ boundMaskId: null });
                    showToast('已解除绑定');
                    navigateTo('chat-settings-active');
                });
                maskSelectionList.appendChild(unbindItem);
                
                if (allMasks.length > 0) {
                    allMasks.forEach(mask => {
                        const item = document.createElement('div');
                        item.className = 'mask-selection-item';
                        item.innerHTML = `
                            <div class="mask-avatar" style="background-image: url(${mask.avatar || ''})">${!mask.avatar ? defaultMaskAvatar : ''}</div>
                            <div class="mask-name">${mask.name}</div>
                        `;
                        item.addEventListener('click', async () => {
                            await db.contacts.where({contactId: currentChatContactId}).modify({ boundMaskId: mask.maskId });
                            showToast(`已绑定面具: ${mask.name}`);
                            navigateTo('chat-settings-active');
                        });
                        maskSelectionList.appendChild(item);
                    });
                }
                navigateTo('mask-selection-active');
            };

            const exportAllData = async () => {
                try {
                    showToast('正在准备数据...');
                    const blob = await db.export({ prettyJson: true });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const today = new Date().toISOString().slice(0, 10);
                    a.href = url;
                    a.download = `onlyun_backup_${today}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('数据已成功导出！');
                } catch (error) {
                    console.error('Export failed:', error);
                    showToast(`数据导出失败: ${error.message}`, 'warning');
                }
            };

            const importAllData = (file) => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const blob = new Blob([event.target.result], { type: 'application/json' });
                        const { action } = await showCustomModal({
                            title: '导入确认',
                            message: '导入将【覆盖】当前所有数据，此操作不可撤销。确定要继续吗？',
                             buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '确认导入', class: 'destructive'}],
                             buttonLayout: 'row'
                        });
                        if (action === 'confirm') {
                            showToast('正在导入数据，请稍候...');
                            await db.import(blob, {
                                overwriteValues: true,
                                clearTablesBeforeImport: true
                            });
                            showToast('数据导入成功！应用即将刷新。');
                            setTimeout(() => location.reload(), 2000);
                        }
                    } catch (error) {
                        console.error('Import failed:', error);
                        showToast(`导入失败: ${error.message}`, 'warning');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const appIconsToCustomize = [
                { id: 'reopen-app-icon', name: '微信' },
                { id: 'api-settings-icon', name: '设置' },
                { id: 'theme-icon', name: '主题' },
                { id: 'forum-app-icon', name: '论坛' },
                { id: 'worldbook-app-icon', name: '世界书' },
                { id: 'icity-app-icon', name: 'icity' },
                { id: 'dev2-app-icon', name: '待开发' },
            ];

            const populateIconSettings = async () => {
                iconSettingsList.innerHTML = '';
                for (const app of appIconsToCustomize) {
                    const homeIcon = document.getElementById(app.id);
                    const currentIconUrl = homeIcon.style.backgroundImage || window.getComputedStyle(homeIcon).backgroundImage;
                    const item = document.createElement('div');
                    item.className = 'icon-setting-item';
                    item.innerHTML = `
                        <div class="icon-preview" data-icon-id="${app.id}" style="background-image: ${currentIconUrl}"></div>
                        <span class="icon-name-label">${app.name}</span>
                        <button class="change-icon-btn" data-icon-id="${app.id}">选择</button>
                        <button class="reset-icon-btn" data-icon-id="${app.id}">重置</button>
                    `;
                    iconSettingsList.appendChild(item);
                }
            };

            const loadCustomIcons = async () => {
                const iconData = await db.widgetData.where('key').startsWith('icon_').toArray();
                iconData.forEach(item => {
                    const iconId = item.key.replace('icon_', '');
                    const iconElement = document.getElementById(iconId);
                    if (iconElement) {
                        iconElement.style.backgroundImage = `url(${item.value})`;
                    }
                });
            };

            const renderFavorites = async () => {
                const allFavorites = await db.favorites.orderBy('timestamp').reverse().toArray();
                favoritesList.innerHTML = '';
                if (allFavorites.length === 0) {
                    favoritesList.innerHTML = '<div style="text-align: center; color: #888; padding-top: 50px;">还没有任何收藏</div>';
                    return;
                }

                const groupedFavorites = allFavorites.reduce((acc, fav) => {
                    const key = fav.contactName || '未知对话';
                    (acc[key] = acc[key] || []).push(fav);
                    return acc;
                }, {});

                const fragment = document.createDocumentFragment();
                for (const contactName in groupedFavorites) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'favorite-group';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'favorite-group-header';
                    headerDiv.textContent = `与 ${contactName} 的对话`;
                    groupDiv.appendChild(headerDiv);

                    groupedFavorites[contactName].forEach(fav => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'favorite-item';
                        itemDiv.innerHTML = `
                            <div class="favorite-item-main">
                                <div class="favorite-item-content">${fav.content.replace(/\n/g, '<br>')}</div>
                                <div class="favorite-item-footer">${formatTimestamp(fav.timestamp, 'list')}</div>
                            </div>
                            <button class="delete-fav-btn" data-fav-id="${fav.favId}">&times;</button>
                        `;
                        groupDiv.appendChild(itemDiv);
                    });
                    fragment.appendChild(groupDiv);
                }
                favoritesList.appendChild(fragment);
            };

            favoritesList.addEventListener('click', async (e) => {
                if (e.target.matches('.delete-fav-btn')) {
                    const favId = e.target.dataset.favId;
                    const { action } = await showCustomModal({
                        title: '删除收藏',
                        message: '确定要删除这条收藏吗？',
                        buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}],
                        buttonLayout: 'row'
                    });
                    if (action === 'confirm') {
                        await db.favorites.where({ favId: favId }).delete();
                        await renderFavorites();
                        showToast('已删除');
                    }
                }
            });

            themeSettingsModal.addEventListener('click', async (e) => {
                if (e.target.matches('.change-icon-btn')) {
                    currentIconToChange = e.target.dataset.iconId;
                    iconUploadInput.click();
                }
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.iconId;
                    const dbKey = `icon_${iconId}`;
                    await db.widgetData.delete(dbKey);
                    const homeIcon = document.getElementById(iconId);
                    if (homeIcon) {
                        homeIcon.style.backgroundImage = '';
                    }
                    const previewIcon = document.querySelector(`.icon-preview[data-icon-id="${iconId}"]`);
                    if (previewIcon && homeIcon) {
                        previewIcon.style.backgroundImage = window.getComputedStyle(homeIcon).backgroundImage;
                    }
                    showToast('图标已重置为默认');
                }
            });

            iconUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file || !currentIconToChange) return;
                const options = { maxSizeMB: 0.1, maxWidthOrHeight: 256, useWebWorker: true };
                try {
                    const compressedFile = await imageCompression(file, options);
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const dataUrl = event.target.result;
                        const dbKey = `icon_${currentIconToChange}`;
                        await db.widgetData.put({ key: dbKey, value: dataUrl });
                        const homeIcon = document.getElementById(currentIconToChange);
                        if (homeIcon) {
                            homeIcon.style.backgroundImage = `url(${dataUrl})`;
                        }
                        const previewIcon = document.querySelector(`.icon-preview[data-icon-id="${currentIconToChange}"]`);
                        if (previewIcon) {
                            previewIcon.style.backgroundImage = `url(${dataUrl})`;
                        }
                        showToast('图标已更新！');
                        currentIconToChange = null;
                    };
                    reader.readAsDataURL(compressedFile);
                } catch (error) {
                    showToast('图片处理失败', 'warning');
                    console.error(error);
                } finally {
                    e.target.value = ''; 
                }
            });

            reopenAppIcon.addEventListener('click', () => {
                body.classList.remove('app-is-closed');
                navigateTo('messages');
            });
            exitWechatBtn.addEventListener('click', returnToHomeScreen);

            tabMessages.addEventListener('click', () => navigateTo('messages'));
            tabContacts.addEventListener('click', () => navigateTo('contacts'));
            tabMe.addEventListener('click', () => navigateTo('me'));

            backToMainBtn.addEventListener('click', () => navigateTo('messages'));
            backToListBtn.addEventListener('click', () => {
                body.classList.remove('more-actions-visible');
                navigateTo('messages');
            });
            toSettingsBtn.addEventListener('click', () => {
                navigateTo('chat-settings-active');
            });
            backToChatBtn.addEventListener('click', () => navigateTo('chat-view-active'));

            pinChatToggle.addEventListener('change', async () => {
                if (!currentChatContactId) return;
                const isPinned = pinChatToggle.checked;
                await db.contacts.where('contactId').equals(currentChatContactId).modify({ isPinned: isPinned });
                showToast(isPinned ? '已置顶' : '已取消置顶');
                await loadAllContacts();
                await renderMainChatList();
            });
            
            timeSensingToggle.addEventListener('change', async () => {
                if (!currentChatContactId) return;
                const isEnabled = timeSensingToggle.checked;
                await db.contacts.where({contactId: currentChatContactId}).modify({ isTimeSensingEnabled: isEnabled });
                showToast(`时间感应已${isEnabled ? '开启' : '关闭'}`);
            });
            
            setChatBackgroundBtn.addEventListener('click', () => chatBgInput.click());
            chatBgInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file || !currentChatContactId) return;

                const options = { maxSizeMB: 0.8, maxWidthOrHeight: 1920, useWebWorker: true };
                try {
                    showToast('正在处理图片...');
                    const compressedFile = await imageCompression(file, options);
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const dataUrl = event.target.result;
                        await db.contacts.where({contactId: currentChatContactId}).modify({ chatBackground: dataUrl });
                        chatMessages.style.backgroundImage = `url(${dataUrl})`;
                        showToast('聊天背景已更新');
                    };
                    reader.readAsDataURL(compressedFile);
                } catch(err) {
                    showToast('图片处理失败', 'warning');
                }
                 e.target.value = '';
            });


            setRemarkBtn.addEventListener('click', async () => {
                if (!currentChatContactId) return;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const { action, values } = await showCustomModal({
                    title: '设置备注和标签',
                    rawHTML: `<div class="settings-group" style="margin: 0;"><div class="form-group"><input type="text" name="remark" value="${contact.remark || ''}" placeholder="输入备注名"></div></div>`,
                    buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '完成', class: 'confirm'}],
                    buttonLayout: 'row',
                    preferredConfirmRight: true,
                });

                if (action === 'confirm') {
                    await db.contacts.where({contactId: currentChatContactId}).modify({ remark: values.remark.trim() });
                    showToast('备注已更新');
                    await loadAllContacts();
                    await renderChatSettingsPage();
                    await renderMainChatList();
                    const updatedContact = await db.contacts.get({contactId: currentChatContactId});
                    chatHeaderTitle.textContent = getDisplayName(updatedContact);
                }
            });

            editContactInfoBtn.addEventListener('click', async () => {
                if (currentChatContactId) {
                    const contact = await db.contacts.get({contactId: currentChatContactId});
                    openContactEditor(contact, 'chat-settings-active');
                }
            });

            clearHistoryBtn.addEventListener('click', async () => {
                if (!currentChatContactId) return;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const { action } = await showCustomModal({
                    title: '清空聊天记录',
                    message: `确定要清空与 "${getDisplayName(contact)}" 的聊天记录吗？此操作无法撤销。`,
                    buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '清空', class: 'destructive'}],
                    buttonLayout: 'row'
                });
                if (action === 'confirm') {
                    await db.transaction('rw', db.chatHistories, db.contacts, async () => {
                        await db.chatHistories.put({ contactId: currentChatContactId, messages: [] });
                        await db.contacts.where('contactId').equals(currentChatContactId).modify({
                            lastMessageTimestamp: null,
                            lastMessageContent: ''
                        });
                    });
                    showToast('聊天记录已清空');
                    await loadAllContacts();
                    await renderMainChatList();
                    navigateTo('messages');
                }
            });

            deleteContactBtn.addEventListener('click', async () => {
                if (!currentChatContactId) return;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const { action } = await showCustomModal({
                    title: '删除联系人',
                    message: `将删除联系人 "${getDisplayName(contact)}" 同时删除该联系人的聊天记录。`,
                    buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}],
                    buttonLayout: 'row'
                });
                if (action === 'confirm') {
                    await db.transaction('rw', db.contacts, db.chatHistories, async () => {
                        await db.contacts.where('contactId').equals(currentChatContactId).delete();
                        await db.chatHistories.where('contactId').equals(currentChatContactId).delete();
                    });
                    showToast('已删除');
                    currentChatContactId = null;
                    await loadAllContacts();
                    await renderContactsList();
                    await renderMainChatList();
                    navigateTo('messages');
                }
            });

            
            cancelEditContactBtn.addEventListener('click', () => navigateTo(contactEditorReturnPath));
            saveContactBtn.addEventListener('click', saveContact);
            
            const toggleMainMenu = () => {
                mainAddMenuOverlay.classList.toggle('visible');
                mainAddMenu.classList.toggle('visible');
            };

            const showNewChatPicker = async () => {
                const contactsWithoutHistory = allContacts.filter(c => c.type === 'single' && !c.lastMessageTimestamp);

                if (contactsWithoutHistory.length === 0) {
                    showToast('所有联系人都在聊天列表中了', 'info');
                    return;
                }

                let listHtml = contactsWithoutHistory.map(contact => {
                    let avatarHTML;
                     if (contact.avatar) {
                        avatarHTML = `<div class="contact-avatar" style="background-image: url(${contact.avatar})"></div>`;
                    } else {
                        avatarHTML = generateTextAvatar(getDisplayName(contact), contact.contactId).replace('class="avatar"', 'class="contact-avatar avatar"');
                    }
                    return `
                    <div class="contact-item" data-contact-id="${contact.contactId}">
                        ${avatarHTML}
                        <div class="contact-name">${getDisplayName(contact)}</div>
                    </div>`;
                }).join('');
                
                await showCustomModal({
                    title: '选择聊天',
                    rawHTML: `<div class="forward-picker-list" style="max-height: 50vh; overflow-y: auto;">${listHtml}</div>`,
                    buttons: [{id: 'cancel', text: '取消'}]
                });
            };

            document.addEventListener('click', async (e) => {
                const item = e.target.closest('.custom-modal-box .contact-item');
                if (item && item.closest('#custom-modal-overlay')) {
                    const contactId = item.dataset.contactId;
                    modalOverlay.classList.remove('visible');
                    openChatWith(contactId);
                }
            });


            mainAddBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMainMenu();
            });
            mainAddMenuOverlay.addEventListener('click', toggleMainMenu);
            
            menuStartNewChat.addEventListener('click', () => {
                toggleMainMenu();
                showNewChatPicker();
            });

            menuCreateGroup.addEventListener('click', () => {
                toggleMainMenu();
                showToast('群聊功能暂未开放。');
            });

            const setupAvatarUpload = (uploaderEl, inputEl, previewEl) => {
                uploaderEl.addEventListener('click', () => inputEl.click());
                inputEl.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file || !file.type.startsWith('image/')) return;
                    showToast('正在压缩图片...');
                    const options = { maxSizeMB: 0.5, maxWidthOrHeight: 800, useWebWorker: true };
                    try {
                        const compressedFile = await imageCompression(file, options);
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            tempAvatarDataUrl = event.target.result;
                            previewEl.style.backgroundImage = `url(${tempAvatarDataUrl})`;
                            previewEl.style.backgroundColor = '';
                            previewEl.textContent = '';
                            showToast('图片已处理完毕！');
                        };
                        reader.readAsDataURL(compressedFile);
                    } catch (error) {
                        showToast('图片压缩失败', 'warning');
                        console.error(error);
                    }
                });
            };
            setupAvatarUpload(document.querySelector('#edit-contact-page .avatar-uploader'), contactAvatarInput, document.getElementById('contact-avatar-preview'));
            setupAvatarUpload(maskAvatarUploader, maskAvatarInput, maskAvatarPreview);

            sendBtn.addEventListener('click', async () => {
                const content = messageInput.value.trim();
                if (content) {
                    const contact = await db.contacts.get({contactId: currentChatContactId});
                    const userMaskId = contact.boundMaskId;
                    const msg = {
                        role: 'user', type: 'text', content: content, replyTo: replyToMessage,
                        senderId: userMaskId || 'user',
                        messageId: `msg_${Date.now()}_${Math.random()}`, timestamp: Date.now()
                    };
                    await addMessageToUI(msg);
                    messageInput.value = '';
                    clearReply();
                    messageInput.dispatchEvent(new Event('input'));
                    messageInput.focus();
                }
            });

            messageInput.addEventListener('input', () => {
                if (messageInput.value.trim() !== '') {
                    sendBtn.style.display = 'block';
                    generateBtn.style.display = 'none';
                } else {
                    sendBtn.style.display = 'none';
                    generateBtn.style.display = 'block';
                }
            });

            messageInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    sendBtn.click(); 
                } 
            });
            
            generateBtn.addEventListener('click', async () => {
                await generateResponse();
            });

            moreActionsBtn.addEventListener('click', () => {
                body.classList.toggle('more-actions-visible');
                if (body.classList.contains('more-actions-visible')) {
                    document.activeElement.blur();
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 300);
                }
            });
            emojiBtn.addEventListener('click', () => {
                showToast('表情功能开发中...');
                body.classList.remove('more-actions-visible');
            });
            
            async function showTransferModal() {
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const modalHtml = `
                    <div class="modal-recipient-info">
                        <h3>转账给 ${getDisplayName(contact)}</h3>
                    </div>
                    <div class="modal-amount-section">
                        <div class="modal-amount-row">
                           <span class="currency-symbol">¥</span>
                           <input type="number" name="amount" class="amount-input" placeholder="0.00" step="0.01" min="0.01" inputmode="decimal" autofocus>
                        </div>
                    </div>
                    <div class="modal-text-section">
                        <input name="text" placeholder="添加转账留言">
                    </div>
                `;

                const { action, values } = await showCustomModal({
                    title: " ",
                    isFinancial: true,
                    rawHTML: modalHtml,
                    buttons: [{id: 'confirm', text: '转账', class: 'confirm transfer-submit'}]
                });

                if (action === 'confirm' && values.amount > 0) {
                    const balance = await getUserWalletBalance();
                    if(values.amount > balance) {
                        showToast('零钱余额不足', 'warning');
                        return null;
                    }
                    return values;
                } else if (action === 'confirm') {
                    showToast('金额必须大于0', 'warning');
                }
                return null;
            }

            async function showRedPacketModal() {
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const isGroup = contact.type === 'group';
                let groupOptions = '';

                if (isGroup) {
                    groupOptions = `
                        <div class="modal-amount-section">
                            <div class="modal-amount-row">
                                <label for="rp-count">红包个数</label>
                                <input type="number" name="count" id="rp-count" value="1" min="1" max="${contact.members.length + 1}" style="text-align: right;" inputmode="numeric">
                                <span>个</span>
                            </div>
                        </div>`;
                }

                const modalHtml = `
                    <div class="modal-amount-section" style="border-bottom: none; border-top: none; padding-top: 20px;">
                        <div class="modal-amount-row">
                            <label for="rp-amount" id="rp-amount-label">${isGroup ? '总金额' : '单个金额'}</label>
                            <input type="number" name="totalAmount" id="rp-amount" placeholder="0.00" step="0.01" min="0.01" style="text-align: right;" inputmode="decimal" autofocus>
                             <span>元</span>
                        </div>
                    </div>
                    ${groupOptions}
                    <div class="modal-text-section" style="margin-top: 10px;">
                        <textarea name="text" id="modal-red-packet-text" placeholder="恭喜发财，大吉大利！"></textarea>
                    </div>
                    <div class="modal-final-amount">¥0.00</div>
                `;

                 const { action, values } = await showCustomModal({
                    title: "发红包",
                    isFinancial: true,
                    modalClass: 'red-packet-modal',
                    rawHTML: modalHtml,
                    buttons: [{id: 'confirm', text: '塞钱进红包', class: 'confirm red-packet-submit'}]
                });

                if (action === 'confirm') {
                    if (!values.totalAmount || values.totalAmount <= 0) {
                        showToast('金额必须大于0', 'warning');
                        return null;
                    }
                    const balance = await getUserWalletBalance();
                    if(values.totalAmount > balance) {
                        showToast('零钱余额不足', 'warning');
                        return null;
                    }
                    if (isGroup) {
                        if (values.type === 'normal' && (values.totalAmount / values.count < 0.01)) {
                             showToast('单个普通红包金额不能低于0.01元', 'warning');
                             return null;
                        }
                    } else {
                        values.count = 1;
                        values.type = 'normal';
                    }
                    
                    return values;
                }
                return null;
            }
            
            async function showVoiceInputModal() {
                const { action, values } = await showCustomModal({
                    title: '语音输入',
                    rawHTML: `<textarea name="text" class="modal-edit-textarea" placeholder="输入你想“说”的话，将作为语音消息发送..."></textarea>`,
                    buttons: [
                        {id: 'cancel', text: '取消'},
                        {id: 'confirm', text: '发送', class: 'confirm'}
                    ],
                    buttonLayout: 'row'
                });

                if (action === 'confirm' && values.text.trim()) {
                    return values.text.trim();
                }
                return null;
            }

            async function showDescribedImageModal() {
                 const { action, values } = await showCustomModal({
                    title: '拍摄（描述图片）',
                    rawHTML: `<textarea name="text" class="modal-edit-textarea" placeholder="用文字来描述你想发送的图片内容..."></textarea>`,
                    buttons: [
                        {id: 'cancel', text: '取消'},
                        {id: 'confirm', text: '发送', class: 'confirm'}
                    ],
                    buttonLayout: 'row'
                });

                if (action === 'confirm' && values.text.trim()) {
                    return values.text.trim();
                }
                return null;
            }


            moreActionsPanel.addEventListener('click', async (e) => {
                const item = e.target.closest('.action-grid-item');
                if (!item) return;

                const action = item.dataset.action;
                body.classList.remove('more-actions-visible');
                
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const senderId = contact.boundMaskId || 'user';
                
                if (action === 'transfer') {
                    const result = await showTransferModal();
                     if (result) {
                        const note = result.text.trim();
                        const msg = {
                            role: 'user', type: action, senderId: senderId,
                            messageId: `msg_${Date.now()}_${Math.random()}`, timestamp: Date.now(),
                            transfer: { amount: result.amount, text: note, received: false }
                        };
                        await addUserTransaction('transfer-sent', -result.amount, `转账给 ${getDisplayName(contact)}`);
                        await addMessageToUI(msg);
                    }
                } else if (action === 'red-packet') {
                    const result = await showRedPacketModal();
                    if (result) {
                        const msg = {
                            role: 'user', type: 'red-packet', senderId: senderId,
                            messageId: `msg_${Date.now()}_${Math.random()}`, timestamp: Date.now(),
                            redPacket: { 
                                text: result.text.trim() || '恭喜发财，大吉大利！',
                                totalAmount: result.totalAmount,
                                type: result.type || 'normal',
                                count: result.count || 1,
                                exclusiveTo: result.exclusiveTo || null,
                                openers: [],
                                status: 'pending'
                             }
                        };
                        await addUserTransaction('red-packet-sent', -result.totalAmount, `发出红包给 ${getDisplayName(contact)}`);
                        await addMessageToUI(msg);
                    }
                } else if (action === 'voice-input') {
                     const voiceText = await showVoiceInputModal();
                    if (voiceText) {
                        const msg = {
                            role: 'user', type: 'voice', senderId: senderId,
                            content: voiceText,
                            duration: Math.max(1, Math.round(voiceText.length / 4)),
                            messageId: `msg_${Date.now()}_${Math.random()}`,
                            timestamp: Date.now(),
                            replyTo: replyToMessage,
                        };
                        await addMessageToUI(msg);
                        clearReply();
                    }
                } else if (action === 'described-image') {
                    const imageDesc = await showDescribedImageModal();
                    if(imageDesc) {
                         const msg = {
                            role: 'user', type: 'described-image', senderId: senderId,
                            content: imageDesc,
                            messageId: `msg_${Date.now()}_${Math.random()}`,
                            timestamp: Date.now(),
                            replyTo: replyToMessage,
                        };
                        await addMessageToUI(msg);
                        clearReply();
                    }
                } else if (action === 'album') {
                    imageUploadInput.click();
                } else if (['video-call', 'location', 'voice-call'].includes(action)) {
                     showToast('该功能正在紧张开发中，敬请期待！');
                }
            });

            async function handleImageUploadAndSend(file) {
                 if (!file) return;

                const contact = await db.contacts.get({ contactId: currentChatContactId });
                const senderId = contact.boundMaskId || 'user';
                const isVisionModel = settings.modelName.includes('vision') || settings.modelName.includes('v');
                
                if (!isVisionModel) {
                     showToast('当前模型不支持识图，请在API设置中选择Vision模型', 'warning');
                     return;
                }

                showToast('正在处理图片...');
                try {
                    const options = { maxSizeMB: 1, maxWidthOrHeight: 1024, useWebWorker: true };
                    const compressedFile = await imageCompression(file, options);

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const dataUrl = event.target.result;
                        const msg = {
                            role: 'user',
                            type: 'image',
                            senderId: senderId,
                            imageUrl: dataUrl,
                            messageId: `msg_${Date.now()}_${Math.random()}`,
                            timestamp: Date.now(),
                            replyTo: replyToMessage,
                        };
                        await addMessageToUI(msg);
                        clearReply();
                        await generateResponse();
                    };
                    reader.readAsDataURL(compressedFile);
                } catch (error) {
                    showToast('图片处理失败', 'warning');
                    console.error('Image processing error:', error);
                }
            }

            imageUploadInput.addEventListener('change', (e) => {
                handleImageUploadAndSend(e.target.files[0]);
                e.target.value = ''; // Reset input
            });

            messageInput.addEventListener('focus', () => {
                body.classList.remove('more-actions-visible');
            });
            chatMessages.addEventListener('click', async (e) => {
                const aiAvatar = e.target.closest('.ai-avatar');
                if (aiAvatar) {
                    e.stopPropagation();
                    confirmAndRegenerate();
                    return;
                }
                const img = e.target.closest('.image-message-content img');
                if (img) {
                    const { action } = await showCustomModal({ title: '图片预览', rawHTML: `<img src="${img.src}" style="max-width: 100%; border-radius: 8px;">`, buttons: [{id: 'close', text: '关闭', class: 'confirm'}]});
                    return;
                }

                if (isMultiSelectMode) {
                    const bubbleElement = e.target.closest('.message-bubble');
                    if (bubbleElement) {
                        toggleMessageSelection(bubbleElement);
                    }
                    return;
                }

                if (!e.target.closest('.red-packet-bubble, .transfer-bubble, .voice-message-bubble, .described-image-bubble')) {
                    body.classList.remove('more-actions-visible');
                }
            });


            apiSettingsIcon.addEventListener('click', () => {
                body.classList.remove('app-is-closed');
                navigateTo('main-settings-active');
            });
            themeIcon.addEventListener('click', () => {
                body.classList.remove('app-is-closed');
                populateIconSettings(); 
                navigateTo('theme-settings-active');
            });
            
            closeMainSettingsBtn.addEventListener('click', returnToHomeScreen);
            closeThemeSettingsBtn.addEventListener('click', returnToHomeScreen);
            goToApiConfigBtn.addEventListener('click', () => navigateTo('api-config-active'));
            goToDataManagementBtn.addEventListener('click', () => navigateTo('data-management-active'));
            backToMainSettingsBtn.addEventListener('click', () => navigateTo('main-settings-active'));
            backToMainSettingsFromApiBtn.addEventListener('click', () => navigateTo('main-settings-active'));

            exportDataBtn.addEventListener('click', exportAllData);
            importDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importAllData(file);
                }
                e.target.value = '';
            });
            
            saveApiSettingsBtn.addEventListener('click', saveApiSettings);

            [baseUrlInput, apiKeyInput, contactNameInput, contactStoryTextarea, maskNameInput, maskStoryTextarea, wbEditNameInput, wbEditContentTextarea].forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.toggle('has-content', this.value.length > 0);
                });
            });

            fetchModelsBtn.addEventListener('click', async () => {
                const baseURL = baseUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                if (!baseURL || !apiKey) { showToast('请先填写 Base URL 和 API Key！', 'warning'); return; }
                fetchModelsBtn.disabled = true; fetchModelsBtn.textContent = '正在获取...';
                try {
                    const response = await fetch(`${baseURL}/v1/models`, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                    if (!response.ok) throw new Error(`HTTP 错误! 状态码: ${response.status}`);
                    const data = await response.json();
                    const currentModel = modelSelect.value;
                    modelSelect.innerHTML = '';
                    data.data.map(m => m.id).sort().forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        if(modelId === currentModel) option.selected = true;
                        modelSelect.appendChild(option);
                    });
                    showToast('模型列表已成功加载！');
                } catch (error) {
                    showToast('拉取模型失败，请检查配置', 'warning');
                    console.error(error);
                } finally {
                    fetchModelsBtn.disabled = false; fetchModelsBtn.textContent = '获取模型列表';
                }
            });
            savePresetBtn.addEventListener('click', async () => {
                const { action, values } = await showCustomModal({ 
                    title: '保存预设', 
                    rawHTML: `<div class="settings-group" style="margin: 0;"><div class="form-group"><input type="text" name="presetName" placeholder="例如：我的主力 Key"></div></div>`,
                    buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '保存', class: 'confirm'}],
                    buttonLayout: 'row',
                    preferredConfirmRight: true,
                });

                if (action === 'confirm' && values.presetName && values.presetName.trim()) {
                    const presetName = values.presetName.trim();
                    const newPreset = { name: presetName, baseURL: baseUrlInput.value.trim(), apiKey: apiKeyInput.value.trim(), modelName: modelSelect.value };
                    let presets = await getPresets();
                    const existingIndex = presets.findIndex(p => p.name === presetName);
                    if (existingIndex > -1) {
                        const { action: overwriteAction } = await showCustomModal({ title: '覆盖预设', message: `已存在名为 "${presetName}" 的预设，是否覆盖？`, buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '覆盖', class: 'destructive'}], buttonLayout: 'row'});
                        if (overwriteAction !== 'confirm') return;
                        presets[existingIndex] = newPreset;
                    } else {
                        presets.push(newPreset);
                    }
                    await db.settings.put({ key: 'apiPresets', data: presets });
                    showToast(`预设 "${presetName}" 已保存！`);
                    await loadApiPresets();
                    presetSelect.value = presetName;
                } else if(action === 'confirm') {
                    showToast('预设名称不能为空！', 'warning');
                }
            });
            deletePresetBtn.addEventListener('click', async () => {
                const selectedName = presetSelect.value;
                if (!selectedName) { showToast('请先选择一个要删除的预设。', 'warning'); return; }
                const { action } = await showCustomModal({ title: '删除预设', message: `确定要删除预设 "${selectedName}" 吗？`, buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}], buttonLayout: 'row'});
                if (action === 'confirm') {
                    let presets = (await getPresets()).filter(p => p.name !== selectedName);
                    await db.settings.put({ key: 'apiPresets', data: presets });
                    showToast(`预设 "${selectedName}" 已删除。`);
                    await loadApiPresets();
                }
            });
            presetSelect.addEventListener('change', async () => {
                const selectedPreset = (await getPresets()).find(p => p.name === presetSelect.value);
                if (selectedPreset) {
                    baseUrlInput.value = selectedPreset.baseURL;
                    apiKeyInput.value = selectedPreset.apiKey;
                    const modelToSelect = selectedPreset.modelName;

                    const modelExists = Array.from(modelSelect.options).some(opt => opt.value === modelToSelect);
                    if (!modelExists && modelToSelect) {
                        const option = document.createElement('option');
                        option.value = modelToSelect;
                        option.textContent = modelToSelect;
                        modelSelect.appendChild(option);
                    }
                    modelSelect.value = modelToSelect;

                    baseUrlInput.classList.toggle('has-content', baseUrlInput.value.length > 0);
                    apiKeyInput.classList.toggle('has-content', apiKeyInput.value.length > 0);
                    showToast(`已加载预设 "${selectedPreset.name}"`);
                }
            });
            wallpaperInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    homeScreen.style.backgroundImage = `url(${event.target.result})`;
                    await db.widgetData.put({ key: 'wallpaperImage', value: event.target.result });
                    showToast('壁纸已更换！');
                    returnToHomeScreen();
                };
                reader.readAsDataURL(file);
            });
            resetWallpaperBtn.addEventListener('click', async () => {
                await db.widgetData.delete('wallpaperImage');
                homeScreen.style.backgroundImage = '';
                showToast('已恢复默认壁纸');
                returnToHomeScreen();
            });

            const showDevToast = () => showToast('该功能正在紧张开发中，敬请期待！');
            
            [document.getElementById('tab-discover'), meMomentsBtn, meStickersBtn, document.getElementById('forum-app-icon'), document.getElementById('icity-app-icon'), document.getElementById('dev2-app-icon')].forEach(btn => btn.addEventListener('click', showDevToast));
            
            meName.addEventListener('blur', saveUserData);
            meAvatar.addEventListener('click', () => meAvatarInput.click());
            meAvatarInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const compressedFile = await imageCompression(file, { maxSizeMB: 0.2, maxWidthOrHeight: 400 });
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const dataUrl = event.target.result;
                    const userProfile = (await db.userProfile.get('main')) || { key: 'main' };
                    userProfile.avatar = dataUrl;
                    await db.userProfile.put(userProfile);
                    meAvatar.style.backgroundImage = `url(${dataUrl})`;
                    showToast('头像已更新');
                };
                reader.readAsDataURL(compressedFile);
            });
            
            meMasksBtn.addEventListener('click', () => {
                renderMasksList();
                navigateTo('my-masks-active');
            });
            meFavoritesBtn.addEventListener('click', () => {
                renderFavorites();
                navigateTo('favorites-active');
            });
            backToMeFromFavoritesBtn.addEventListener('click', () => navigateTo('me'));
            backToMeBtn.addEventListener('click', () => navigateTo('me'));
            addMaskBtn.addEventListener('click', () => openMaskEditor());
            cancelEditMaskBtn.addEventListener('click', () => navigateTo('my-masks-active'));
            
            saveMaskBtn.addEventListener('click', async () => {
                saveMaskBtn.disabled = true;
                try {
                    await saveMask();
                } catch (error) {
                    console.error("Error saving mask:", error);
                } finally {
                    saveMaskBtn.disabled = false;
                }
            });

            deleteMaskBtn.addEventListener('click', deleteMask);
            bindMaskBtn.addEventListener('click', openMaskSelection);
            
            backToChatSettingsBtn.addEventListener('click', () => {
                navigateTo('chat-settings-active');
            });


            customImageTextWidget.addEventListener('click', (e) => { if (e.target === e.currentTarget) widgetBackgroundInput.click(); });
            widgetBackgroundInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        customImageTextWidget.style.backgroundImage = `url(${event.target.result})`;
                        await db.widgetData.put({ key: 'customWidgetBackgroundImage', value: event.target.result });
                    };
                    reader.readAsDataURL(file);
                }
            });
            widgetTextTop.addEventListener('blur', (e) => db.widgetData.put({ key: 'customWidgetTextTop', value: e.target.value }));
            widgetTextBottom.addEventListener('blur', (e) => db.widgetData.put({ key: 'customWidgetTextBottom', value: e.target.value }));

            togglePhoneFrame.addEventListener('change', () => {
                localStorage.setItem('showPhoneFrame', togglePhoneFrame.checked);
                showToast('外观设置已保存，页面即将刷新...');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            });

            function enterMultiSelectMode(initialBubbleElement) {
                isMultiSelectMode = true;
                body.classList.add('multi-select-mode');
                toSettingsBtn.style.display = 'none';
                cancelMultiSelectBtn.style.display = 'flex';
                toggleMessageSelection(initialBubbleElement);
            }
            async function exitMultiSelectMode() {
                isMultiSelectMode = false;
                body.classList.remove('multi-select-mode');
                selectedMessages.clear();
                document.querySelectorAll('.message-turn.selected').forEach(el => el.classList.remove('selected'));
                toSettingsBtn.style.display = 'flex';
                cancelMultiSelectBtn.style.display = 'none';
                if (currentChatContactId) {
                    const contact = await db.contacts.get({contactId: currentChatContactId});
                    chatHeaderTitle.textContent = getDisplayName(contact);
                }
                updateMultiSelectToolbar();
            }
            async function toggleMessageSelection(bubbleElement) {
                const turnElement = bubbleElement.closest('.message-turn');
                const isSelected = turnElement.classList.toggle('selected');
                const contact = await db.contacts.get({contactId: currentChatContactId});
                
                const messageId = bubbleElement.dataset.messageId;
                if (isSelected) {
                    const contentEl = bubbleElement.querySelector('.message-content, .merged-forward-message, .red-packet-bubble, .transfer-bubble, .voice-message-bubble, .described-image-bubble, .image-message-content');
                    const userProfile = await db.userProfile.get('main');
                    selectedMessages.set(messageId, {
                        messageId: messageId,
                        sender: turnElement.classList.contains('user') ? (userProfile?.name || '我') : getDisplayName(contact),
                        content: contentEl.innerText || '[图片]'
                    });
                } else {
                    selectedMessages.delete(messageId);
                }
                
                if (selectedMessages.size === 0) {
                    exitMultiSelectMode();
                } else {
                    chatHeaderTitle.textContent = `已选择 ${selectedMessages.size} 条消息`;
                    updateMultiSelectToolbar();
                }
            }
            function updateMultiSelectToolbar() {
                const hasSelection = selectedMessages.size > 0;
                multiSelectDeleteBtn.disabled = !hasSelection;
                multiSelectForwardBtn.disabled = !hasSelection;
            }

            multiSelectDeleteBtn.addEventListener('click', async () => {
                const { action } = await showCustomModal({
                    title: '删除消息',
                    message: `确定要删除所选的 ${selectedMessages.size} 条消息吗？`,
                    buttons: [ {id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}],
                    buttonLayout: 'row'
                });
                if (action === 'confirm') {
                    const history = await loadChatHistory(currentChatContactId);
                    const selectedIds = Array.from(selectedMessages.keys());
                    const newHistory = history.filter(msg => !selectedIds.includes(msg.messageId));
                    await saveChatHistory(currentChatContactId, newHistory);
                    exitMultiSelectMode();
                    await renderChatMessages(currentChatContactId);
                    showToast('已删除');
                }
            });
            async function addMessageToHistory(contactId, role, content, senderId = 'user') {
                const timestamp = Date.now();
                const history = await loadChatHistory(contactId);
                const messageObject = {
                    role: role, content: content, type: 'text', senderId: senderId,
                    messageId: `msg_${timestamp}_${Math.random()}`, timestamp: timestamp,
                };
                if (typeof content === 'object') {
                    if (content.type === 'merged') messageObject.type = 'merged';
                }
                history.push(messageObject);
                await saveChatHistory(contactId, history);
                await updateLastMessage(contactId, messageObject);
            }
            function showForwardContactPicker() {
                return new Promise((resolve) => {
                    forwardPickerList.innerHTML = '';
                    const contactsToDisplay = allContacts.filter(c => c.contactId !== currentChatContactId);
                    contactsToDisplay.forEach(contact => {
                        const item = document.createElement('div');
                        item.className = 'contact-item';

                        let avatarHTML;
                        if (contact.avatar) {
                            avatarHTML = `<div class="contact-avatar" style="background-image: url(${contact.avatar})"></div>`;
                        } else {
                            avatarHTML = generateTextAvatar(getDisplayName(contact), contact.contactId).replace('class="avatar"', 'class="contact-avatar avatar"');
                        }

                        item.innerHTML = `
                            ${avatarHTML}
                            <div class="contact-name">${getDisplayName(contact)}</div>
                        `;
                        item.addEventListener('click', () => {
                            forwardContactPickerModal.classList.remove('visible');
                            resolve(contact.contactId);
                        });
                        forwardPickerList.appendChild(item);
                    });
                    forwardContactPickerModal.classList.add('visible');
                    forwardContactPickerModal.onclick = (e) => {
                        if (e.target === forwardContactPickerModal) {
                            forwardContactPickerModal.classList.remove('visible');
                            resolve(null);
                        }
                    };
                });
            }
            multiSelectForwardBtn.addEventListener('click', async () => {
                const targetContactId = await showForwardContactPicker();
                if (targetContactId) {
                    const { action } = await showCustomModal({
                        title: '选择转发方式',
                        buttons: [
                             { id: 'merged', text: '合并转发', class: 'confirm' },
                             { id: 'single', text: '逐条转发' },
                             { id: 'cancel', text: '取消' }
                        ],
                        buttonLayout: 'column'
                    });
                    
                    if (action === 'cancel' || !action) return;

                    const contact = await db.contacts.get({contactId: currentChatContactId});
                    const messagesToForward = Array.from(selectedMessages.values()).sort((a, b) => a.messageId.localeCompare(b.messageId));
                    const senderId = contact.boundMaskId || 'user';

                    if (action === 'single') {
                        for (const msg of messagesToForward) {
                            await addMessageToHistory(targetContactId, 'user', msg.content, senderId);
                        }
                    } else if (action === 'merged') {
                        const mergedContent = {
                            type: 'merged',
                            from: getDisplayName(contact),
                            messages: messagesToForward.map(m => ({ sender: m.sender, content: m.content }))
                        };
                        await addMessageToHistory(targetContactId, 'user', mergedContent, senderId);
                    }
                    showToast('已转发');
                    exitMultiSelectMode();
                }
            });
            async function setupReply(bubbleElement) {
                const contentEl = bubbleElement.querySelector('.message-content, .merged-forward-message, .red-packet-bubble, .transfer-bubble, .voice-message-bubble, .described-image-bubble, .image-message-content');
                const content = contentEl.innerText || '[图片]';
                const turnElement = bubbleElement.closest('.message-turn');
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const userProfile = await db.userProfile.get('main');

                replyToMessage = {
                    sender: turnElement.classList.contains('user') ? (userProfile?.name || '我') : getDisplayName(contact),
                    content: content.substring(0, 50) + (content.length > 50 ? '...' : '')
                };
                replyPreviewContent.innerHTML = `回复 <strong>${replyToMessage.sender}</strong>: ${replyToMessage.content}`;
                replyPreviewBar.style.display = 'flex';
                messageInput.focus();
            }
            function clearReply() {
                replyToMessage = null;
                replyPreviewBar.style.display = 'none';
            }
            closeReplyBtn.addEventListener('click', clearReply);
            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);

            const renderWorldBook = async () => {
                const items = await db.worldBook.toArray();
                worldbookListContainer.innerHTML = '';

                if (items.length === 0) {
                    worldbookListContainer.innerHTML = '<div style="text-align: center; color: #888; padding-top: 50px;">世界书是空的，点击右上角按钮开始创建吧。</div>';
                    return;
                }

                const folders = items.filter(item => item.type === 'folder');
                const files = items.filter(item => item.type === 'file');
                
                const filesByFolder = files.reduce((acc, file) => {
                    const folderId = file.folderId || 'root';
                    if (!acc[folderId]) acc[folderId] = [];
                    acc[folderId].push(file);
                    return acc;
                }, {});

                let html = '';

                folders.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN')).forEach(folder => {
                    html += `
                        <div class="worldbook-folder">
                            <div class="worldbook-folder-header" data-folder-id="${folder.id}">
                                <span class="worldbook-folder-name"><strong>${folder.name}</strong></span>
                                <div class="worldbook-item-actions">
                                    <button data-action="delete" data-type="folder" data-id="${folder.id}">删除</button>
                                </div>
                            </div>
                            <div class="worldbook-file-list collapsed" data-list-for-folder="${folder.id}">
                    `;
                    if (filesByFolder[folder.id]) {
                         filesByFolder[folder.id].sort((a, b) => a.name.localeCompare(b.name, 'zh-CN')).forEach(file => {
                            html += `
                                <div class="worldbook-file" data-id="${file.id}">
                                    <span class="worldbook-file-name">${file.name}</span>
                                    <div class="worldbook-item-actions">
                                        <button data-action="delete" data-type="file" data-id="${file.id}">删除</button>
                                    </div>
                                </div>`;
                        });
                    }
                    html += `</div></div>`;
                });

                if (filesByFolder['root']) {
                    filesByFolder['root'].sort((a, b) => a.name.localeCompare(b.name, 'zh-CN')).forEach(file => {
                        html += `
                            <div class="worldbook-file" data-id="${file.id}">
                                <span class="worldbook-file-name">${file.name}</span>
                                <div class="worldbook-item-actions">
                                    <button data-action="delete" data-type="file" data-id="${file.id}">删除</button>
                                </div>
                            </div>`;
                    });
                }

                worldbookListContainer.innerHTML = html;
            };
            
            const openWorldBookEditor = async (file = null) => {
                currentEditingWorldBookItem = file;

                wbEditTitle.textContent = file ? '编辑文件' : '新建文件';
                wbEditNameInput.value = file ? file.name : '';
                wbEditContentTextarea.value = file ? file.content : '';

                const folders = await db.worldBook.where('type').equals('folder').toArray();
                const folderOptions = folders.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
                wbEditFolderSelect.innerHTML = `
                    <option value="null">无文件夹</option>
                    ${folderOptions}
                `;
                
                wbEditFolderSelect.value = file ? (file.folderId === null ? 'null' : file.folderId) : 'null';
                
                [wbEditNameInput, wbEditContentTextarea].forEach(input => input.classList.toggle('has-content', input.value.length > 0));

                navigateTo('worldbook-edit-active');
            };

            const openWorldBookBindingPage = async () => {
                const allFolders = await db.worldBook.where('type').equals('folder').toArray();
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const boundItems = contact.boundWorldBookFolders || [];
                
                if (allFolders.length === 0) {
                     worldbookBindingList.innerHTML = `<div class="worldbook-binding-item empty-state">还没有创建任何文件夹。</div>`;
                } else {
                    let listHtml = allFolders.map(folder => `
                        <div class="worldbook-binding-item">
                            <label>
                                <input type="checkbox" data-folder-id="${folder.id}" ${boundItems.includes(folder.id) ? 'checked' : ''}>
                                ${folder.name}
                            </label>
                        </div>
                    `).join('');
                    worldbookBindingList.innerHTML = listHtml;
                }
                
                navigateTo('worldbook-binding-active');
            };
            
            bindWorldbookBtn.addEventListener('click', openWorldBookBindingPage);

            backToChatSettingsFromWBBindingBtn.addEventListener('click', async () => {
                const checkedBoxes = worldbookBindingList.querySelectorAll('input[type="checkbox"]:checked');
                const boundIds = Array.from(checkedBoxes).map(box => Number(box.dataset.folderId));
                
                await db.contacts.where({contactId: currentChatContactId}).modify({ boundWorldBookFolders: boundIds });
                showToast('绑定已更新');
                navigateTo('chat-settings-active');
            });

            worldbookAppIcon.addEventListener('click', () => {
                body.classList.remove('app-is-closed');
                renderWorldBook();
                navigateTo('worldbook-active');
            });
            backFromWorldbookBtn.addEventListener('click', returnToHomeScreen);

            wbCreateFolderBtn.addEventListener('click', async () => {
                const { action, values } = await showCustomModal({
                    title: '新建文件夹',
                    rawHTML: `<div class="settings-group" style="margin: 0;"><div class="form-group"><input type="text" name="folderName" placeholder="请输入文件夹名称"></div></div>`,
                    buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '创建', class: 'confirm'}],
                    buttonLayout: 'row',
                    preferredConfirmRight: true,
                });
                if (action === 'confirm' && values.folderName.trim()) {
                    await db.worldBook.add({ type: 'folder', name: values.folderName.trim() });
                    showToast('文件夹已创建');
                    await renderWorldBook();
                } else if(action === 'confirm') {
                     showToast('文件夹名称不能为空', 'warning');
                }
            });

            wbCreateFileBtn.addEventListener('click', () => openWorldBookEditor());
            
            wbEditCancelBtn.addEventListener('click', () => navigateTo('worldbook-active'));
            wbEditSaveBtn.addEventListener('click', async () => {
                const name = wbEditNameInput.value.trim();
                if (!name) {
                    showToast('文件名称不能为空', 'warning');
                    return;
                }

                const fileData = {
                    type: 'file',
                    name: name,
                    folderId: wbEditFolderSelect.value === 'null' ? null : Number(wbEditFolderSelect.value),
                    content: wbEditContentTextarea.value.trim()
                };

                if (currentEditingWorldBookItem) {
                    await db.worldBook.update(currentEditingWorldBookItem.id, fileData);
                    showToast('文件已更新');
                } else {
                    await db.worldBook.add(fileData);
                    showToast('文件已创建');
                }
                
                await renderWorldBook();
                navigateTo('worldbook-active');
            });
            
            worldbookListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const fileEl = target.closest('.worldbook-file');
                const actionBtn = target.closest('button[data-action="delete"]');
                const folderHeader = target.closest('.worldbook-folder-header');

                if (actionBtn) {
                    e.stopPropagation();
                    const id = Number(actionBtn.dataset.id);
                    const type = actionBtn.dataset.type;
                    
                    if (type === 'folder') {
                        const { action } = await showCustomModal({
                            title: '删除文件夹',
                            message: '确定要删除此文件夹吗？其中的所有文件将被移至“无文件夹”类别。',
                             buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}],
                             buttonLayout: 'row'
                        });
                        if (action === 'confirm') {
                            await db.transaction('rw', db.worldBook, async () => {
                                await db.worldBook.where('folderId').equals(id).modify({ folderId: null });
                                await db.worldBook.delete(id);
                            });
                            showToast('文件夹已删除');
                            await renderWorldBook();
                        }
                    } else if (type === 'file') {
                         const { action } = await showCustomModal({
                            title: '删除文件',
                            message: '确定要删除此文件吗？',
                            buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '删除', class: 'destructive'}],
                            buttonLayout: 'row'
                        });
                         if (action === 'confirm') {
                            await db.worldBook.delete(id);
                            showToast('文件已删除');
                            await renderWorldBook();
                        }
                    }
                } else if (fileEl) {
                    const fileId = Number(fileEl.dataset.id);
                    const fileData = await db.worldBook.get(fileId);
                    if (fileData) {
                        await openWorldBookEditor(fileData);
                    }
                } else if (folderHeader) {
                    const folderId = folderHeader.dataset.folderId;
                    const fileList = document.querySelector(`.worldbook-file-list[data-list-for-folder="${folderId}"]`);
                    if(fileList) {
                        fileList.classList.toggle('collapsed');
                    }
                }
            });
            
            function toggleVoiceText(bubbleElement) {
                if (!bubbleElement) return;
                const voiceBubble = bubbleElement.querySelector('.voice-message-bubble');
                if (!voiceBubble) return;

                const wrapper = bubbleElement.closest('.message-turn-content-wrapper');
                let textEl = wrapper.querySelector('.voice-transcription');
                
                if (textEl) {
                    textEl.remove();
                    voiceTextVisible.delete(bubbleElement);
                } else {
                    const text = voiceBubble.dataset.voiceText;
                    if (text) {
                        textEl = document.createElement('div');
                        textEl.className = 'voice-transcription';
                        textEl.innerHTML = text.replace(/\n/g, '<br>');
                        wrapper.appendChild(textEl);
                        voiceTextVisible.add(bubbleElement);
                    }
                }
            }
            
            function createWaveform(count = 15) {
                const waveformContainer = document.createElement('div');
                waveformContainer.className = 'voice-waveform';
                const heights = [4, 6, 8, 12, 16, 12, 8, 6, 4];
                let html = '';
                for (let i = 0; i < count; i++) {
                    const height = heights[i % heights.length] * (Math.random() * 0.5 + 0.75);
                    html += `<div class="voice-waveform-bar" style="height: ${height}px;"></div>`;
                }
                waveformContainer.innerHTML = html;
                return waveformContainer;
            }

            function createVoiceMessageElement(msg) {
                const voiceBubble = document.createElement('div');
                voiceBubble.className = 'voice-message-bubble';
                voiceBubble.dataset.voiceText = msg.content; 

                const minWidth = 80;
                const maxWidth = 250;
                const width = Math.min(maxWidth, minWidth + (msg.duration || 1) * 8);
                voiceBubble.style.width = `${width}px`;

                const isUser = msg.role === 'user';
                const durationEl = `<span class="voice-duration">${msg.duration}"</span>`;

                const barCount = Math.floor(Math.min(30, 5 + (msg.duration || 1) * 0.8));
                const waveformEl = createWaveform(barCount).outerHTML;
                
                if(isUser) {
                    voiceBubble.innerHTML = `${durationEl}${waveformEl}`;
                } else {
                    voiceBubble.innerHTML = `${waveformEl}${durationEl}`;
                }
                
                return voiceBubble;
            }

            const handleFinancialMessageClick = (element, msg) => {
                if (msg.type === 'red-packet') {
                    if (msg.redPacket.status === 'pending' && msg.role !== 'user') {
                        openRedPacket(msg);
                    } else {
                        showRedPacketDetailsModal(msg);
                    }
                } else if (msg.type === 'transfer' && msg.transfer.received === false && msg.role !== 'user') {
                     receiveTransfer(msg);
                } else {
                     showToast('该消息没有可执行操作');
                }
            };
            
            async function createRedPacketElement(msg) {
                const rp = msg.redPacket;
                const bubbleContentEl = document.createElement('div');
                const contact = await db.contacts.get({contactId: currentChatContactId});
                
                let currentStatus = rp.status;
                const myUserId = contact.boundMaskId || 'user';
                const iHaveOpened = rp.openers.some(o => o.userId === myUserId);
                
                if (rp.status === 'pending' && iHaveOpened) {
                    currentStatus = 'opened';
                }

                bubbleContentEl.className = `red-packet-bubble ${currentStatus}`;

                let text;
                switch(currentStatus) {
                    case 'opened':
                        text = (msg.role === 'user') ? `你领取了${getDisplayName(contact)}的红包` : '红包已被领取';
                        if (contact.type === 'group' && iHaveOpened) text = `你领取了红包`;
                        break;
                    case 'refunded': text = '红包已过期，已退还'; break;
                    case 'empty': text = '红包已被领完'; break;
                    default: text = rp.text;
                }
                
                let exclusiveText = '';
                if (rp.type === 'exclusive' && rp.exclusiveTo) {
                   exclusiveText = ' (专属红包)';
                }


                bubbleContentEl.innerHTML = `
                    <div class="financial-content">
                        <div class="financial-text">
                            <p>${text}${exclusiveText}</p>
                        </div>
                    </div>
                    <div class="financial-footer">微信红包</div>`;
                return bubbleContentEl;
            };

            async function createTransferElement(msg) {
                const tr = msg.transfer;
                const bubbleContentEl = document.createElement('div');
                let stateText, remarkText, bubbleClass;
                
                bubbleClass = 'transfer-bubble';
                if (tr.received === true) {
                    stateText = msg.role === 'user' ? '转账已被接收' : '已收款';
                    bubbleClass += ' received';
                } else if (tr.received === 'refunded') {
                    stateText = msg.role === 'user' ? '转账已被退还' : '已退还';
                    bubbleClass += ' refunded';
                } else {
                    stateText = msg.role === 'user' ? '等待对方收款' : `转账给你`;
                }

                remarkText = tr.text ? `<span class="transfer-remark-inline">${tr.text}</span>` : '';
                
                bubbleContentEl.className = bubbleClass;
                bubbleContentEl.innerHTML = `
                    <div class="financial-content">
                        <div class="financial-text">
                            <div class="transfer-main-status">
                                <p>${stateText}</p>
                                ${remarkText}
                            </div>
                            <span class="transfer-amount">¥${tr.amount.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="financial-footer">微信转账</div>
                `;
                return bubbleContentEl;
            };
            
            async function openRedPacket(msg) {
                const rp = msg.redPacket;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const userProfile = await db.userProfile.get('main');
                const myUserId = contact.boundMaskId || 'user';

                if (rp.openers.some(o => o.userId === myUserId)) {
                    showToast('你已经领过这个红包了');
                    showRedPacketDetailsModal(msg);
                    return;
                }
                
                if (rp.type === 'exclusive' && rp.exclusiveTo !== myUserId) {
                    showToast('这是给别人的专属红包，你不能领取哦');
                    return;
                }

                let myOpening;
                if (rp.type === 'lucky') {
                    const remainingAmount = rp.totalAmount - rp.openers.reduce((sum, o) => sum + o.amount, 0);
                    const remainingCount = rp.count - rp.openers.length;
                    let amount;
                    if (remainingCount === 1) {
                        amount = remainingAmount;
                    } else {
                        const min = 0.01;
                        const max = (remainingAmount - (remainingCount - 1) * min);
                        amount = Math.floor((Math.random() * (max - min) + min) * 100) / 100;
                    }
                    myOpening = { userId: myUserId, amount: amount, timestamp: Date.now() };
                } else {
                    const amount = rp.totalAmount / rp.count;
                    myOpening = { userId: myUserId, amount: amount, timestamp: Date.now() };
                }
                
                rp.openers.push(myOpening);
                if (rp.openers.length === rp.count) {
                    rp.status = 'empty';
                } else {
                    rp.status = 'opened';
                }

                await updateFinancialMessage(msg);
                await addUserTransaction('red-packet-received', myOpening.amount, `收到来自 ${getDisplayName(contact)} 的红包`);
                showRedPacketDetailsModal(msg);
            }
            
            async function showRedPacketDetailsModal(msg) {
                const rp = msg.redPacket;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const myUserId = contact.boundMaskId || 'user';
                const senderId = msg.senderId;
                
                const senderData = await getUserData(senderId);

                const openersDataPromises = rp.openers.map(o => getUserData(o.userId));
                const openersData = await Promise.all(openersDataPromises);
                
                const myOpening = rp.openers.find(o => o.userId === myUserId);
                let luckiestOpener = null;
                if(rp.openers.length > 0 && rp.type === 'lucky') {
                    luckiestOpener = rp.openers.reduce((max, o) => o.amount > max.amount ? o : max);
                }
                
                let openerListHtml = openersData.map((opener, i) => {
                    const o = rp.openers[i];
                    let luckiestTag = '';
                    if (luckiestOpener && luckiestOpener.userId === o.userId) {
                        luckiestTag = '<span class="luckiest-tag">手气最佳</span>';
                    }
                    return `
                        <div class="rp-details-list-item">
                            <div class="avatar"></div>
                            <div class="rp-details-list-item-info">
                                <strong>${opener.name}</strong>
                                <span>${formatTimestamp(o.timestamp, 'message-datetime')}</span>
                            </div>
                            <div class="rp-details-list-item-amount">
                                <strong>¥${o.amount.toFixed(2)}</strong>
                                ${luckiestTag}
                            </div>
                        </div>
                    `;
                }).join('');

                let statusText;
                if (rp.status === 'refunded') {
                    statusText = '红包已过期，金额已退还';
                } else if (rp.status === 'empty') {
                    statusText = `${rp.count}个红包共¥${rp.totalAmount.toFixed(2)}，已被领完`;
                } else {
                    statusText = `已领取${rp.openers.length}/${rp.count}个，共¥${rp.openers.reduce((s,o)=>s+o.amount,0).toFixed(2)}/¥${rp.totalAmount.toFixed(2)}`;
                }
                
                const modalHtml = `
                    <div class="rp-details-header">
                        <div id="rp-sender-avatar" class="avatar"></div>
                        <p>${senderData.name}的红包</p>
                    </div>
                    <div class="rp-details-amount">
                        ${myOpening ? `<span>¥${myOpening.amount.toFixed(2)}</span>` : ''}
                        <p>${rp.text}</p>
                    </div>
                    ${openerListHtml ? `<div class="rp-details-list">${openerListHtml}</div>` : ''}
                    <div class="rp-details-status">${statusText}</div>
                `;

                const { action } = await showCustomModal({
                    title: " ",
                    isRPDetails: true,
                    rawHTML: modalHtml,
                    buttons: [{id: 'close', text: '关闭', class: 'confirm'}]
                });
                
                const openerItems = modalOverlay.querySelectorAll('.rp-details-list-item');
                openerItems.forEach((item, i) => {
                    const avatarEl = item.querySelector('.avatar');
                    renderAvatar(avatarEl, { name: openersData[i].name, url: openersData[i].avatar, id: rp.openers[i].userId });
                });
                const senderAvatarEl = modalOverlay.querySelector('#rp-sender-avatar');
                renderAvatar(senderAvatarEl, {name: senderData.name, url: senderData.avatar, id: senderId});
            }

            async function receiveTransfer(msg) {
                const tr = msg.transfer;
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const { action } = await showCustomModal({
                    title: '确认收款',
                    message: `确定要接收来自 ${getDisplayName(contact)} 的转账 ¥${tr.amount.toFixed(2)} 吗？`,
                    buttons: [
                        {id: 'decline', text: '立即退还'},
                        {id: 'confirm', text: '确认收款', class: 'confirm'}
                    ],
                    buttonLayout: 'row'
                });

                if (action === 'confirm') {
                    tr.received = true;
                    await updateFinancialMessage(msg);
                    await addUserTransaction('transfer-received', tr.amount, `收到来自 ${getDisplayName(contact)} 的转账`);
                    showToast(`已收款 ¥${tr.amount.toFixed(2)}`);
                    await addMessageToUI({
                        content: `你已收款`,
                        senderId: 'system'
                    }, true);
                } else if (action === 'decline') {
                    tr.received = 'refunded';
                    await updateFinancialMessage(msg);
                    await addAITransaction('transfer-refunded', tr.amount, contact.contactId);
                    showToast('转账已退还');
                    await addMessageToUI({
                        content: `你退还了${getDisplayName(contact)}的转账`,
                        senderId: 'system'
                    }, true);
                }
            }
            
            async function updateFinancialMessage(msg) {
                const history = await loadChatHistory(currentChatContactId);
                const msgIndex = history.findIndex(m => m.messageId === msg.messageId);
                if (msgIndex !== -1) {
                    history[msgIndex] = msg;
                    await saveChatHistory(currentChatContactId, history);
                    await renderChatMessages(currentChatContactId);
                }
            }
            
            async function getUserWalletBalance() {
                const userProfile = await db.userProfile.get('main');
                return userProfile ? (userProfile.balance || 0) : 0;
            }

            async function addUserTransaction(type, amount, description) {
                const timestamp = Date.now();
                const userProfile = await db.userProfile.get('main');
                const newBalance = (userProfile.balance || 0) + amount;
                await db.userProfile.update('main', { balance: newBalance });
                await db.transactions.add({
                    timestamp: timestamp,
                    type: type,
                    amount: amount,
                    description: description,
                    balanceAfter: newBalance,
                    owner: 'user'
                });
                await renderWalletPage();
                await renderWalletDetails();
            }
            
            async function addAITransaction(type, amount, contactId) {
                const contact = await db.contacts.get({contactId: contactId});
                if (!contact) return;
                const newBalance = (contact.walletBalance || 0) + amount;
                await db.contacts.update(contact.id, { walletBalance: newBalance });
            }
            
            async function renderWalletPage() {
                const balance = await getUserWalletBalance();
                walletBalanceAmount.textContent = `¥${balance.toFixed(2)}`;
            }

            async function renderWalletDetails() {
                const transactions = await db.transactions.where({owner: 'user'}).reverse().sortBy('timestamp');
                if (transactions.length === 0) {
                    walletDetailsList.innerHTML = '<div style="text-align: center; color: #888; padding-top: 50px;">暂无零钱明细</div>';
                    return;
                }

                const grouped = transactions.reduce((acc, tx) => {
                    const month = new Date(tx.timestamp).toLocaleString('default', { year: 'numeric', month: 'long' });
                    (acc[month] = acc[month] || []).push(tx);
                    return acc;
                }, {});

                let html = '';
                for (const month in grouped) {
                    html += `<div class="transaction-group"><div class="transaction-group-header">${month}</div>`;
                    grouped[month].forEach(tx => {
                        const amountClass = tx.amount >= 0 ? 'income' : 'expense';
                        const amountSign = tx.amount >= 0 ? '+' : '';
                        html += `
                            <div class="transaction-item">
                                <div class="transaction-details">
                                    <p>${tx.description}</p>
                                    <span>${formatTimestamp(tx.timestamp, 'message-datetime')}</span>
                                </div>
                                <div class="transaction-amount">
                                    <strong class="${amountClass}">${amountSign}${tx.amount.toFixed(2)}</strong>
                                    <span>余额: ${tx.balanceAfter.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                walletDetailsList.innerHTML = html;
            }

            async function checkExpiredFinancials() {
                const now = Date.now();
                const twentyFourHours = 24 * 60 * 60 * 1000;

                const allChatHistories = await db.chatHistories.toArray();

                for (const historyDoc of allChatHistories) {
                    let historyModified = false;
                    for (const msg of historyDoc.messages) {
                        if (msg.role === 'assistant' && msg.type === 'red-packet' && msg.redPacket.status === 'pending' && (now - msg.timestamp > twentyFourHours)) {
                             msg.redPacket.status = 'refunded';
                             await addAITransaction('red-packet-refunded', msg.redPacket.totalAmount, historyDoc.contactId);
                             historyModified = true;
                        }
                        if (msg.role === 'user' && msg.type === 'transfer' && msg.transfer.received === false && (now - msg.timestamp > twentyFourHours)) {
                            msg.transfer.received = 'refunded';
                            const contact = await db.contacts.get({contactId: historyDoc.contactId});
                            await addUserTransaction('transfer-refunded', msg.transfer.amount, `退款-来自${getDisplayName(contact)}`);
                            historyModified = true;
                         }
                    }
                    if (historyModified) await saveChatHistory(historyDoc.contactId, historyDoc.messages);
                }
            }


            // Event Listeners
            modalOverlay.addEventListener('keyup', (e) => {
                if (e.target.matches('.financial-modal-body .amount-input')) {
                    const amount = parseFloat(e.target.value) || 0;
                    const finalAmountEl = modalOverlay.querySelector('.modal-final-amount');
                    if (finalAmountEl) {
                        finalAmountEl.textContent = `¥${amount.toFixed(2)}`;
                    }
                }
            });
            modalOverlay.addEventListener('input', (e) => {
                if (e.target.matches('.financial-modal-body .amount-input')) {
                    const amount = parseFloat(e.target.value) || 0;
                    const finalAmountEl = modalOverlay.querySelector('.modal-final-amount');
                    if (finalAmountEl) {
                        finalAmountEl.textContent = `¥${amount.toFixed(2)}`;
                    }
                }
            });
            
            aiStatusModal.addEventListener('click', (e) => {
                if(e.target === aiStatusModal) {
                    aiStatusModal.classList.remove('visible');
                }
            });
            chatHeaderTitle.addEventListener('click', () => {
                if (body.classList.contains('chat-view-active')) {
                    aiStatusModal.classList.add('visible');
                }
            });

            changeChatAvatarsBtn.addEventListener('click', async () => {
                if (!currentChatContactId) return;
                
                const contact = await db.contacts.get({contactId: currentChatContactId});
                const chatSpecificAvatars = contact.chatSpecificAvatars || {};
                
                let myAvatarPreview = chatSpecificAvatars.user || '';
                const mask = contact.boundMaskId ? await db.masks.get({maskId: contact.boundMaskId}) : null;
                const profile = await db.userProfile.get('main');
                const myDefaultName = mask ? mask.name : (profile.name || '我');

                let theirAvatarPreview = chatSpecificAvatars.assistant || contact.avatar || '';
                const theirDefaultName = getDisplayName(contact);

                const modalHtml = `
                    <div style="display: flex; justify-content: space-around; padding: 20px;">
                        <div class="avatar-uploader" data-target="user">
                            <div class="avatar-preview" style="width: 80px; height: 80px; border-radius: 8px; background-image: url(${myAvatarPreview}); background-size: cover; background-color: #e0e0e0; margin-bottom: 10px;"></div>
                            <span style="font-size: 14px; color: #888;">${myDefaultName}</span>
                            <span class="change-avatar-text" style="color: var(--ios-blue); margin-top: 5px;">换我的头像</span>
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                        <div class="avatar-uploader" data-target="assistant">
                            <div class="avatar-preview" style="width: 80px; height: 80px; border-radius: 8px; background-image: url(${theirAvatarPreview}); background-size: cover; background-color: #e0e0e0; margin-bottom: 10px;"></div>
                            <span style="font-size: 14px; color: #888;">${theirDefaultName}</span>
                            <span class="change-avatar-text" style="color: var(--ios-blue); margin-top: 5px;">换TA的头像</span>
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <button id="modal-reset-avatars" class="save-btn reset-btn" style="margin: 20px 0 0;">恢复默认头像</button>
                `;

                const { action } = await showCustomModal({
                    title: '更换聊天头像',
                    rawHTML: modalHtml,
                    buttons: [{id: 'close', text: '完成', class: 'confirm'}]
                });
            });

            modalOverlay.addEventListener('click', e => {
                const uploader = e.target.closest('.avatar-uploader');
                if (uploader) {
                    uploader.querySelector('input[type="file"]').click();
                }

                if (e.target.id === 'modal-reset-avatars') {
                    e.target.disabled = true;
                    db.contacts.where({contactId: currentChatContactId}).modify({ chatSpecificAvatars: {} }).then(() => {
                        showToast('已恢复默认头像');
                        const userPreview = modalOverlay.querySelector('.avatar-uploader[data-target="user"] .avatar-preview');
                        const assistantPreview = modalOverlay.querySelector('.avatar-uploader[data-target="assistant"] .avatar-preview');
                        
                        (async () => {
                            const contact = await db.contacts.get({contactId: currentChatContactId});
                            let myAvatarPreview = '';
                            const mask = contact.boundMaskId ? await db.masks.get({maskId: contact.boundMaskId}) : null;
                            if (mask && mask.avatar) {
                                myAvatarPreview = mask.avatar;
                            } else {
                                const profile = await db.userProfile.get('main');
                                myAvatarPreview = profile.avatar || '';
                            }
                            
                            let theirAvatarPreview = contact.avatar || '';

                            if(userPreview) userPreview.style.backgroundImage = `url(${myAvatarPreview})`;
                            if(assistantPreview) assistantPreview.style.backgroundImage = `url(${theirAvatarPreview})`;

                            e.target.disabled = false;
                        })();
                    });
                }
            });
            
            modalOverlay.addEventListener('change', e => {
                const input = e.target;
                if (input.type === 'file' && input.closest('.avatar-uploader')) {
                    const file = input.files[0];
                    if (!file) return;

                    const uploader = input.closest('.avatar-uploader');
                    const target = uploader.dataset.target;
                    const previewEl = uploader.querySelector('.avatar-preview');

                    imageCompression(file, { maxSizeMB: 0.2, maxWidthOrHeight: 400 })
                        .then(compressedFile => {
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const dataUrl = event.target.result;
                                previewEl.style.backgroundImage = `url(${dataUrl})`;

                                const contact = await db.contacts.get({contactId: currentChatContactId});
                                const avatars = contact.chatSpecificAvatars || {};
                                avatars[target] = dataUrl;
                                
                                await db.contacts.where({contactId: currentChatContactId}).modify({ chatSpecificAvatars: avatars });
                                showToast(`${target === 'user' ? '我' : 'TA'}的头像已更换`);
                            };
                            reader.readAsDataURL(compressedFile);
                        })
                        .catch(err => {
                            showToast('图片处理失败', 'warning');
                            console.error(err);
                        })
                        .finally(() => {
                            input.value = '';
                        });
                }
            });


            meWalletBtn.addEventListener('click', () => {
                renderWalletPage();
                navigateTo('wallet-active');
            });
            backToMeFromWalletBtn.addEventListener('click', () => navigateTo('me'));
            
            walletDetailsBtn.addEventListener('click', () => {
                renderWalletDetails();
                navigateTo('wallet-details-active');
            });
            backToWalletBtn.addEventListener('click', () => navigateTo('wallet-active'));

            walletTopupBtn.addEventListener('click', async () => {
                 const { action, values } = await showCustomModal({
                    title: '充值',
                    rawHTML: `<div class="settings-group" style="margin: 0;"><div class="form-group"><input type="number" name="amount" placeholder="输入充值金额" step="0.01" min="0.01"></div></div>`,
                    buttons: [{id: 'cancel', text: '取消'}, {id: 'confirm', text: '充值', class: 'confirm'}],
                    buttonLayout: 'row'
                });
                if(action === 'confirm' && values.amount > 0) {
                    await addUserTransaction('top-up', values.amount, '零钱充值');
                    showToast(`成功充值 ¥${values.amount.toFixed(2)}`);
                } else if (action === 'confirm') {
                    showToast('请输入有效的金额', 'warning');
                }
            });
            walletWithdrawBtn.addEventListener('click', async () => {
                const currentBalance = await getUserWalletBalance();
                 const { action, values } = await showCustomModal({
                    title: '提现',
                    rawHTML: `<div class="settings-group" style="margin: 0;"><div class="form-group"><input type="number" name="amount" placeholder="输入提现金额，最高¥${currentBalance.toFixed(2)}" step="0.01" max="${currentBalance}"></div></div>`,
                    buttons: [
                        {id: 'cancel', text: '取消'}, 
                        {id: 'withdraw-all', text: '全部提现', class: 'confirm'}, 
                        {id: 'withdraw', text: '提现', class: 'confirm'}
                    ],
                    buttonLayout: 'column'
                });
                if(action === 'withdraw-all') { 
                    if(currentBalance > 0) {
                        await addUserTransaction('withdraw', -currentBalance, '零钱提现');
                        showToast(`成功提现 ¥${currentBalance.toFixed(2)}`);
                    } else {
                        showToast('余额为零', 'warning');
                    }
                } else if(action === 'withdraw' && values.amount > 0) {
                    if (values.amount > currentBalance) {
                        showToast('提现金额不能超过余额', 'warning');
                        return;
                    }
                    await addUserTransaction('withdraw', -values.amount, '零钱提现');
                    showToast(`成功提现 ¥${values.amount.toFixed(2)}`);
                } else if (action === 'withdraw') {
                    showToast('请输入有效的金额', 'warning');
                }
            });

            const init = async () => {
                const showFrame = localStorage.getItem('showPhoneFrame') === 'true';
                if (showFrame) {
                    document.body.classList.add('frame-enabled');
                }
                togglePhoneFrame.checked = showFrame;

                await db.open();
                
                const userProfile = await db.userProfile.get('main');
                if (!userProfile) {
                    await db.userProfile.put({ key: 'main', name: '我', balance: 0, avatar: null });
                }
                
                await loadAllContacts();
                await checkExpiredFinancials();
                await loadApiSettings();
                await loadUserData();
                await renderContactsList();
                await renderMainChatList();
                
                const savedWallpaper = await db.widgetData.get('wallpaperImage');
                if (savedWallpaper) homeScreen.style.backgroundImage = `url(${savedWallpaper.value})`;
                
                await loadCustomIcons(); 

                setupImageUpload(photoWidget, photoWidgetInput, 'photoWidgetImage');
                setupImageUpload(circularUpload1, circularUploadInput1, 'circularWidgetImage1');
                setupImageUpload(circularUpload2, circularUploadInput2, 'circularWidgetImage2');
                setupImageUpload(widgetCircularUpload, widgetCircularUploadInput, 'customWidgetCircularImage');
                
                await loadImageFromStorage(photoWidget, 'photoWidgetImage');
                await loadImageFromStorage(circularUpload1, 'circularWidgetImage1');
                await loadImageFromStorage(circularUpload2, 'circularWidgetImage2');
                await loadImageFromStorage(widgetCircularUpload, 'customWidgetCircularImage');
                
                const savedBg = await db.widgetData.get('customWidgetBackgroundImage');
                if (savedBg) { customImageTextWidget.style.backgroundImage = `url(${savedBg.value})`; }
                
                const textTop = await db.widgetData.get('customWidgetTextTop');
                widgetTextTop.value = textTop ? textTop.value : '';
                const textBottom = await db.widgetData.get('customWidgetTextBottom');
                widgetTextBottom.value = textBottom ? textBottom.value : '';

                updateDate();
                updateTime();
                updateBattery();
                setInterval(updateTime, 1000 * 60);
                setInterval(updateBattery, 1000 * 30);
                if (navigator.getBattery) {
                    navigator.getBattery().then(battery => {
                        battery.addEventListener('levelchange', updateBattery);
                        battery.addEventListener('chargingchange', updateBattery);
                    });
                }
                messageInput.dispatchEvent(new Event('input')); 
            };

            init();
        });
    </script>
</body>
</html>
